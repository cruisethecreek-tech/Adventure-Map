<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="permissions-policy" content="geolocation=(self)">
    <title>Cruise the Creek | Mill Creek Park eBike Tours</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDfXXXXXXXXXXXXXXXXXXXXXXXX&callback=initMap&libraries=marker,places,geometry&v=weekly" defer></script>
    <style>
        :root {
            --sage-green: #6B8E6F;
            --dark-sage: #4A6B4D;
            --tan-beige: #D4C5B0;
            --cream: #F5EFE6;
            --accent-orange: #D68438;
            --text-dark: #2C3A2E;
            --white: #ffffff;
            --shadow: 0 8px 24px rgba(107, 142, 111, 0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Open Sans', sans-serif;
            background: linear-gradient(to bottom, var(--cream) 0%, #E8DCC8 100%);
            color: var(--text-dark);
            overflow-x: hidden;
        }

        h1, h2, h3 { font-family: 'Montserrat', sans-serif; }

        header {
            background: linear-gradient(rgba(75, 107, 77, 0.85), rgba(75, 107, 77, 0.85)), 
                        url('https://images.unsplash.com/photo-1559827260-dc66d52bef19?ixlib=rb-4.0.3&auto=format&fit=crop&w=2070&q=80');
            background-size: cover;
            background-position: center;
            color: var(--cream);
            padding: 80px 20px 60px;
            text-align: center;
            border-bottom: 5px solid var(--accent-orange);
        }

        h1 {
            font-size: clamp(2.5rem, 6vw, 4.5rem);
            font-weight: 800;
            margin-bottom: 15px;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
        }

        .tagline {
            font-size: clamp(1rem, 2.5vw, 1.4rem);
            font-weight: 600;
            color: var(--tan-beige);
            letter-spacing: 3px;
            text-transform: uppercase;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .info-banner {
            background: linear-gradient(135deg, var(--sage-green), var(--dark-sage));
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 40px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .info-banner h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .stats-banner {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .stat-number {
            font-size: 3rem;
            font-weight: 800;
            color: var(--sage-green);
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 5px;
        }

        /* SEARCH BAR STYLES */
        .search-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            border: 3px solid var(--sage-green);
        }

        .search-wrapper {
            position: relative;
            max-width: 600px;
            margin: 0 auto;
        }

        #searchInput {
            width: 100%;
            padding: 16px 50px 16px 20px;
            font-size: 1.1rem;
            border: 2px solid var(--tan-beige);
            border-radius: 30px;
            outline: none;
            transition: all 0.3s ease;
            font-family: 'Open Sans', sans-serif;
        }

        #searchInput:focus {
            border-color: var(--sage-green);
            box-shadow: 0 0 0 3px rgba(107, 142, 111, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.3rem;
            color: var(--sage-green);
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 12px;
            margin-top: 10px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .search-results.active {
            display: block;
        }

        .search-result-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .search-result-item:hover {
            background: var(--cream);
            padding-left: 25px;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-icon {
            font-size: 1.5rem;
            min-width: 30px;
        }

        .search-result-text {
            flex: 1;
        }

        .search-result-name {
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 3px;
        }

        .search-result-category {
            font-size: 0.8rem;
            color: #888;
            text-transform: uppercase;
        }

        .no-results {
            padding: 20px;
            text-align: center;
            color: #888;
            font-style: italic;
        }

        .clear-search {
            position: absolute;
            right: 55px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 1.2rem;
            color: #999;
            cursor: pointer;
            padding: 5px;
            display: none;
        }

        .clear-search.active {
            display: block;
        }

        .clear-search:hover {
            color: var(--sage-green);
        }

        /* AUDIO TOUR BUTTON */
        .audio-btn {
            background: var(--accent-orange);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(230, 126, 34, 0.4);
            animation: pulse 2s infinite;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .audio-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(230, 126, 34, 0.5);
        }

        .audio-btn.active {
            background: var(--sage-green);
            animation: none;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* AUDIO POPUP ALERT */
        .audio-popup {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(150px);
            background: linear-gradient(135deg, var(--sage-green), var(--dark-sage));
            color: white;
            padding: 20px 30px;
            border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 3000;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-width: 90%;
        }

        .audio-popup.show {
            transform: translateX(-50%) translateY(0);
        }

        .playing-icon {
            width: 24px;
            height: 24px;
            background: var(--accent-orange);
            border-radius: 50%;
            animation: blink 1s infinite;
            flex-shrink: 0;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .popup-content {
            flex: 1;
        }

        #popupTitle {
            font-size: 1.1rem;
            display: block;
            margin-bottom: 3px;
        }

        .popup-subtitle {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .category-filters {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 30px;
        }

        .category-btn {
            padding: 12px 24px;
            border: 2px solid var(--sage-green);
            background: white;
            color: var(--sage-green);
            border-radius: 25px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s ease;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 1px;
        }

        .category-btn:hover, .category-btn.active {
            background: var(--sage-green);
            color: white;
        }

        .map-wrapper {
            background: white;
            border-radius: 20px;
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 40px;
        }

        .map-header {
            padding: 25px;
            background: linear-gradient(135deg, var(--sage-green), var(--dark-sage));
            color: white;
        }

        .map-header h2 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .map-header-controls {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .map-controls {
            padding: 15px 20px;
            background: var(--cream);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            border-bottom: 2px solid var(--tan-beige);
        }

        .filter-btn {
            padding: 10px 20px;
            border: 2px solid var(--sage-green);
            background: white;
            color: var(--sage-green);
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .filter-btn:hover, .filter-btn.active {
            background: var(--sage-green);
            color: white;
        }

        #map {
            width: 100%;
            height: 700px;
        }

        .locations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .location-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-left: 4px solid var(--sage-green);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .location-card:hover {
            transform: translateX(5px);
            box-shadow: 0 6px 20px rgba(107, 142, 111, 0.2);
        }

        .location-card.waterfall { border-left-color: #4A9EDB; }
        .location-card.recreation { border-left-color: var(--accent-orange); }
        .location-card.historic { border-left-color: #8B7355; }
        .location-card.nature { border-left-color: var(--sage-green); }
        .location-card.dining { border-left-color: #C44536; }
        .location-card.amenity { border-left-color: #B89968; }
        .location-card.trail { border-left-color: #27ae60; }
        .location-card.playground { border-left-color: #e91e63; }

        .location-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            display: block;
        }

        .location-name {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 5px;
            color: var(--text-dark);
        }

        .location-category {
            font-size: 0.8rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        footer {
            text-align: center;
            padding: 50px 20px;
            background: var(--sage-green);
            color: var(--cream);
            margin-top: 60px;
        }

        footer h3 {
            font-size: 1.8rem;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            h1 { font-size: 2.5rem; }
            #map { height: 500px; }
            .category-filters, .map-controls { 
                flex-direction: column; 
            }
            .locations-grid {
                grid-template-columns: 1fr;
            }
            #searchInput {
                font-size: 1rem;
                padding: 14px 45px 14px 16px;
            }
            .audio-popup {
                bottom: 20px;
                padding: 15px 20px;
                max-width: 85%;
            }
            #popupTitle {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>

    <header>
        <div class="container">
            <h1>Cruise the Creek</h1>
            <div class="tagline">Mill Creek MetroParks ‚Ä¢ eBike Adventures</div>
        </div>
    </header>

    <div class="container">
        
        <!-- IFRAME DETECTION BANNER -->
        <div id="iframeWarning" style="display: none; background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 20px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 8px 24px rgba(52, 152, 219, 0.3); text-align: center;">
            <h3 style="font-size: 1.3rem; margin-bottom: 10px;">üì± For GPS Audio Tours</h3>
            <p style="font-size: 1rem; line-height: 1.6;">
                You're viewing this in an embedded page. To use GPS audio tours, please open this page in a new tab.
            </p>
            <a id="openNewTabBtn" href="#" target="_blank" style="display: inline-block; margin-top: 15px; background: white; color: #2980b9; padding: 12px 30px; border-radius: 25px; text-decoration: none; font-weight: 700; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
                üîó Open in New Tab
            </a>
        </div>
        
        <div class="info-banner">
            <h3>üö¥ Scenic eBike Adventure Through Mill Creek Park</h3>
            <p>63 locations including 19 official trails ‚Ä¢ 45 miles of scenic trails ‚Ä¢ Take the slow route and enjoy nature</p>
            <p style="margin-top: 10px; font-size: 0.95rem; opacity: 0.95;">
                üå≥ <strong>Experience First, Speed Second:</strong> Follow park trails for the most scenic routes. Stay within park boundaries!
            </p>
            <p style="margin-top: 10px; font-size: 0.95rem; background: rgba(52, 152, 219, 0.15); padding: 10px; border-radius: 8px; border: 2px solid #3498db;">
                üìç <strong>Smart Geofencing Enabled:</strong> Audio alerts will warn you if you approach or leave park boundaries!
            </p>
            <p style="margin-top: 10px; font-size: 1rem; background: rgba(231, 76, 60, 0.15); padding: 10px; border-radius: 8px; border: 2px solid #e74c3c;">
                üö´ <strong style="color: #c0392b;">NEVER USE BEARS DEN ROAD</strong> - It's a city street with traffic. Use park trails only!
            </p>
        </div>

        <div class="stats-banner">
            <div class="stat-card">
                <span class="stat-number" id="totalLocations">63</span>
                <span class="stat-label">Exact Locations</span>
            </div>
            <div class="stat-card">
                <span class="stat-number">2,658</span>
                <span class="stat-label">Acres to Explore</span>
            </div>
            <div class="stat-card">
                <span class="stat-number">45</span>
                <span class="stat-label">Miles of Trails</span>
            </div>
        </div>

        <!-- SEARCH BAR -->
        <div class="search-container">
            <h2 style="text-align: center; font-size: 1.8rem; margin-bottom: 15px; color: var(--text-dark);">
                üîç Search Locations
            </h2>
            <div class="search-wrapper">
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="Search for waterfalls, pavilions, trails, dining..."
                    autocomplete="off"
                />
                <button class="clear-search" id="clearSearch" onclick="clearSearch()">‚úï</button>
                <span class="search-icon">üîç</span>
                <div class="search-results" id="searchResults"></div>
            </div>
        </div>

        <h2 style="text-align: center; font-size: 2rem; margin-bottom: 20px; color: var(--text-dark);">Filter by Category</h2>
        
        <!-- Scenic Route Guide -->
        <div style="background: linear-gradient(135deg, #E8F5E9, #C8E6C9); border-radius: 12px; padding: 25px; margin-bottom: 30px; border: 3px solid var(--sage-green); box-shadow: var(--shadow);">
            <h3 style="color: var(--dark-sage); font-size: 1.5rem; margin-bottom: 15px; text-align: center;">
                üå≥ Scenic Trail Navigation Guide
            </h3>
            
            <!-- Bears Den Road Warning -->
            <div style="background: #ffebee; border: 3px solid #e74c3c; border-radius: 10px; padding: 20px; margin-bottom: 20px; text-align: center;">
                <h4 style="color: #c0392b; font-size: 1.3rem; margin-bottom: 10px;">
                    üö´ AVOID BEARS DEN ROAD üö´
                </h4>
                <p style="color: #721c24; font-size: 1.05rem; font-weight: 600; line-height: 1.6;">
                    Bears Den Road is a CITY STREET with traffic.<br>
                    <strong style="font-size: 1.1rem;">DO NOT use this road for biking.</strong><br>
                    Use park trails and internal park drives only.
                </p>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                <div style="background: white; padding: 15px; border-radius: 8px;">
                    <h4 style="color: var(--sage-green); margin-bottom: 10px; font-size: 1.1rem;">‚úÖ Do Use:</h4>
                    <ul style="line-height: 1.8; color: #555; margin-left: 20px;">
                        <li><strong>45 miles of park trails</strong></li>
                        <li><strong>Internal park drives</strong></li>
                        <li>Paved bike paths between locations</li>
                        <li>Marked hiking/biking trail routes</li>
                        <li>Scenic drives within green area</li>
                    </ul>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px;">
                    <h4 style="color: #C44536; margin-bottom: 10px; font-size: 1.1rem;">‚õî Never Use:</h4>
                    <ul style="line-height: 1.8; color: #555; margin-left: 20px;">
                        <li><strong style="color: #e74c3c;">Bears Den Road (CITY STREET!)</strong></li>
                        <li>Any roads outside park boundary</li>
                        <li>Canfield Rd, Shields Rd</li>
                        <li>Routes leaving green areas</li>
                        <li>Shortcuts through neighborhoods</li>
                    </ul>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px;">
                    <h4 style="color: var(--accent-orange); margin-bottom: 10px; font-size: 1.1rem;">üó∫Ô∏è Navigation Tips:</h4>
                    <ul style="line-height: 1.8; color: #555; margin-left: 20px;">
                        <li>Follow the orange boundary line</li>
                        <li>If route shows Bears Den Rd, find alternate</li>
                        <li>Use East/West trail systems</li>
                        <li>Stay on paths within green zone</li>
                        <li>Ask park staff if unsure!</li>
                    </ul>
                </div>
            </div>
            <div style="background: #FFF3CD; padding: 15px; border-radius: 8px; margin-top: 20px; text-align: center; border: 2px solid #FFD700;">
                <strong style="font-size: 1.1rem; color: #856404;">üìç Pro Tip:</strong>
                <span style="color: #856404; display: block; margin-top: 5px;">
                    Click "Show Safe Riding Zone" to see the orange boundary. If Google Maps suggests Bears Den Road, IGNORE IT and use park trails instead!
                </span>
            </div>
        </div>
        
        <div class="category-filters">
            <button class="category-btn active" onclick="filterByCategory('all')">üó∫Ô∏è All Locations</button>
            <button class="category-btn" onclick="filterByCategory('playground')">üõù Playgrounds</button>
            <button class="category-btn" onclick="filterByCategory('trail')">ü•æ Trails</button>
            <button class="category-btn" onclick="filterByCategory('waterfall')">üíß Waterfalls</button>
            <button class="category-btn" onclick="filterByCategory('recreation')">üèÉ Recreation</button>
            <button class="category-btn" onclick="filterByCategory('historic')">üèõÔ∏è Historic Sites</button>
            <button class="category-btn" onclick="filterByCategory('nature')">üå≥ Nature Spots</button>
            <button class="category-btn" onclick="filterByCategory('dining')">üç¥ Dining</button>
            <button class="category-btn" onclick="filterByCategory('amenity')">üè† Amenities</button>
        </div>

        <div class="map-wrapper">
            <div class="map-header">
                <h2>üó∫Ô∏è Scenic Trail Map - Stay Within Park Boundaries</h2>
                <p>Use walking/trail mode for scenic routes ‚Ä¢ Toggle boundary to see safe riding zone ‚Ä¢ Never exit the park</p>
                <div class="map-header-controls">
                    <button class="audio-btn" id="startAudioBtn" onclick="toggleAudioTour()">
                        üéß Start Audio Tour
                    </button>
                    <span style="font-size: 0.9rem; opacity: 0.9;">
                        Enable GPS tracking for automatic audio guides as you ride
                    </span>
                </div>
            </div>
            <div class="map-controls">
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; width: 100%;">
                    <button class="filter-btn" id="boundaryBtn" onclick="toggleParkBoundary()" style="background: var(--accent-orange); color: white; border-color: var(--accent-orange); font-size: 1rem; padding: 12px 24px;">
                        üó∫Ô∏è SHOW SAFE RIDING ZONE
                    </button>
                    
                    <div style="flex: 1; min-width: 200px; text-align: center; padding: 0 15px;">
                        <span style="font-size: 0.9rem; color: var(--text-dark); font-weight: 600; display: block;">
                            Choose Your Route Style:
                        </span>
                        <div style="display: flex; gap: 8px; margin-top: 8px; justify-content: center;">
                            <button class="filter-btn active" id="trailModeBtn" onclick="setRouteMode('trail')" 
                                    style="background: #6B8E6F; color: white; border-color: #6B8E6F; font-size: 0.85rem; padding: 8px 16px;">
                                üö∂ Scenic Trails (Recommended)
                            </button>
                            <button class="filter-btn" id="bikeModeBtn" onclick="setRouteMode('bike')" 
                                    style="background: white; color: #D68438; border-color: #D68438; font-size: 0.85rem; padding: 8px 16px;">
                                üö¥ Bike Routes (Faster)
                            </button>
                        </div>
                    </div>
                </div>
                <div style="width: 100%; margin-top: 10px; padding: 10px; background: white; border-radius: 8px; font-size: 0.85rem; text-align: center; color: #555;">
                    <strong>Current Mode:</strong> <span id="currentModeText" style="color: #6B8E6F; font-weight: 700;">Scenic Trail Mode</span> - 
                    <span id="modeDescription">Most scenic routes through the park</span>
                </div>
            </div>
            <div id="map"></div>
        </div>

        <h2 style="text-align: center; font-size: 2rem; margin: 40px 0 20px; color: var(--text-dark);">Browse All Locations</h2>
        
        <div class="locations-grid" id="locationsGrid">
            <!-- Populated by JavaScript -->
        </div>

    </div>

    <!-- AUDIO TOUR POPUP -->
    <div class="audio-popup" id="audioPopup">
        <div class="playing-icon"></div>
        <div class="popup-content">
            <strong id="popupTitle">Approaching Location...</strong>
            <div class="popup-subtitle">üîä Audio Guide Playing</div>
        </div>
    </div>

    <footer>
        <h3>Cruise the Creek</h3>
        <p>Youngstown's Premier eBike Rental & Tours</p>
        <p style="margin-top: 15px; font-size: 0.85rem;">üìç Mill Creek MetroParks, Youngstown, Ohio</p>
    </footer>

    <script>
        // DETECT IF IN IFRAME AND SHOW WARNING
        if (window.self !== window.top) {
            const warning = document.getElementById('iframeWarning');
            if (warning) {
                warning.style.display = 'block';
                const openBtn = document.getElementById('openNewTabBtn');
                if (openBtn) {
                    openBtn.href = window.location.href;
                }
            }
        }
        
        let map;
        let markers = [];
        let infoWindow;
        let parkBoundary = null;
        let boundaryVisible = false;
        let currentRouteMode = 'trail';

        // AUDIO TOUR VARIABLES
        let watchId = null;
        let audioEnabled = false;
        let gpsInitialized = false;
        let spokenLocations = new Set();
        let userMarker = null;
        let lastBoundaryWarning = 0;
        let isInsidePark = true;
        let hasLeftPark = false;

        const locations = [
            { name: "Cruise The Creek", category: "amenity", icon: "üö≤", lat: 41.0720801, lng: -80.6918451, desc: "Welcome to Cruise The Creek, your starting point for an amazing eBike adventure through Mill Creek Park!" },
            { name: "Mill Creek Metro Park", category: "nature", icon: "üå≥", lat: 41.0862413, lng: -80.6926274, desc: "You're entering Mill Creek Metro Park, a beautiful 2,658-acre urban oasis. Ohio's first park district, established in 1891." },
            
            // PLAYGROUNDS - Family Fun Areas
            { name: "Wick Pavilion & Wet Playground", category: "playground", icon: "üõù", lat: 41.0867, lng: -80.6930, desc: "Wick Recreation Area features a wet playground! Perfect for kids to cool off and play during summer months. Pavilion available for family gatherings." },
            { name: "Scholl Pavilion & Spray Basin", category: "playground", icon: "üõù", lat: 41.0724666, lng: -80.6916099, desc: "Scholl Recreation Area has a spray basin for summer fun! Great spot for picnics with playground facilities for the kids." },
            { name: "Stitt Pavilion Playground", category: "playground", icon: "üõù", lat: 41.0424868, lng: -80.6880063, desc: "Stitt Pavilion on the south side offers playground facilities and pavilion space, perfect for family outings!" },
            { name: "Chestnut Hill Pavilion Playground", category: "playground", icon: "üõù", lat: 41.0706959, lng: -80.6904977, desc: "Chestnut Hill Pavilion features hilltop playground with beautiful views. Great for kids to play while you enjoy the scenery!" },
            { name: "Slippery Rock Pavilion Playground", category: "playground", icon: "üõù", lat: 41.0868053, lng: -80.6748662, desc: "Slippery Rock Pavilion on the east side has playground equipment and picnic facilities. Perfect family destination!" },
            { name: "Volney Rogers Field Playground", category: "playground", icon: "üõù", lat: 41.0961547, lng: -80.6732859, desc: "Volney Rogers Field features playground equipment and sports facilities. Great for active kids and family activities!" },
            { name: "Lower Bears Den Playground & Picnic Area", category: "playground", icon: "üõù", lat: 41.0837265, lng: -80.6879262, desc: "Lower Bears Den has playground equipment in a beautiful wooded setting. Perfect spot for kids to play and families to picnic!" },
            { name: "Yellow Creek Park", category: "playground", icon: "üõù", lat: 41.0380, lng: -80.6440, desc: "Yellow Creek Park offers playground facilities and family recreation areas. Great destination for a full day of family fun!" },
            
            // TRAILS
            { name: "Old Tree Trail", category: "trail", icon: "ü•æ", lat: 41.0975, lng: -80.6770, desc: "0.8 mile moderately difficult trail with panoramic views of Lake Glacier. Features steep steps at north trailhead." },
            { name: "East Glacier Trail", category: "trail", icon: "ü•æ", lat: 41.0965, lng: -80.6755, desc: "0.8 mile moderate trail with hills. Great for wildlife viewing and features the historic Parapet Bridge." },
            { name: "One Way Drive Trail", category: "trail", icon: "ü•æ", lat: 41.0945, lng: -80.6765, desc: "0.7 mile moderate trail offering panoramic views of Lily Pond and Lake Glacier." },
            { name: "Lily Pond Circle Trail", category: "trail", icon: "ü•æ", lat: 41.0877647, lng: -80.6814132, desc: "Easy 0.25 mile loop around Lily Pond. Very scenic with excellent wildlife viewing opportunities!" },
            { name: "Virginia J. Axtmann Nature Trail", category: "trail", icon: "ü•æ", lat: 41.0875, lng: -80.6820, desc: "Easy 0.1 mile paved trail with nature signage. Barrier-free access for all people!" },
            { name: "Artists' Trail", category: "trail", icon: "ü•æ", lat: 41.0865, lng: -80.6805, desc: "Easy 0.2 mile trail named for its popularity with local artists. Features a historic WPA stone wall from the Great Depression." },
            { name: "Slippery Rock Trail", category: "trail", icon: "ü•æ", lat: 41.0868, lng: -80.6795, desc: "Easy 0.4 mile trail with beautiful views of Mill Creek. Some steps near Old Furnace Road." },
            { name: "East Cohasset Hike & Bike Trail", category: "trail", icon: "üö¥", lat: 41.0785, lng: -80.6875, desc: "2 mile moderate to difficult paved trail, closed to vehicles. Popular with cyclists, joggers and walkers!" },
            { name: "West Cohasset Trail", category: "trail", icon: "ü•æ", lat: 41.0795, lng: -80.6900, desc: "1 mile moderately difficult trail with stately hemlock trees and views of Lake Cohasset." },
            { name: "East Cohasset Trail", category: "trail", icon: "ü•æ", lat: 41.0775, lng: -80.6860, desc: "1.2 mile moderately difficult trail with views of Lake Cohasset and the historic Suspension Bridge." },
            { name: "West Gorge Trail", category: "trail", icon: "ü•æ", lat: 41.0705, lng: -80.6835, desc: "1.2 mile moderately difficult trail with sandstone outcroppings. These views inspired Volney Rogers to establish Mill Creek Park!" },
            { name: "East Gorge Trail", category: "trail", icon: "ü•æ", lat: 41.0678, lng: -80.6818, desc: "0.5 mile moderately difficult trail with steps and boardwalk. Features scenic gorge, sandstone outcroppings including Umbrella Rock, and views of Lanterman's Falls!" },
            { name: "West Newport Trail", category: "trail", icon: "ü•æ", lat: 41.0585, lng: -80.6780, desc: "1 mile moderately difficult trail with hills. Offers views of Lake Newport, wetlands, and excellent wildlife viewing." },
            { name: "East Newport Hike & Bike Trail", category: "trail", icon: "üö¥", lat: 41.0600, lng: -80.6750, desc: "Easy 1.75 mile paved trail open to one-way vehicles. Views of Lake Newport, wetlands, and spectacular Daffodil Meadow in spring!" },
            { name: "Albert E. Davies Wetland Trail", category: "trail", icon: "ü•æ", lat: 41.0535, lng: -80.6770, desc: "Easy 0.25 mile asphalt trail to boardwalk through wetland habitat. Features interpretive signage and barrier-free access." },
            { name: "East Channel and Islands Trail", category: "trail", icon: "ü•æ", lat: 41.0545, lng: -80.6755, desc: "1 mile fairly flat trail with spring wildflowers, horsetails, and wetland views." },
            { name: "West Channel and Islands Trail", category: "trail", icon: "ü•æ", lat: 41.0550, lng: -80.6765, desc: "Easy 0.7 mile trail with slight grades. Features beautiful spring wildflowers but can be muddy." },
            { name: "East Golf Hike & Bike Trail", category: "trail", icon: "üö¥", lat: 41.0480, lng: -80.6850, desc: "Easy 1.5 mile paved trail, closed to vehicles. Heavily used by cyclists, joggers and walkers. Barrier-free access!" },
            
            // RECREATION (excluding playgrounds which now have their own category)
            { name: "Mill Creek Golf Course", category: "recreation", icon: "‚õ≥", lat: 41.0345702, lng: -80.6952989, desc: "This is Mill Creek Golf Course, an 18-hole Donald Ross designed course that's been challenging golfers since 1925." },
            { name: "3 Par Golf Course", category: "recreation", icon: "‚õ≥", lat: 41.0867287, lng: -80.6930365, desc: "You're at the 3 Par Golf Course in the Wick Recreation Area, a fun par 3 course for golfers of all skill levels." },
            { name: "East Newport Boat Launch", category: "recreation", icon: "üö§", lat: 41.0600601, lng: -80.6741443, desc: "You're at the East Newport Boat Launch. From here, you can access Lake Newport by kayak or canoe." },
            { name: "Lake Glacier Boating Center", category: "recreation", icon: "‚õµ", lat: 41.097517, lng: -80.6778914, desc: "You're at Lake Glacier Boating Center. This 44-acre lake is popular for kayaking, canoeing, and fishing." },
            { name: "Lake Newport Boathouse", category: "recreation", icon: "üö£", lat: 41.0629656, lng: -80.6783145, desc: "You're at Lake Newport Boathouse, where you can rent kayaks and pedal boats to explore the lake." },
            { name: "Pioneer Pavilion", category: "recreation", icon: "üèõÔ∏è", lat: 41.083178, lng: -80.680273, desc: "This is Pioneer Pavilion, a historic pavilion dating back to 1821. One of the oldest structures in the park!" },
            { name: "Kidston Pavilion", category: "recreation", icon: "‚õ∫", lat: 41.0986398, lng: -80.6752008, desc: "Approaching Kidston Pavilion at Fellows Riverside Gardens, a beautiful venue for special occasions." },
            
            // WATERFALLS
            { name: "Hole 55 Bar & Grill", category: "dining", icon: "üç¥", lat: 41.0348804, lng: -80.695366, desc: "Approaching Hole 55 Bar and Grill. Perfect spot to grab a bite and refresh during your ride!" },
            { name: "Newport Wetlands", category: "nature", icon: "ü¶Ü", lat: 41.0529021, lng: -80.6763854, desc: "You're entering Newport Wetlands, a 40-acre wetland habitat. Watch for herons, ducks, and other wildlife!" },
            { name: "Waterfall (North)", category: "waterfall", icon: "üíß", lat: 41.0979944, lng: -80.6745531, desc: "Listen carefully, you're approaching a beautiful waterfall in the northern section of the park. Take a moment to enjoy the cascading water!" },
            { name: "Waterfall (Central)", category: "waterfall", icon: "üíß", lat: 41.0820392, lng: -80.6807151, desc: "You're near a scenic waterfall in the central area. The sound of rushing water creates a peaceful atmosphere here." },
            { name: "Waterfall (South)", category: "waterfall", icon: "üíß", lat: 41.0645953, lng: -80.6782687, desc: "Approaching another beautiful waterfall feature in the southern section. Perfect photo opportunity!" },
            { name: "Cascade Gorge Natural Pool", category: "waterfall", icon: "üí¶", lat: 41.0758765, lng: -80.6921399, desc: "You've reached Cascade Gorge Natural Pool, a stunning natural swimming area formed by the creek's waterfalls." },
            { name: "Lanterman's Mill", category: "waterfall", icon: "üíß", lat: 41.0668378, lng: -80.6821128, desc: "You've reached Lanterman's Mill, a historic 1845 gristmill with a spectacular 23-foot waterfall. This is one of the park's most photographed landmarks at 1001 Canfield Road!" },
            
            // NATURE
            { name: "Daffodil Meadow", category: "nature", icon: "üåº", lat: 41.0552994, lng: -80.6765389, desc: "This is Daffodil Meadow. In spring, over 300,000 daffodils bloom here, creating an award-winning flower display!" },
            { name: "Fellows Riverside Gardens", category: "nature", icon: "üå∫", lat: 41.1009278, lng: -80.6757521, desc: "Welcome to Fellows Riverside Gardens, a stunning 12-acre public garden featuring beautiful roses and seasonal displays at 123 McKinley Avenue." },
            { name: "Ford Nature Center", category: "nature", icon: "ü¶ã", lat: 41.085579, lng: -80.678533, desc: "You're at Ford Nature Center, housed in a historic mansion. Inside you'll find nature exhibits and educational programs." },
            { name: "Lake Newport", category: "nature", icon: "üèûÔ∏è", lat: 41.0579891, lng: -80.6767662, desc: "This is Lake Newport, the largest lake in the park at 60 acres. A beautiful spot for reflection and wildlife watching." },
            { name: "Mill Creek Flats", category: "nature", icon: "üåæ", lat: 41.0722266, lng: -80.6899842, desc: "This is Mill Creek Flats, an open meadow area with playing fields, perfect for outdoor recreation." },
            { name: "Mill Creek Park - North End", category: "nature", icon: "üå≤", lat: 41.0994928, lng: -80.6735207, desc: "You're entering the northern section of Mill Creek Park. Enjoy the dense forests and peaceful trails." },
            { name: "Mill Creek Park - South End", category: "nature", icon: "üå≤", lat: 41.0275509, lng: -80.6950401, desc: "Welcome to the southern area of Mill Creek Park, featuring golf facilities and scenic landscapes." },
            
            // HISTORIC
            { name: "Idora Park (Historical)", category: "historic", icon: "üé¢", lat: 41.0708398, lng: -80.6838387, desc: "This is the site of historic Idora Park, a beloved amusement park that operated from 1899 to 1984. Many cherished memories were made here!" },
            { name: "Judge Morley Performing Arts Pavilion", category: "historic", icon: "üé≠", lat: 41.0857914, lng: -80.6957623, desc: "Approaching Judge Morley Performing Arts Pavilion, an outdoor venue for concerts and cultural performances." },
            { name: "Lanterman's Viewpoint", category: "historic", icon: "üëÅÔ∏è", lat: 41.0669603, lng: -80.6844987, desc: "You're at Lanterman's Viewpoint, offering a stunning scenic overlook above the historic mill and waterfall." },
            { name: "Volney Rogers Monument", category: "historic", icon: "‚ö±Ô∏è", lat: 41.0912363, lng: -80.6722574, desc: "You're at the Volney Rogers Monument, a 1920 statue honoring the founder of Mill Creek Park. A true visionary!" },
            { name: "Covered Bridge", category: "historic", icon: "üåâ", lat: 41.0665675, lng: -80.6813407, desc: "Approaching the historic Covered Bridge, a wooden bridge behind the mill that was rebuilt in 1989." },
            { name: "Suspension Bridge", category: "historic", icon: "üåâ", lat: 41.0732836, lng: -80.6889887, desc: "You're at the beautiful Suspension Bridge, also known as the Cinderella Bridge. Built in 1895 and restored in 2007, it's a stunning example of Victorian engineering!" },
            { name: "Mill Creek Furnace", category: "historic", icon: "üè≠", lat: 41.083307, lng: -80.6806604, desc: "You're near Mill Creek Furnace, historic iron furnace ruins that tell the story of the area's industrial past." },
            { name: "Old Log Cabin", category: "historic", icon: "üèöÔ∏è", lat: 41.0985792, lng: -80.6761369, desc: "You're near the Old Log Cabin, a historic structure that represents early settlement in the area." },
            
            // AMENITIES
            { name: "Birch Hill Cabin", category: "amenity", icon: "üè†", lat: 41.0867427, lng: -80.6816384, desc: "Approaching Birch Hill Cabin, a historic facility available for events and gatherings." },
            { name: "Bears Den Cabin", category: "amenity", icon: "üè†", lat: 41.0840799, lng: -80.6952423, desc: "You're at Bears Den Cabin in the Bears Den area, available for rentals and events." },
            { name: "Mill Creek Community Center", category: "amenity", icon: "üè¢", lat: 41.0947685, lng: -80.6732177, desc: "Approaching Mill Creek Community Center, offering various recreational programs and facilities." },
            { name: "Mill Creek Park Police Department", category: "amenity", icon: "üëÆ", lat: 41.0917267, lng: -80.671335, desc: "This is Mill Creek Park Police headquarters. For emergencies, call 330-702-3000. Stay safe!" },
            { name: "Restroom (Newport)", category: "amenity", icon: "üöª", lat: 41.0520417, lng: -80.6776516, desc: "Public restrooms available near Lake Newport." },
            { name: "Restroom (East Newport)", category: "amenity", icon: "üöª", lat: 41.060637, lng: -80.6744331, desc: "Public restrooms available at East Newport area." }
        ];

        const categoryColors = {
            waterfall: '#4A9EDB',
            recreation: '#D68438',
            historic: '#8B7355',
            nature: '#6B8E6F',
            dining: '#C44536',
            amenity: '#B89968',
            trail: '#27ae60',
            playground: '#e91e63'
        };

        // SEARCH FUNCTIONALITY
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        const clearSearchBtn = document.getElementById('clearSearch');

        searchInput.addEventListener('input', handleSearch);
        searchInput.addEventListener('focus', handleSearch);

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-wrapper')) {
                searchResults.classList.remove('active');
            }
        });

        function handleSearch(e) {
            const query = e.target.value.toLowerCase().trim();
            
            if (query.length === 0) {
                searchResults.classList.remove('active');
                clearSearchBtn.classList.remove('active');
                return;
            }

            clearSearchBtn.classList.add('active');

            const results = locations.filter(loc => {
                return loc.name.toLowerCase().includes(query) || 
                       loc.category.toLowerCase().includes(query) ||
                       loc.desc.toLowerCase().includes(query);
            });

            displaySearchResults(results, query);
        }

        function displaySearchResults(results, query) {
            if (results.length === 0) {
                searchResults.innerHTML = '<div class="no-results">No locations found matching "' + query + '"</div>';
                searchResults.classList.add('active');
                return;
            }

            searchResults.innerHTML = results.map(loc => `
                <div class="search-result-item" onclick="selectLocation(${loc.lat}, ${loc.lng}, '${loc.name.replace(/'/g, "\\'")}')">
                    <span class="search-result-icon">${loc.icon}</span>
                    <div class="search-result-text">
                        <div class="search-result-name">${loc.name}</div>
                        <div class="search-result-category">${loc.category}</div>
                    </div>
                </div>
            `).join('');

            searchResults.classList.add('active');
        }

        function selectLocation(lat, lng, name) {
            searchResults.classList.remove('active');
            map.setCenter({ lat, lng });
            map.setZoom(16);
            
            const marker = markers.find(m => 
                Math.abs(m.getPosition().lat() - lat) < 0.0001 && 
                Math.abs(m.getPosition().lng() - lng) < 0.0001
            );
            
            if (marker) {
                google.maps.event.trigger(marker, 'click');
            }
            
            // Scroll to the map, not the top of the page
            const mapWrapper = document.querySelector('.map-wrapper');
            if (mapWrapper) {
                mapWrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function clearSearch() {
            searchInput.value = '';
            searchResults.classList.remove('active');
            clearSearchBtn.classList.remove('active');
            searchInput.focus();
        }

        // AUDIO TOUR FUNCTIONS
        function toggleAudioTour() {
            const btn = document.getElementById('startAudioBtn');
            
            if (!audioEnabled) {
                // Check if we're in an iframe (embedded in Wix)
                const isInIframe = window.self !== window.top;
                
                if (!navigator.geolocation) {
                    alert("GPS not supported on this device. Please use a mobile device with GPS.");
                    return;
                }
                
                // Request permission first
                navigator.permissions.query({ name: 'geolocation' }).then((result) => {
                    if (result.state === 'denied') {
                        showGPSPermissionHelp(isInIframe);
                        return;
                    }
                    startAudioTourWithGPS(btn, isInIframe);
                }).catch(() => {
                    // Permissions API not supported, try anyway
                    startAudioTourWithGPS(btn, isInIframe);
                });
            } else {
                stopAudioTour(true); // Speak goodbye
            }
        }
        
        function showGPSPermissionHelp(isInIframe) {
            let message = "GPS Permission Required!\n\n";
            
            if (isInIframe) {
                message += "You're viewing this in an embedded page. For GPS audio tours to work:\n\n";
                message += "Option 1: Open in new tab\n";
                message += "- Tap the menu (‚ãÆ) ‚Üí 'Open in Chrome/Safari'\n";
                message += "- Or visit: " + window.location.href + "\n\n";
                message += "Option 2: Enable location in browser\n";
                message += "- Chrome: Settings ‚Üí Site Settings ‚Üí Location ‚Üí Allow\n";
                message += "- Safari: Settings ‚Üí Safari ‚Üí Location ‚Üí Allow";
            } else {
                message += "To enable GPS:\n\n";
                message += "Chrome:\n";
                message += "1. Tap the lock icon in the address bar\n";
                message += "2. Tap 'Permissions'\n";
                message += "3. Set Location to 'Allow'\n\n";
                message += "Safari:\n";
                message += "1. Go to iPhone Settings ‚Üí Safari\n";
                message += "2. Tap 'Location'\n";
                message += "3. Select 'Allow'";
            }
            
            alert(message);
        }
        
        function startAudioTourWithGPS(btn, isInIframe) {
            // 1. Set state FIRST to prevent double-triggering
            audioEnabled = true;
            gpsInitialized = false;
            
            // 2. UI Feedback
            btn.classList.add('active');
            btn.innerHTML = "üì° Initializing GPS...";
            btn.style.background = "#f39c12";
            
            // 3. Start GPS Watch
            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    // First successful GPS lock
                    if (!gpsInitialized) {
                        gpsInitialized = true;
                        btn.innerHTML = "üì° GPS Tracking Active";
                        btn.style.background = "#27ae60";
                        console.log("GPS locked successfully");
                    }
                    updateUserLocation(position);
                },
                (err) => {
                    console.error("GPS Error:", err.code, err.message);
                    
                    // Only stop if we haven't gotten a GPS lock yet
                    if (!gpsInitialized) {
                        let errorMsg = "";
                        
                        if (err.code === 1) { // PERMISSION_DENIED
                            showGPSPermissionHelp(isInIframe);
                            stopAudioTour(false);
                            return;
                        } else if (err.code === 2) { // POSITION_UNAVAILABLE
                            errorMsg = "GPS unavailable. Please ensure:\n";
                            errorMsg += "‚Ä¢ You're outdoors or near a window\n";
                            errorMsg += "‚Ä¢ GPS is enabled on your device\n";
                            errorMsg += "‚Ä¢ You have a clear view of the sky";
                        } else if (err.code === 3) { // TIMEOUT
                            errorMsg = "GPS timeout. Still searching...\n";
                            errorMsg += "Please wait or move to an area with better GPS signal.";
                            // Don't stop on timeout, just notify
                            console.log(errorMsg);
                            return;
                        }
                        
                        if (errorMsg) {
                            alert(errorMsg);
                            stopAudioTour(false);
                        }
                    }
                },
                { 
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 15000
                }
            );
            
            // 4. Trigger Welcome Message with delay
            setTimeout(() => {
                if (audioEnabled) {
                    speak("Audio Tour Enabled. GPS tracking started. Enjoy your ride through Mill Creek Park!");
                }
            }, 500);
        }
        
        // Dedicated stop function to ensure clean state
        function stopAudioTour(speakGoodbye = true) {
            const btn = document.getElementById('startAudioBtn');
            
            audioEnabled = false;
            gpsInitialized = false;
            
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            
            btn.classList.remove('active');
            btn.innerHTML = "üéß Start Audio Tour";
            btn.style.background = "var(--accent-orange)";
            
            window.speechSynthesis.cancel();
            
            if (userMarker) {
                userMarker.setMap(null);
                userMarker = null;
            }
            
            // Only speak goodbye if user manually stopped (not on error)
            if (speakGoodbye) {
                setTimeout(() => {
                    speak("Audio Tour ended. Thank you for riding with us!");
                }, 100);
            }
        }

        function updateUserLocation(position) {
            const userLat = position.coords.latitude;
            const userLng = position.coords.longitude;
            const userPos = new google.maps.LatLng(userLat, userLng);
            
            if (!userMarker) {
                userMarker = new google.maps.Marker({
                    map: map,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 8,
                        fillColor: "#4285F4",
                        fillOpacity: 1,
                        strokeColor: "white",
                        strokeWeight: 3
                    },
                    title: "You are here",
                    zIndex: 1000
                });
            }
            
            userMarker.setPosition(userPos);
            
            // Only auto-center on first location or if user is far from current view
            const currentCenter = map.getCenter();
            const distanceFromCenter = getDistanceFromLatLonInMeters(
                userLat, userLng, 
                currentCenter.lat(), currentCenter.lng()
            );
            
            // Auto-center if more than 500 meters from center
            if (distanceFromCenter > 500) {
                map.panTo(userPos);
            }
            
            checkProximity(userLat, userLng);
        }

        function checkProximity(lat, lng) {
            locations.forEach(spot => {
                const distance = getDistanceFromLatLonInMeters(lat, lng, spot.lat, spot.lng);
                
                // Trigger zone: 50 meters (about 164 feet)
                if (distance < 50) {
                    if (!spokenLocations.has(spot.name)) {
                        triggerHotspot(spot);
                    }
                }
            });
            
            // GEOFENCING: Check if user is near or outside park boundaries
            checkParkBoundaries(lat, lng);
        }

        function checkParkBoundaries(lat, lng) {
            const userPoint = new google.maps.LatLng(lat, lng);
            const isInside = google.maps.geometry.poly.containsLocation(userPoint, parkBoundary);
            
            const now = Date.now();
            const timeSinceLastWarning = now - lastBoundaryWarning;
            
            // Don't warn more than once every 30 seconds
            if (timeSinceLastWarning < 30000) {
                return;
            }
            
            // Calculate distance to nearest boundary point
            const distanceToBoundary = getDistanceToNearestBoundaryPoint(lat, lng);
            
            // WARNING ZONE: Within 50 meters of boundary (about 164 feet)
            if (isInside && distanceToBoundary < 50) {
                lastBoundaryWarning = now;
                isInsidePark = true;
                showBoundaryWarning("approaching");
                speak("Warning: You are approaching the park boundary. Please stay within Mill Creek Park for your safety.");
            }
            // OUTSIDE PARK: User has left the park
            else if (!isInside && isInsidePark) {
                lastBoundaryWarning = now;
                isInsidePark = false;
                hasLeftPark = true;
                showBoundaryWarning("outside");
                speak("Alert: You have left Mill Creek Park boundaries. Please return to the park trails. Remember, never use Bears Den Road!");
            }
            // RETURNING TO PARK: User came back
            else if (isInside && hasLeftPark && !isInsidePark) {
                lastBoundaryWarning = now;
                isInsidePark = true;
                hasLeftPark = false;
                showBoundaryWarning("returned");
                speak("Welcome back! You have returned to Mill Creek Park. Stay safe and enjoy your ride!");
            }
        }

        function getDistanceToNearestBoundaryPoint(lat, lng) {
            const boundaryPoints = parkBoundary.getPath().getArray();
            let minDistance = Infinity;
            
            boundaryPoints.forEach(point => {
                const distance = getDistanceFromLatLonInMeters(
                    lat, lng, 
                    point.lat(), point.lng()
                );
                if (distance < minDistance) {
                    minDistance = distance;
                }
            });
            
            return minDistance;
        }

        function showBoundaryWarning(type) {
            const popup = document.getElementById('audioPopup');
            const title = document.getElementById('popupTitle');
            
            if (type === "approaching") {
                title.innerText = "‚ö†Ô∏è Approaching Park Boundary";
                popup.style.background = "linear-gradient(135deg, #f39c12, #e67e22)";
            } else if (type === "outside") {
                title.innerText = "üö´ Outside Park Boundaries!";
                popup.style.background = "linear-gradient(135deg, #e74c3c, #c0392b)";
            } else if (type === "returned") {
                title.innerText = "‚úÖ Back Inside Park";
                popup.style.background = "linear-gradient(135deg, #27ae60, #229954)";
            }
            
            popup.classList.add('show');
            
            setTimeout(() => {
                popup.classList.remove('show');
                // Reset to default color
                popup.style.background = "linear-gradient(135deg, var(--sage-green), var(--dark-sage))";
            }, 8000); // Show for 8 seconds for boundary warnings
        }

        function triggerHotspot(spot) {
            spokenLocations.add(spot.name);
            
            const popup = document.getElementById('audioPopup');
            document.getElementById('popupTitle').innerText = spot.name;
            popup.classList.add('show');
            
            speak(spot.desc, () => {
                setTimeout(() => {
                    popup.classList.remove('show');
                }, 3000);
            });

            // Allow re-triggering after 5 minutes
            setTimeout(() => {
                spokenLocations.delete(spot.name);
            }, 300000);
        }

        // Robust speak function to prevent "cutting out"
        function speak(text, onEndCallback) {
            if (!window.speechSynthesis) {
                console.warn("Speech synthesis not supported");
                return;
            }

            // Cancel any ongoing speech
            window.speechSynthesis.cancel();

            // Create utterance
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9;
            utterance.pitch = 1.0;
            utterance.volume = 1.0;
            utterance.lang = 'en-US';

            // Get available voices and prefer a natural-sounding one
            const voices = window.speechSynthesis.getVoices();
            const preferredVoice = voices.find(voice => 
                voice.lang === 'en-US' && (voice.name.includes('Google') || voice.name.includes('Samantha'))
            ) || voices.find(voice => voice.lang === 'en-US') || voices[0];
            
            if (preferredVoice) {
                utterance.voice = preferredVoice;
            }

            // Mobile "Keep-Alive" Heartbeat
            // This prevents the OS from killing the process during long descriptions
            let heartbeat = null;
            
            utterance.onstart = () => {
                console.log("Speech started:", text.substring(0, 50) + "...");
                heartbeat = setInterval(() => {
                    if (window.speechSynthesis.speaking) {
                        window.speechSynthesis.pause();
                        window.speechSynthesis.resume();
                    } else {
                        if (heartbeat) clearInterval(heartbeat);
                    }
                }, 10000); // Every 10 seconds
            };

            utterance.onend = () => {
                console.log("Speech completed");
                if (heartbeat) clearInterval(heartbeat);
                if (onEndCallback) onEndCallback();
            };

            utterance.onerror = (event) => {
                console.error("Speech error:", event);
                if (heartbeat) clearInterval(heartbeat);
                if (onEndCallback) onEndCallback();
            };

            // Small timeout to allow the 'cancel()' to clear the hardware buffer
            setTimeout(() => {
                window.speechSynthesis.speak(utterance);
            }, 100);
        }

        function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth radius in km
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const d = R * c;
            return d * 1000; // Convert to meters
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        // MAP INITIALIZATION
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 41.070, lng: -80.685 },
                zoom: 13,
                styles: [
                    { featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] },
                    { featureType: "road", elementType: "geometry", stylers: [{ color: "#F5EFE6" }] },
                    { featureType: "landscape", stylers: [{ color: "#E8F5E9" }] },
                    { featureType: "water", stylers: [{ color: "#A5D6F1" }] }
                ]
            });

            infoWindow = new google.maps.InfoWindow();
            
            parkBoundary = new google.maps.Polygon({
                paths: [
                  {"lat": 41.102, "lng": -80.67},
                  {"lat": 41.095072, "lng": -80.672607},
                  {"lat": 41.093419, "lng": -80.675198},
                  {"lat": 41.091622, "lng": -80.671987},
                  {"lat": 41.08976, "lng": -80.67354},
                  {"lat": 41.088119, "lng": -80.672038},
                  {"lat": 41.083913, "lng": -80.67535},
                  {"lat": 41.085012, "lng": -80.677529},
                  {"lat": 41.084913, "lng": -80.679398},
                  {"lat": 41.077682, "lng": -80.678787},
                  {"lat": 41.079186, "lng": -80.682468},
                  {"lat": 41.079218, "lng": -80.684756},
                  {"lat": 41.077309, "lng": -80.683926},
                  {"lat": 41.077616, "lng": -80.686772},
                  {"lat": 41.076475, "lng": -80.686393},
                  {"lat": 41.076012, "lng": -80.684153},
                  {"lat": 41.074838, "lng": -80.682685},
                  {"lat": 41.072369, "lng": -80.686795},
                  {"lat": 41.069597, "lng": -80.68604},
                  {"lat": 41.067133, "lng": -80.68168},
                  {"lat": 41.068087, "lng": -80.678131},
                  {"lat": 41.061001, "lng": -80.674619},
                  {"lat": 41.060046, "lng": -80.67312},
                  {"lat": 41.056041, "lng": -80.67486},
                  {"lat": 41.054006, "lng": -80.674099},
                  {"lat": 41.051468, "lng": -80.672903},
                  {"lat": 41.048386, "lng": -80.67488},
                  {"lat": 41.049532, "lng": -80.679731},
                  {"lat": 41.048324, "lng": -80.681126},
                  {"lat": 41.046912, "lng": -80.67676},
                  {"lat": 41.045304, "lng": -80.677715},
                  {"lat": 41.044632, "lng": -80.679016},
                  {"lat": 41.045837, "lng": -80.678922},
                  {"lat": 41.045529, "lng": -80.682447},
                  {"lat": 41.025, "lng": -80.695},
                  {"lat": 41.02487, "lng": -80.701813},
                  {"lat": 41.041995, "lng": -80.700384},
                  {"lat": 41.044828, "lng": -80.696365},
                  {"lat": 41.045653, "lng": -80.68535},
                  {"lat": 41.049213, "lng": -80.685444},
                  {"lat": 41.051996, "lng": -80.680732},
                  {"lat": 41.066192, "lng": -80.679509},
                  {"lat": 41.0663, "lng": -80.688253},
                  {"lat": 41.079284, "lng": -80.69571},
                  {"lat": 41.083752, "lng": -80.681194},
                  {"lat": 41.082363, "lng": -80.696852},
                  {"lat": 41.086197, "lng": -80.699703},
                  {"lat": 41.088308, "lng": -80.695979},
                  {"lat": 41.088442, "lng": -80.688538},
                  {"lat": 41.08843, "lng": -80.683994},
                  {"lat": 41.087905, "lng": -80.683478},
                  {"lat": 41.096479, "lng": -80.678424},
                  {"lat": 41.098469, "lng": -80.681047},
                  {"lat": 41.09839, "lng": -80.681095},
                  {"lat": 41.098452, "lng": -80.681152},
                  {"lat": 41.098448, "lng": -80.681165},
                  {"lat": 41.09851, "lng": -80.681157},
                  {"lat": 41.098476, "lng": -80.681196},
                  {"lat": 41.098232, "lng": -80.680872},
                  {"lat": 41.098434, "lng": -80.681139},
                  {"lat": 41.09847, "lng": -80.681144},
                  {"lat": 41.098488, "lng": -80.681189},
                  {"lat": 41.098303, "lng": -80.681083},
                  {"lat": 41.098372, "lng": -80.680987},
                  {"lat": 41.098342, "lng": -80.681068},
                  {"lat": 41.098392, "lng": -80.680979},
                  {"lat": 41.099193, "lng": -80.679691},
                  {"lat": 41.099593, "lng": -80.679218},
                  {"lat": 41.100828, "lng": -80.677308},
                  {"lat": 41.100867, "lng": -80.677458},
                  {"lat": 41.098289, "lng": -80.680918},
                  {"lat": 41.098396, "lng": -80.680944},
                  {"lat": 41.101378, "lng": -80.676588},
                  {"lat": 41.101709, "lng": -80.671116}
                ],
                strokeColor: '#D68438',
                strokeOpacity: 0.9,
                strokeWeight: 4,
                fillColor: '#6B8E6F',
                fillOpacity: 0.08,
                map: null
            });
            
            loadAllMarkers();
            renderLocationCards();
        }

        function loadAllMarkers() {
            markers.forEach(m => m.setMap(null));
            markers = [];

            locations.forEach(loc => {
                const marker = new google.maps.Marker({
                    position: { lat: loc.lat, lng: loc.lng },
                    map: map,
                    title: loc.name,
                    animation: google.maps.Animation.DROP,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 10,
                        fillColor: categoryColors[loc.category],
                        fillOpacity: 1,
                        strokeColor: 'white',
                        strokeWeight: 3
                    },
                    category: loc.category
                });

                marker.addListener('click', () => {
                    const trailStyle = currentRouteMode === 'trail' 
                        ? 'background:#27ae60; color:white; border:3px solid #FFD700;' 
                        : 'background:#6B8E6F; color:white;';
                    const bikeStyle = currentRouteMode === 'bike' 
                        ? 'background:#e67e22; color:white; border:3px solid #FFD700;' 
                        : 'background:#D68438; color:white;';
                    
                    const trailLabel = currentRouteMode === 'trail' ? '‚≠ê Recommended' : 'Scenic Trail';
                    const bikeLabel = currentRouteMode === 'bike' ? '‚≠ê Selected' : 'Bike Route';
                    
                    const content = `
                        <div style="font-family:'Open Sans',sans-serif; padding:12px; max-width:320px;">
                            <h3 style="color:${categoryColors[loc.category]}; margin-bottom:8px; font-size:1.2rem;">
                                ${loc.icon} ${loc.name}
                            </h3>
                            <p style="font-size:0.95rem; color:#555; line-height:1.6; margin-bottom:12px;">
                                ${loc.desc}
                            </p>
                            <div style="font-size:0.8rem; color:#888; margin-bottom:12px; text-transform:uppercase;">
                                ${loc.category}
                            </div>
                            
                            <div style="margin-bottom: 8px; text-align: center; font-size: 0.85rem; color: #666; font-weight: 600;">
                                Choose Your Route:
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                                <a href="https://www.google.com/maps/dir/?api=1&destination=${loc.lat},${loc.lng}&travelmode=walking&dir_action=navigate" 
                                   target="_blank" 
                                   style="display:block; ${trailStyle} padding:12px 10px; 
                                          border-radius:8px; text-decoration:none; font-weight:700; font-size:0.85rem; text-align:center;
                                          box-shadow: ${currentRouteMode === 'trail' ? '0 4px 12px rgba(39, 174, 96, 0.3)' : 'none'};">
                                    üö∂<br>${trailLabel}
                                </a>
                                <a href="https://www.google.com/maps/dir/?api=1&destination=${loc.lat},${loc.lng}&travelmode=bicycling&dir_action=navigate" 
                                   target="_blank" 
                                   style="display:block; ${bikeStyle} padding:12px 10px; 
                                          border-radius:8px; text-decoration:none; font-weight:700; font-size:0.85rem; text-align:center;
                                          box-shadow: ${currentRouteMode === 'bike' ? '0 4px 12px rgba(230, 126, 34, 0.3)' : 'none'};">
                                    üö¥<br>${bikeLabel}
                                </a>
                            </div>
                            
                            <div style="margin-bottom: 8px; padding: 10px; background: #ffebee; border: 2px solid #e74c3c; border-radius: 6px; text-align: center;">
                                <strong style="color: #c0392b; font-size: 0.9rem; display: block;">üö´ NEVER USE BEARS DEN ROAD</strong>
                                <span style="color: #721c24; font-size: 0.8rem;">City street with traffic - Use park trails only!</span>
                            </div>
                            
                            <div style="margin-top:10px; padding:10px; background:#E8F5E9; border-left:3px solid #6B8E6F; border-radius:4px; font-size:0.8rem; color:#2C3A2E;">
                                <strong style="display:block; margin-bottom:5px;">üå≥ Route Guidelines:</strong>
                                <strong style="color:#6B8E6F;">üö∂ Trail Route:</strong> Most scenic paths, slower pace, follows walking trails<br><br>
                                <strong style="color:#D68438;">üö¥ Bike Route:</strong> Faster, may use park roads, still scenic<br><br>
                                <strong style="color:#e74c3c;">‚ö†Ô∏è Important:</strong> If GPS suggests Bears Den Rd, ignore it and use park trails instead!
                            </div>
                            
                            <div style="margin-top:8px; padding:8px; background:#FFF3CD; border-radius:6px; font-size:0.85rem; color:#856404; text-align:center;">
                                üü¢ Both routes stay within park boundaries
                            </div>
                        </div>
                    `;
                    infoWindow.setContent(content);
                    infoWindow.open(map, marker);
                });

                markers.push(marker);
            });
        }

        function toggleParkBoundary() {
            boundaryVisible = !boundaryVisible;
            const btn = document.getElementById('boundaryBtn');
            
            if (boundaryVisible) {
                parkBoundary.setMap(map);
                btn.textContent = '‚úÖ SAFE ZONE VISIBLE - Stay Inside Orange Line!';
                btn.style.background = '#27ae60';
                btn.style.color = 'white';
                btn.style.borderColor = '#27ae60';
            } else {
                parkBoundary.setMap(null);
                btn.textContent = 'üó∫Ô∏è SHOW SAFE RIDING ZONE';
                btn.style.background = 'var(--accent-orange)';
                btn.style.color = 'white';
                btn.style.borderColor = 'var(--accent-orange)';
            }
        }

        function setRouteMode(mode) {
            currentRouteMode = mode;
            
            const trailBtn = document.getElementById('trailModeBtn');
            const bikeBtn = document.getElementById('bikeModeBtn');
            const modeText = document.getElementById('currentModeText');
            const modeDesc = document.getElementById('modeDescription');
            
            if (mode === 'trail') {
                trailBtn.style.background = '#6B8E6F';
                trailBtn.style.color = 'white';
                trailBtn.style.borderColor = '#6B8E6F';
                trailBtn.classList.add('active');
                
                bikeBtn.style.background = 'white';
                bikeBtn.style.color = '#D68438';
                bikeBtn.style.borderColor = '#D68438';
                bikeBtn.classList.remove('active');
                
                modeText.textContent = 'Scenic Trail Mode';
                modeText.style.color = '#6B8E6F';
                modeDesc.textContent = 'Most scenic routes through the park';
            } else {
                bikeBtn.style.background = '#D68438';
                bikeBtn.style.color = 'white';
                bikeBtn.style.borderColor = '#D68438';
                bikeBtn.classList.add('active');
                
                trailBtn.style.background = 'white';
                trailBtn.style.color = '#6B8E6F';
                trailBtn.style.borderColor = '#6B8E6F';
                trailBtn.classList.remove('active');
                
                modeText.textContent = 'Bike Route Mode';
                modeText.style.color = '#D68438';
                modeDesc.textContent = 'Faster routes, may use park roads';
            }
            
            infoWindow.close();
        }

        function filterByCategory(category) {
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            markers.forEach(marker => {
                if (category === 'all' || marker.category === category) {
                    marker.setMap(map);
                } else {
                    marker.setMap(null);
                }
            });

            const cards = document.querySelectorAll('.location-card');
            cards.forEach(card => {
                if (category === 'all' || card.dataset.category === category) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });

            const visibleCount = category === 'all' ? locations.length : 
                                locations.filter(l => l.category === category).length;
            document.getElementById('totalLocations').textContent = visibleCount;

            if (category !== 'all') {
                const bounds = new google.maps.LatLngBounds();
                markers.forEach(marker => {
                    if (marker.getMap()) {
                        bounds.extend(marker.getPosition());
                    }
                });
                if (!bounds.isEmpty()) {
                    map.fitBounds(bounds);
                }
            } else {
                map.setCenter({ lat: 41.070, lng: -80.685 });
                map.setZoom(13);
            }
        }

        function renderLocationCards() {
            const grid = document.getElementById('locationsGrid');
            
            locations.forEach(loc => {
                const card = document.createElement('div');
                card.className = `location-card ${loc.category}`;
                card.dataset.category = loc.category;
                card.innerHTML = `
                    <span class="location-icon">${loc.icon}</span>
                    <div class="location-name">${loc.name}</div>
                    <div class="location-category">${loc.category}</div>
                `;
                
                card.onclick = () => {
                    map.setCenter({ lat: loc.lat, lng: loc.lng });
                    map.setZoom(16);
                    
                    const marker = markers.find(m => 
                        m.getPosition().lat() === loc.lat && 
                        m.getPosition().lng() === loc.lng
                    );
                    if (marker) {
                        google.maps.event.trigger(marker, 'click');
                    }
                    
                    // Scroll to the map, not the top of the page
                    const mapWrapper = document.querySelector('.map-wrapper');
                    if (mapWrapper) {
                        mapWrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                };
                
                grid.appendChild(card);
            });
        }
    </script>
</body>
</html>

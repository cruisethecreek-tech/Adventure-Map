<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Permissions-Policy" content="geolocation=(self)">
    <title>Cruise the Creek | Mill Creek Park eBike Tours</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --sage-green: #6B8E6F;
            --dark-sage: #4A6B4D;
            --tan-beige: #D4C5B0;
            --cream: #F5EFE6;
            --accent-orange: #D68438;
            --text-dark: #2C3A2E;
            --white: #ffffff;
            --shadow: 0 8px 24px rgba(107, 142, 111, 0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Open Sans', sans-serif;
            background: linear-gradient(to bottom, var(--cream) 0%, #E8DCC8 100%);
            color: var(--text-dark);
            overflow-x: hidden;
        }

        h1, h2, h3 { font-family: 'Montserrat', sans-serif; }

        /* Loading Spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(245, 239, 230, 0.95);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease;
        }

        .loading-overlay.hide {
            opacity: 0;
            pointer-events: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--sage-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            font-size: 1.2rem;
            color: var(--sage-green);
            font-weight: 600;
        }

        header {
            background: linear-gradient(rgba(75, 107, 77, 0.85), rgba(75, 107, 77, 0.85)), 
                        url('https://images.unsplash.com/photo-1559827260-dc66d52bef19?ixlib=rb-4.0.3&auto=format&fit=crop&w=2070&q=80');
            background-size: cover;
            background-position: center;
            color: var(--cream);
            padding: 80px 20px 60px;
            text-align: center;
            border-bottom: 5px solid var(--accent-orange);
        }

        h1 {
            font-size: clamp(2.5rem, 6vw, 4.5rem);
            font-weight: 800;
            margin-bottom: 15px;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
        }

        .tagline {
            font-size: clamp(1rem, 2.5vw, 1.4rem);
            font-weight: 600;
            color: var(--tan-beige);
            letter-spacing: 3px;
            text-transform: uppercase;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .info-banner {
            background: linear-gradient(135deg, var(--sage-green), var(--dark-sage));
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 40px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .info-banner h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .search-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            border: 3px solid var(--sage-green);
        }

        .search-wrapper {
            position: relative;
            max-width: 600px;
            margin: 0 auto;
        }

        #searchInput {
            width: 100%;
            padding: 16px 50px 16px 20px;
            font-size: 1.1rem;
            border: 2px solid var(--tan-beige);
            border-radius: 30px;
            outline: none;
            transition: all 0.3s ease;
            font-family: 'Open Sans', sans-serif;
        }

        #searchInput:focus {
            border-color: var(--sage-green);
            box-shadow: 0 0 0 3px rgba(107, 142, 111, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.3rem;
            color: var(--sage-green);
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 12px;
            margin-top: 10px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .search-results.active { display: block; }

        .search-result-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .search-result-item:hover {
            background: var(--cream);
            padding-left: 25px;
        }

        .search-result-item:last-child { border-bottom: none; }
        .search-result-icon { font-size: 1.5rem; min-width: 30px; }
        .search-result-text { flex: 1; }
        .search-result-name { font-weight: 700; color: var(--text-dark); margin-bottom: 3px; }
        .search-result-category { font-size: 0.8rem; color: #888; text-transform: uppercase; }
        .no-results { padding: 20px; text-align: center; color: #888; font-style: italic; }

        .clear-search {
            position: absolute;
            right: 55px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 1.2rem;
            color: #999;
            cursor: pointer;
            padding: 5px;
            display: none;
        }

        .clear-search.active { display: block; }
        .clear-search:hover { color: var(--sage-green); }

        .category-accordion-item {
            background: white;
            border-radius: 50px;
            margin-bottom: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border: 2px solid var(--sage-green);
            transition: all 0.3s ease;
        }

        .category-accordion-item.active { border-radius: 20px; background: #fdfdfd; }

        .accordion-btn {
            width: 100%;
            background: white;
            border: none;
            padding: 18px 25px;
            text-align: left;
            font-size: 1.1rem;
            font-weight: 800;
            color: var(--sage-green);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .accordion-btn:hover { background: var(--cream); }

        .accordion-btn .arrow {
            transition: transform 0.3s ease;
            font-size: 0.9rem;
            color: #999;
        }

        .accordion-btn.active { background: var(--sage-green); color: white; }
        .accordion-btn.active .arrow { transform: rotate(180deg); color: white; }
        .accordion-btn.active .badge { background: rgba(255,255,255,0.3); color: white; }

        .badge {
            background: #E8F5E9;
            color: var(--sage-green);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: 10px;
            font-weight: 700;
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
            background: white;
        }

        .accordion-inner-grid {
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            background: #f9f9f9;
        }

        .mini-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            border: 1px solid #eee;
            transition: transform 0.2s;
        }

        .mini-card:hover { transform: translateX(5px); border-color: var(--sage-green); }
        .mini-icon { font-size: 1.8rem; }
        .mini-info { flex: 1; }
        .mini-name { font-weight: 700; font-size: 0.95rem; line-height: 1.3; color: var(--text-dark); }

        .vibe-badge-container { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 8px; }
        .vibe-badge { font-size: 0.75rem; padding: 4px 8px; border-radius: 12px; font-weight: 600; background: #eee; color: #555; display: inline-block; }
        .badge-photo { background: #E1BEE7; color: #8E24AA; }
        .badge-restroom { background: #BBDEFB; color: #1976D2; }
        .badge-steep { background: #FFCDD2; color: #D32F2F; }
        .badge-flat { background: #C8E6C9; color: #388E3C; }
        .badge-family { background: #FFF9C4; color: #FBC02D; }

        .time-stat { font-size: 0.85rem; color: #666; margin-bottom: 8px; font-weight: 600; display: flex; align-items: center; gap: 5px; }

        .audio-btn {
            background: var(--accent-orange);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(230, 126, 34, 0.4);
            animation: pulse 2s infinite;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .audio-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(230, 126, 34, 0.5); }
        .audio-btn.active { background: var(--sage-green); animation: none; }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .find-me-btn {
            position: absolute;
            bottom: 25px;
            right: 10px;
            background: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid #ddd;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            transition: transform 0.2s ease;
        }

        .find-me-btn:hover { background: #f0f0f0; transform: scale(1.1); }
        .find-me-btn:active { background: #e0e0e0; transform: scale(0.95); }
        .find-me-btn.active { color: #4285F4; border-color: #4285F4; }

        /* ============================================================
           MODE-SPECIFIC WAYPOINT PLAYER STYLES
        ============================================================ */
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        @keyframes hazardPulse { 0%,100%{background:rgba(255,255,255,0.1)} 50%{background:rgba(255,255,255,0.3)} }

        .waypoint-player {
            position: fixed; left: 50%;
            transform: translateX(-50%) translateY(200px);
            z-index: 3000;
            transition: transform 0.4s cubic-bezier(0.175,0.885,0.32,1.275);
            pointer-events: none; opacity: 0;
            transition: transform 0.4s cubic-bezier(0.175,0.885,0.32,1.275), opacity 0.3s;
        }
        .waypoint-player.show { transform: translateX(-50%) translateY(0); pointer-events: all; opacity: 1; }

        /* WALK */
        #walkPlayer { bottom: 30px; width: min(380px,92vw); background: linear-gradient(135deg,#6B8E6F,#4a6b4e); color:white; border-radius:20px; padding:18px 20px; box-shadow:0 12px 40px rgba(0,0,0,0.35); }
        #walkPlayer .wp-header { display:flex; align-items:center; gap:12px; margin-bottom:10px; }
        #walkPlayer .wp-icon { width:36px;height:36px;background:rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0; }
        #walkPlayer .wp-title { font-size:1.1rem;font-weight:700;line-height:1.2; }
        #walkPlayer .wp-subtitle { font-size:0.78rem;opacity:0.85;margin-top:2px; }
        #walkPlayer .wp-desc { font-size:0.82rem;opacity:0.9;line-height:1.5;margin-bottom:12px;padding:8px 10px;background:rgba(0,0,0,0.15);border-radius:8px; }
        #walkPlayer .wp-controls { display:flex;gap:10px;align-items:center; }
        #walkPlayer .wp-btn { flex:1;background:rgba(255,255,255,0.2);border:2px solid rgba(255,255,255,0.4);color:white;border-radius:12px;padding:10px 8px;font-size:0.85rem;font-weight:700;cursor:pointer;text-align:center;transition:background 0.2s; }
        #walkPlayer .wp-btn:active { background:rgba(255,255,255,0.4); }
        #walkPlayer .wp-btn.primary { background:rgba(255,255,255,0.3);border-color:white;font-size:1rem; }

        /* BIKE */
        #bikePlayer { bottom:0;width:100vw;max-width:100vw;left:0;transform:translateX(0) translateY(120px);background:linear-gradient(135deg,#D68438,#b8621e);color:white;border-radius:20px 20px 0 0;box-shadow:0 -4px 20px rgba(0,0,0,0.4); }
        #bikePlayer.show { transform:translateX(0) translateY(0); }
        #bikePlayer .bp-swipe-hint { text-align:center;font-size:0.65rem;opacity:0.6;padding:7px 0 0;letter-spacing:0.5px;text-transform:uppercase; }
        #bikePlayer .bp-main { display:flex;align-items:center;padding:10px 16px 16px;gap:8px; }
        #bikePlayer .bp-nav-btn { width:60px;height:60px;background:rgba(255,255,255,0.2);border:3px solid rgba(255,255,255,0.5);border-radius:50%;color:white;font-size:1.6rem;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:background 0.15s; }
        #bikePlayer .bp-nav-btn:active { background:rgba(255,255,255,0.45); }
        #bikePlayer .bp-center { flex:1;text-align:center;padding:0 4px; }
        #bikePlayer .bp-title { font-size:1.15rem;font-weight:900;line-height:1.1;text-shadow:0 1px 3px rgba(0,0,0,0.3); }
        #bikePlayer .bp-status { font-size:0.72rem;opacity:0.8;margin-top:3px; }
        #bikePlayer .bp-blink { display:inline-block;width:8px;height:8px;background:#fff;border-radius:50%;animation:blink 1s infinite;vertical-align:middle;margin-right:4px; }

        /* CAR */
        #carPlayer { bottom:0;width:100vw;max-width:100vw;left:0;transform:translateX(0) translateY(200px);background:linear-gradient(160deg,#1a1a2e,#16213e);color:white;border-radius:20px 20px 0 0;box-shadow:0 -6px 30px rgba(0,0,0,0.6);padding:16px 20px 24px; }
        #carPlayer.show { transform:translateX(0) translateY(0); }
        #carPlayer.hazard-mode { background:linear-gradient(160deg,#7b0000,#c0392b); }
        #carPlayer .cp-hazard-banner { display:none;text-align:center;font-size:1rem;font-weight:800;background:rgba(255,255,255,0.15);border-radius:10px;padding:10px;margin-bottom:12px;animation:hazardPulse 1s infinite; }
        #carPlayer.hazard-mode .cp-hazard-banner { display:block; }
        #carPlayer .cp-row { display:flex;align-items:center;gap:14px;margin-bottom:14px; }
        #carPlayer .cp-info { flex:1; }
        #carPlayer .cp-label { font-size:0.65rem;text-transform:uppercase;letter-spacing:1px;opacity:0.55;margin-bottom:2px; }
        #carPlayer .cp-title { font-size:1.25rem;font-weight:900;line-height:1.2; }
        #carPlayer .cp-upcoming { font-size:0.78rem;opacity:0.65;margin-top:2px; }
        #carPlayer .cp-status-dot { width:14px;height:14px;background:#e74c3c;border-radius:50%;animation:blink 1s infinite;flex-shrink:0; }
        #carPlayer .cp-status-dot.playing { background:#2ecc71; }
        #carPlayer .cp-controls { display:flex;gap:12px; }
        #carPlayer .cp-btn { flex:1;background:rgba(255,255,255,0.12);border:2px solid rgba(255,255,255,0.25);color:white;border-radius:14px;padding:14px 10px;font-size:1rem;font-weight:700;cursor:pointer;text-align:center;transition:background 0.2s;line-height:1.3; }
        #carPlayer .cp-btn:active { background:rgba(255,255,255,0.3); }
        #carPlayer .cp-dismiss { text-align:center;margin-top:10px;font-size:0.75rem;opacity:0.45;cursor:pointer; }

        .chapter-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(107, 142, 111, 0.95);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 600;
            z-index: 2000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: opacity 0.5s ease;
        }

        .mode-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: 600;
            z-index: 4000;
            box-shadow: 0 4px 16px rgba(0,0,0,0.35);
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.9rem;
            transition: opacity 0.4s ease;
            white-space: nowrap;
        }
        .mode-toast .undo-btn {
            background: rgba(255,255,255,0.25);
            border: 1px solid rgba(255,255,255,0.5);
            color: white;
            border-radius: 12px;
            padding: 4px 10px;
            font-size: 0.78rem;
            font-weight: 700;
            cursor: pointer;
        }
.background-audio-player {
    position: fixed;
    bottom: 90px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #2c3e50, #34495e);
    color: white;
    padding: 15px 25px;
    border-radius: 20px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    z-index: 2500;
    min-width: 350px;
    max-width: 90%;
    display: none;
    flex-direction: column;
    gap: 12px;
}

.background-audio-player.active {
    display: flex;
}

.player-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
}

.player-title {
    font-size: 0.9rem;
    font-weight: 700;
    opacity: 0.95;
}

.player-chapter {
    font-size: 0.75rem;
    opacity: 0.7;
}

.player-controls {
    display: flex;
    align-items: center;
    gap: 15px;
}

.player-btn {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 1rem;
}

.player-btn:hover {
    background: rgba(255,255,255,0.3);
    transform: scale(1.1);
}

.player-btn.play-pause {
    background: var(--accent-orange);
    width: 44px;
    height: 44px;
    font-size: 1.2rem;
}

.player-btn.play-pause:hover {
    background: #e67e22;
    box-shadow: 0 4px 12px rgba(230, 126, 34, 0.4);
}

.progress-container {
    display: flex;
    align-items: center;
    gap: 10px;
}

.progress-bar {
    flex: 1;
    height: 6px;
    background: rgba(255,255,255,0.2);
    border-radius: 3px;
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: var(--accent-orange);
    border-radius: 3px;
    width: 0%;
    transition: width 0.1s linear;
}

.progress-handle {
    position: absolute;
    top: 50%;
    transform: translate(-50%, -50%);
    width: 14px;
    height: 14px;
    background: white;
    border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    cursor: grab;
    opacity: 0;
    transition: opacity 0.2s;
}

.progress-bar:hover .progress-handle {
    opacity: 1;
}

.time-display {
    font-size: 0.75rem;
    font-family: 'Courier New', monospace;
    opacity: 0.8;
    min-width: 90px;
    text-align: center;
}

.volume-control {
    display: flex;
    align-items: center;
    gap: 8px;
}

.volume-slider {
    width: 80px;
    height: 4px;
    background: rgba(255,255,255,0.2);
    border-radius: 2px;
    outline: none;
    -webkit-appearance: none;
    cursor: pointer;
}

.volume-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 12px;
    height: 12px;
    background: white;
    border-radius: 50%;
    cursor: pointer;
}

.volume-slider::-moz-range-thumb {
    width: 12px;
    height: 12px;
    background: white;
    border-radius: 50%;
    border: none;
    cursor: pointer;
}

.player-close-btn {
    background: rgba(231, 76, 60, 0.3);
    border: none;
    color: white;
    padding: 6px 12px;
    border-radius: 12px;
    font-size: 0.75rem;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s;
}

.player-close-btn:hover {
    background: rgba(231, 76, 60, 0.5);
}

@media (max-width: 768px) {
    .background-audio-player {
        bottom: 70px;
        min-width: unset;
        padding: 12px 18px;
    }
    
    .player-controls {
        gap: 10px;
    }
    
    .player-btn {
        width: 32px;
        height: 32px;
        font-size: 0.9rem;
    }
    
    .player-btn.play-pause {
        width: 40px;
        height: 40px;
        font-size: 1.1rem;
    }
    
    .volume-control {
        display: none; /* Hide volume on mobile - use device volume */
    }
    
    .time-display {
        font-size: 0.7rem;
        min-width: 80px;
    }
}
        .map-wrapper {
            background: white;
            border-radius: 20px;
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 40px;
            position: relative;
        }

        .map-frame-container {
            position: relative;
            width: 100%;
            height: 700px;
        }

        .map-header {
            padding: 25px;
            background: linear-gradient(135deg, var(--sage-green), var(--dark-sage));
            color: white;
        }

        .map-header h2 { font-size: 2rem; margin-bottom: 10px; }

        .map-header-controls {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .map-controls {
            padding: 15px 20px;
            background: var(--cream);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            border-bottom: 2px solid var(--tan-beige);
        }

        .filter-btn {
            padding: 10px 20px;
            border: 2px solid var(--sage-green);
            background: white;
            color: var(--sage-green);
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .filter-btn:hover, .filter-btn.active { background: var(--sage-green); color: white; }

        #map { width: 100%; height: 100%; }

        footer {
            text-align: center;
            padding: 50px 20px;
            background: var(--sage-green);
            color: var(--cream);
            margin-top: 60px;
        }

        footer h3 { font-size: 1.8rem; margin-bottom: 15px; }

        .support-section {
            margin-top: 20px;
        }
        .support-title {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 6px;
            opacity: 0.9;
        }
        .support-subtitle {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-bottom: 14px;
        }
        .support-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        .support-btn {
            display: inline-flex;
            align-items: center;
            gap: 7px;
            padding: 10px 18px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 700;
            font-size: 0.88rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: transform 0.2s, box-shadow 0.2s;
            white-space: nowrap;
        }
        .support-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.25); }
        .support-btn.paypal { background: #003087; color: white; }
        .support-btn.venmo  { background: #008CFF; color: white; }
        .support-btn.cashapp { background: #00D64F; color: white; }

        @media (max-width: 768px) {
            h1 { font-size: 1.8rem; }
            h2 { font-size: 1.4rem; }
            h3 { font-size: 1.1rem; }
            .tagline { font-size: 0.8rem; }
            .map-frame-container { height: 500px; }
            .container { padding: 20px 15px; }
            #searchInput { font-size: 0.9rem; padding: 10px 40px 10px 15px; }
            .search-icon { font-size: 1rem; right: 15px; }
            .map-controls { flex-direction: column; }
            .filter-btn { padding: 6px 12px; font-size: 0.8rem; }
            #currentModeText, #modeDescription { font-size: 0.8rem; }
            .audio-btn { padding: 8px 16px; font-size: 0.9rem; }
            .accordion-inner-grid { display: flex; flex-direction: column; gap: 10px; padding: 15px; }
            .mini-card { border-radius: 50px; padding: 12px 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
            .mini-icon { font-size: 1.4rem; margin-right: 5px; }
            .mini-name { font-size: 0.95rem; white-space: normal; overflow: visible; text-overflow: clip; line-height: 1.3; }
            .accordion-btn { padding: 14px 20px; font-size: 0.95rem; }

        }

        /* ============================================================
           ONBOARDING OVERLAY
        ============================================================ */
        #onboardingOverlay {
            position: fixed; inset: 0; z-index: 9999;
            background: linear-gradient(160deg, #1a2a1a 0%, #2d4a2d 40%, #1a3a2a 100%);
            display: flex; align-items: center; justify-content: center;
            padding: 20px;
            transition: opacity 0.6s ease;
        }
        #onboardingOverlay.fade-out { opacity: 0; pointer-events: none; }
        .ob-card {
            background: rgba(255,255,255,0.06);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 24px;
            max-width: 420px; width: 100%;
            padding: 32px 28px;
            color: white;
            text-align: center;
        }
        .ob-logo { font-size: 2.8rem; margin-bottom: 8px; }
        .ob-title { font-family: 'Georgia', serif; font-size: 1.6rem; font-weight: 700; margin-bottom: 4px; color: #FFD700; }
        .ob-subtitle { font-size: 0.85rem; opacity: 0.7; margin-bottom: 28px; }
        .ob-steps { display: flex; flex-direction: column; gap: 14px; margin-bottom: 28px; text-align: left; }
        .ob-step { display: flex; align-items: flex-start; gap: 14px; }
        .ob-step-num {
            width: 32px; height: 32px; border-radius: 50%; flex-shrink: 0;
            background: linear-gradient(135deg, #D68438, #b8621e);
            display: flex; align-items: center; justify-content: center;
            font-weight: 900; font-size: 0.9rem;
        }
        .ob-step-text { font-size: 0.88rem; line-height: 1.5; opacity: 0.9; padding-top: 5px; }
        .ob-step-text strong { color: #FFD700; }
        .ob-btn {
            width: 100%; padding: 15px;
            background: linear-gradient(135deg, #D68438, #b8621e);
            border: none; border-radius: 14px; color: white;
            font-size: 1rem; font-weight: 800; cursor: pointer;
            box-shadow: 0 6px 20px rgba(214,132,56,0.4);
            transition: transform 0.15s, box-shadow 0.15s;
        }
        .ob-btn:active { transform: scale(0.97); }
        .ob-skip { margin-top: 12px; font-size: 0.78rem; opacity: 0.5; cursor: pointer; }
        .ob-skip:hover { opacity: 0.8; }
        .ob-dots { display: flex; justify-content: center; gap: 6px; margin-bottom: 20px; }
        .ob-dot { width: 8px; height: 8px; border-radius: 50%; background: rgba(255,255,255,0.25); transition: all 0.3s; }
        .ob-dot.active { background: #D68438; width: 22px; border-radius: 4px; }

        /* ============================================================
           AUDIO UNLOCK PROMPT (iOS)
        ============================================================ */
        #audioUnlockPrompt {
            position: fixed; bottom: 100px; left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #e67e22, #d35400);
            color: white; padding: 14px 22px; border-radius: 20px;
            box-shadow: 0 6px 24px rgba(0,0,0,0.4);
            z-index: 5000; cursor: pointer;
            display: none; text-align: center;
            animation: pulsePrompt 2s infinite;
            max-width: 88vw;
        }
        @keyframes pulsePrompt {
            0%,100% { box-shadow: 0 6px 24px rgba(214,132,56,0.4); }
            50% { box-shadow: 0 6px 32px rgba(214,132,56,0.8); }
        }
        #audioUnlockPrompt .aup-title { font-weight: 800; font-size: 1rem; margin-bottom: 3px; }
        #audioUnlockPrompt .aup-sub { font-size: 0.78rem; opacity: 0.9; }

        /* ============================================================
           GPS SIGNAL INDICATOR
        ============================================================ */
        #gpsSignalBar {
            position: fixed; top: 0; left: 0; right: 0;
            background: #e74c3c; color: white;
            text-align: center; padding: 8px 16px;
            font-size: 0.82rem; font-weight: 700;
            z-index: 4500; display: none;
            animation: slideDown 0.3s ease;
        }
        #gpsSignalBar.weak { background: #f39c12; }
        @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }

        /* ============================================================
           WAYPOINT PROGRESS COUNTER
        ============================================================ */
        #waypointProgress {
            position: fixed; top: 12px; left: 16px;
            background: rgba(26,26,26,0.85);
            color: white; padding: 7px 13px; border-radius: 20px;
            font-size: 0.75rem; font-weight: 700;
            z-index: 3500; display: none;
            backdrop-filter: blur(8px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
        }
        #waypointProgress .wp-count { color: #D68438; }
        #waypointProgress .wp-bar {
            height: 3px; background: rgba(255,255,255,0.15);
            border-radius: 2px; margin-top: 4px; overflow: hidden;
        }
        #waypointProgress .wp-bar-fill {
            height: 100%; background: linear-gradient(90deg, #D68438, #FFD700);
            border-radius: 2px; transition: width 0.5s ease;
        }

        /* ============================================================
           TRANSCRIPT BUTTON & MODAL
        ============================================================ */
        .wp-transcript-btn {
            width: 100%; margin-top: 8px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.25);
            color: white; border-radius: 10px;
            padding: 7px; font-size: 0.75rem;
            cursor: pointer; opacity: 0.8;
        }
        #transcriptModal {
            position: fixed; inset: 0; z-index: 6000;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(6px);
            display: none; align-items: flex-end; justify-content: center;
            padding: 20px;
        }
        #transcriptModal.show { display: flex; }
        .transcript-card {
            background: #1e2d1e; color: white;
            border-radius: 20px 20px 16px 16px;
            width: 100%; max-width: 500px;
            max-height: 70vh; overflow-y: auto;
            padding: 24px 22px;
        }
        .transcript-card h3 { font-size: 1.1rem; color: #FFD700; margin-bottom: 12px; }
        .transcript-card p { font-size: 0.88rem; line-height: 1.7; opacity: 0.9; }
        .transcript-close {
            width: 100%; margin-top: 16px; padding: 12px;
            background: rgba(255,255,255,0.1); border: none;
            color: white; border-radius: 10px; cursor: pointer;
            font-size: 0.88rem; font-weight: 700;
        }

        /* ============================================================
           RIDE STATS PANEL
        ============================================================ */
        #rideStats {
            position: fixed; bottom: 90px; left: 16px;
            background: rgba(26,26,26,0.85);
            color: white; padding: 10px 14px; border-radius: 16px;
            font-size: 0.72rem; z-index: 3500; display: none;
            backdrop-filter: blur(8px);
            box-shadow: 0 2px 12px rgba(0,0,0,0.35);
            border: 1px solid rgba(255,255,255,0.1);
            min-width: 110px;
        }
        #rideStats .rs-label { opacity: 0.5; font-size: 0.62rem; text-transform: uppercase; letter-spacing: 0.5px; }
        #rideStats .rs-val { font-weight: 800; font-size: 0.95rem; color: #D68438; }
        #rideStats .rs-row { margin-bottom: 6px; }

        /* ============================================================
           COMPLETION CELEBRATION
        ============================================================ */
        #completionModal {
            position: fixed; inset: 0; z-index: 7000;
            background: rgba(0,0,0,0.75); backdrop-filter: blur(8px);
            display: none; align-items: center; justify-content: center;
            padding: 24px;
        }
        #completionModal.show { display: flex; }
        .completion-card {
            background: linear-gradient(160deg, #1a2a1a, #2d4a2d);
            border: 2px solid #FFD700;
            color: white; border-radius: 24px;
            padding: 36px 28px; text-align: center;
            max-width: 380px; width: 100%;
        }
        .completion-card .cc-trophy { font-size: 4rem; margin-bottom: 12px; }
        .completion-card h2 { font-family: 'Georgia', serif; font-size: 1.8rem; color: #FFD700; margin-bottom: 8px; }
        .completion-card p { font-size: 0.9rem; opacity: 0.85; line-height: 1.6; margin-bottom: 20px; }
        .completion-card .cc-stats {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 12px; margin-bottom: 24px;
        }
        .completion-card .cc-stat {
            background: rgba(255,255,255,0.08);
            border-radius: 12px; padding: 12px 8px;
        }
        .completion-card .cc-stat-val { font-size: 1.4rem; font-weight: 900; color: #D68438; }
        .completion-card .cc-stat-label { font-size: 0.7rem; opacity: 0.6; margin-top: 2px; }
        .completion-card .cc-share {
            width: 100%; padding: 14px;
            background: linear-gradient(135deg, #D68438, #b8621e);
            border: none; border-radius: 14px; color: white;
            font-size: 0.95rem; font-weight: 800; cursor: pointer;
            margin-bottom: 10px;
        }
        .completion-card .cc-dismiss {
            width: 100%; padding: 10px;
            background: transparent; border: 1px solid rgba(255,255,255,0.2);
            color: white; border-radius: 14px; cursor: pointer;
            font-size: 0.85rem;
        }
        @keyframes confettiFall {
            0% { transform: translateY(-20px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        .confetti-piece {
            position: fixed; top: -20px; width: 10px; height: 10px;
            border-radius: 2px; z-index: 7500; pointer-events: none;
            animation: confettiFall linear forwards;
        }

        /* ============================================================
           PERSONALIZATION SETUP (onboarding step 3 becomes prefs)
        ============================================================ */
        .ob-pref-grid {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 10px; margin-bottom: 20px;
        }
        .ob-pref-chip {
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 12px; padding: 10px 8px;
            text-align: center; cursor: pointer;
            transition: all 0.2s; font-size: 0.82rem;
            background: rgba(255,255,255,0.05);
            color: white;
        }
        .ob-pref-chip.selected {
            border-color: #D68438;
            background: rgba(214,132,56,0.25);
            color: #FFD700; font-weight: 700;
        }
        .ob-pref-chip .pref-icon { font-size: 1.3rem; display: block; margin-bottom: 4px; }
        .ob-section-label {
            font-size: 0.7rem; text-transform: uppercase;
            letter-spacing: 1px; opacity: 0.5;
            margin-bottom: 8px; text-align: left;
        }

        /* ============================================================
           WEATHER BANNER
        ============================================================ */
        #weatherBanner {
            position: fixed; top: 0; left: 0; right: 0;
            z-index: 3800; display: none;
            padding: 10px 16px;
            color: white; font-size: 0.82rem;
            cursor: pointer;
            transition: top 0.3s ease;
        }
        #gpsSignalBar.active ~ #weatherBanner,
        body.gps-lost #weatherBanner { top: 38px; }
        #weatherBanner .wb-inner {
            display: flex; align-items: center; gap: 10px;
            max-width: 600px; margin: 0 auto;
        }
        #weatherBanner .wb-icon { font-size: 1.4rem; flex-shrink: 0; }
        #weatherBanner .wb-text { flex: 1; line-height: 1.4; }
        #weatherBanner .wb-tip {
            font-style: italic; opacity: 0.85;
            font-size: 0.78rem; margin-top: 1px;
        }
        #weatherBanner .wb-dismiss {
            opacity: 0.5; font-size: 1rem; flex-shrink: 0; padding: 4px;
        }
        #weatherBanner .wb-temp {
            font-weight: 900; font-size: 1rem; flex-shrink: 0;
        }

        /* ============================================================
           PERSONALIZED "WHY YOU'LL LOVE THIS" IN WALK PLAYER
        ============================================================ */
        #walkPersonalTip {
            font-size: 0.75rem;
            background: rgba(255,215,0,0.12);
            border: 1px solid rgba(255,215,0,0.25);
            border-radius: 8px; padding: 7px 10px;
            margin-top: 8px; display: none;
            color: #FFD700; line-height: 1.5;
        }

        /* ============================================================
           WEATHER DETAIL MODAL
        ============================================================ */
        #weatherModal {
            position: fixed; inset: 0; z-index: 6500;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(8px);
            display: none; align-items: flex-end; justify-content: center;
            padding: 20px;
        }
        #weatherModal.show { display: flex; }
        .weather-card {
            background: linear-gradient(160deg, #0f2027, #203a43, #2c5364);
            color: white; border-radius: 20px; padding: 24px 22px;
            width: 100%; max-width: 420px;
        }
        .weather-card h3 { font-size: 1.1rem; margin-bottom: 16px; color: #FFD700; }
        .weather-main { display: flex; align-items: center; gap: 16px; margin-bottom: 16px; }
        .weather-main .wm-icon { font-size: 3.5rem; }
        .weather-main .wm-temp { font-size: 2.8rem; font-weight: 900; }
        .weather-main .wm-desc { font-size: 0.9rem; opacity: 0.8; margin-top: 2px; }
        .weather-details {
            display: grid; grid-template-columns: 1fr 1fr 1fr;
            gap: 10px; margin-bottom: 16px;
        }
        .weather-detail {
            background: rgba(255,255,255,0.08); border-radius: 10px;
            padding: 10px 8px; text-align: center;
        }
        .weather-detail .wd-val { font-weight: 700; font-size: 0.95rem; }
        .weather-detail .wd-label { font-size: 0.65rem; opacity: 0.55; margin-top: 2px; }
        .weather-tips { margin-bottom: 16px; }
        .weather-tips h4 { font-size: 0.78rem; opacity: 0.6; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .weather-tip-item {
            display: flex; align-items: flex-start; gap: 10px;
            margin-bottom: 8px; font-size: 0.82rem; line-height: 1.5;
        }
        .weather-close {
            width: 100%; padding: 12px; background: rgba(255,255,255,0.1);
            border: none; color: white; border-radius: 12px;
            cursor: pointer; font-size: 0.88rem; font-weight: 700;
        }
    </style>
</head>
<body>

    <!-- Loading Overlay -->

    <!-- ONBOARDING OVERLAY -->
    <div id="onboardingOverlay">
        <div class="ob-card">
            <div class="ob-logo">üö¥</div>
            <div class="ob-title">Mill Creek Audio Tour</div>
            <div class="ob-subtitle">Powered by Cruise the Creek ‚Ä¢ Youngstown, Ohio</div>
            <div class="ob-dots">
                <div class="ob-dot active" id="obDot0"></div>
                <div class="ob-dot" id="obDot1"></div>
                <div class="ob-dot" id="obDot2"></div>
                <div class="ob-dot" id="obDot3"></div>
            </div>
            <div id="obStep0" class="ob-steps">
                <div class="ob-step">
                    <div class="ob-step-num">1</div>
                    <div class="ob-step-text"><strong>Pick your mode</strong> ‚Äî Walk, Bike, or Car. Each has its own player and trigger distance tuned for how fast you're moving.</div>
                </div>
                <div class="ob-step">
                    <div class="ob-step-num">2</div>
                    <div class="ob-step-text"><strong>Start the Audio Tour</strong> ‚Äî tap the button on the map page to activate GPS tracking and background narration.</div>
                </div>
                <div class="ob-step">
                    <div class="ob-step-num">3</div>
                    <div class="ob-step-text"><strong>Explore &amp; listen</strong> ‚Äî as you approach each of the 63 locations, audio will play automatically. No tapping required.</div>
                </div>
            </div>
            <div id="obStep1" class="ob-steps" style="display:none;">
                <div class="ob-step">
                    <div class="ob-step-num">üö∂</div>
                    <div class="ob-step-text"><strong>Walk Mode</strong> ‚Äî 25m radius. Shows location descriptions. Replay, Previous, and Next buttons for full control.</div>
                </div>
                <div class="ob-step">
                    <div class="ob-step-num">üö¥</div>
                    <div class="ob-step-text"><strong>Bike Mode</strong> ‚Äî 100m radius. Slim bar at bottom. <strong>Swipe left to go back, swipe right to skip.</strong> Big thumb-friendly buttons.</div>
                </div>
                <div class="ob-step">
                    <div class="ob-step-num">üöó</div>
                    <div class="ob-step-text"><strong>Car Mode</strong> ‚Äî 125m radius. <strong>Red hazard warning appears first</strong> ‚Äî pull over safely before audio plays.</div>
                </div>
            </div>
            <!-- Step 2: Tips -->
            <div id="obStep2" class="ob-steps" style="display:none;">
                <div class="ob-step">
                    <div class="ob-step-num">üîä</div>
                    <div class="ob-step-text"><strong>Keep your volume up</strong> and make sure your phone is not on silent/vibrate mode.</div>
                </div>
                <div class="ob-step">
                    <div class="ob-step-num">üìç</div>
                    <div class="ob-step-text"><strong>Allow location access</strong> when prompted ‚Äî GPS is required for the audio tour to work.</div>
                </div>
                <div class="ob-step">
                    <div class="ob-step-num">‚òï</div>
                    <div class="ob-step-text">This tour is <strong>free forever</strong>. If you love it, support us via the donate button at the bottom!</div>
                </div>
            </div>

            <!-- Step 3: Personalization -->
            <div id="obStep3" style="display:none; text-align:left;">
                <div class="ob-section-label">What brings you to the park today?</div>
                <div class="ob-pref-grid" id="prefInterests">
                    <div class="ob-pref-chip" data-pref="history" onclick="togglePref(this,'interests')"><span class="pref-icon">üèõÔ∏è</span>History</div>
                    <div class="ob-pref-chip" data-pref="nature" onclick="togglePref(this,'interests')"><span class="pref-icon">üåø</span>Nature</div>
                    <div class="ob-pref-chip" data-pref="family" onclick="togglePref(this,'interests')"><span class="pref-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span>Family</div>
                    <div class="ob-pref-chip" data-pref="fitness" onclick="togglePref(this,'interests')"><span class="pref-icon">üí™</span>Fitness</div>
                    <div class="ob-pref-chip" data-pref="photography" onclick="togglePref(this,'interests')"><span class="pref-icon">üì∏</span>Photography</div>
                    <div class="ob-pref-chip" data-pref="geology" onclick="togglePref(this,'interests')"><span class="pref-icon">ü™®</span>Geology</div>
                </div>
                <div class="ob-section-label" style="margin-top:4px;">Experience level</div>
                <div class="ob-pref-grid" id="prefLevel" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div class="ob-pref-chip" data-pref="beginner" onclick="togglePref(this,'level')"><span class="pref-icon">üå±</span>Beginner</div>
                    <div class="ob-pref-chip" data-pref="moderate" onclick="togglePref(this,'level')"><span class="pref-icon">üöµ</span>Moderate</div>
                    <div class="ob-pref-chip" data-pref="advanced" onclick="togglePref(this,'level')"><span class="pref-icon">üèÜ</span>Advanced</div>
                </div>
            </div>

            <button class="ob-btn" id="obNextBtn" onclick="onboardingNext()">Next ‚Üí</button>
            <div class="ob-skip" onclick="dismissOnboarding()">Skip intro</div>
        </div>
    </div>

    <!-- AUDIO UNLOCK PROMPT (iOS) -->
    <div id="audioUnlockPrompt" onclick="unlockAudioPrompt()">
        <div class="aup-title">üîä Tap to Activate Audio</div>
        <div class="aup-sub">iOS requires a tap to enable audio playback</div>
    </div>

    <!-- GPS SIGNAL INDICATOR -->
    <div id="gpsSignalBar">üì° GPS signal lost ‚Äî move to an open area</div>

    <!-- WEATHER BANNER -->
    <div id="weatherBanner" onclick="openWeatherModal()">
        <div class="wb-inner">
            <div class="wb-icon" id="wbIcon">üå§</div>
            <div class="wb-text">
                <div><strong id="wbCondition">Loading weather...</strong> <span id="wbTemp" class="wb-temp"></span></div>
                <div class="wb-tip" id="wbTip"></div>
            </div>
            <div class="wb-dismiss" onclick="event.stopPropagation(); document.getElementById('weatherBanner').style.display='none'">‚úï</div>
        </div>
    </div>

    <!-- WEATHER DETAIL MODAL -->
    <div id="weatherModal">
        <div class="weather-card">
            <h3>üå§ Current Conditions ‚Äî Mill Creek Park</h3>
            <div class="weather-main">
                <div class="wm-icon" id="wmIcon">üå§</div>
                <div>
                    <div class="wm-temp" id="wmTemp">‚Äî¬∞F</div>
                    <div class="wm-desc" id="wmDesc">‚Äî</div>
                </div>
            </div>
            <div class="weather-details">
                <div class="weather-detail"><div class="wd-val" id="wmFeels">‚Äî</div><div class="wd-label">Feels Like</div></div>
                <div class="weather-detail"><div class="wd-val" id="wmHumidity">‚Äî</div><div class="wd-label">Humidity</div></div>
                <div class="weather-detail"><div class="wd-val" id="wmWind">‚Äî</div><div class="wd-label">Wind</div></div>
            </div>
            <div class="weather-tips">
                <h4>Trail Recommendations</h4>
                <div id="wmTips"></div>
            </div>
            <button class="weather-close" onclick="document.getElementById('weatherModal').classList.remove('show')">Close</button>
        </div>
    </div>

    <!-- WAYPOINT PROGRESS COUNTER -->
    <div id="waypointProgress">
        <div><span class="wp-count" id="wpCountText">0 / 63</span> waypoints heard</div>
        <div class="wp-bar"><div class="wp-bar-fill" id="wpBarFill" style="width:0%"></div></div>
    </div>

    <!-- RIDE STATS -->
    <div id="rideStats">
        <div class="rs-row"><div class="rs-label">Time on Trail</div><div class="rs-val" id="rideTime">0:00</div></div>
        <div class="rs-row"><div class="rs-label">Waypoints</div><div class="rs-val" id="rideWaypoints">0</div></div>
        <div class="rs-row" style="margin-bottom:0"><div class="rs-label">Distance</div><div class="rs-val" id="rideDistance">0.0 mi</div></div>
    </div>

    <!-- TRANSCRIPT MODAL -->
    <div id="transcriptModal">
        <div class="transcript-card">
            <h3 id="transcriptTitle">Location Name</h3>
            <p id="transcriptText">Loading transcript...</p>
            <button class="transcript-close" onclick="closeTranscript()">‚úï Close</button>
        </div>
    </div>

    <!-- COMPLETION MODAL -->
    <div id="completionModal">
        <div class="completion-card">
            <div class="cc-trophy">üèÜ</div>
            <h2>Tour Complete!</h2>
            <p>You've explored all 63 locations in Mill Creek MetroParks. Youngstown's best kept secret ‚Äî and now you know every inch of it.</p>
            <div class="cc-stats">
                <div class="cc-stat"><div class="cc-stat-val" id="ccTime">‚Äî</div><div class="cc-stat-label">Time on Trail</div></div>
                <div class="cc-stat"><div class="cc-stat-val" id="ccDist">‚Äî</div><div class="cc-stat-label">Miles Covered</div></div>
                <div class="cc-stat"><div class="cc-stat-val">63</div><div class="cc-stat-label">Waypoints Heard</div></div>
                <div class="cc-stat"><div class="cc-stat-val" id="ccMode">‚Äî</div><div class="cc-stat-label">Primary Mode</div></div>
            </div>
            <button class="cc-share" onclick="shareCompletion()">üì∏ Share Your Achievement</button>
            <button class="cc-dismiss" onclick="document.getElementById('completionModal').classList.remove('show')">Continue Exploring</button>
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text">Loading Mill Creek Park...</div>
    </div>

    <header>
        <div class="container">
            <h1>Cruise the Creek</h1>
            <div class="tagline">Mill Creek MetroParks ‚Ä¢ eBike Adventures</div>
        </div>
    </header>

    <div class="container">

        <div class="info-banner">
            <h3>üö¥ Scenic eBike Adventure Through Mill Creek Park</h3>
            <p>63 locations including 18 official trails ‚Ä¢ 45 miles of scenic trails ‚Ä¢ Take the slow route and enjoy nature</p>
            <p style="margin-top: 10px; font-size: 0.95rem; opacity: 0.95;">üå≥ <strong>Experience First, Speed Second:</strong> Follow park trails for the most scenic routes. Stay within park boundaries!</p>
            <p style="margin-top: 10px; font-size: 0.95rem; background: rgba(52, 152, 219, 0.15); padding: 10px; border-radius: 8px; border: 2px solid #3498db;">üìç <strong>Smart Geofencing Enabled:</strong> Audio alerts will warn you if you approach or leave park boundaries!</p>
            <p style="margin-top: 10px; font-size: 1rem; background: rgba(231, 76, 60, 0.15); padding: 10px; border-radius: 8px; border: 2px solid #e74c3c;">üö´ <strong style="color: #c0392b;">NEVER USE BEARS DEN ROAD</strong> - It's a city street with traffic. Use park trails only!</p>
        </div>

        <div class="search-container">
            <h2 style="text-align: center; font-size: 1.8rem; margin-bottom: 15px; color: var(--text-dark);">üîç Search Locations</h2>
            <div class="search-wrapper">
                <input type="text" id="searchInput" placeholder="Search for waterfalls, pavilions, trails, dining..." autocomplete="off" />
                <button class="clear-search" id="clearSearch" onclick="clearSearch()">‚úï</button>
                <span class="search-icon">üîç</span>
                <div class="search-results" id="searchResults"></div>
            </div>
        </div>

        <h2 style="text-align: center; font-size: 2rem; margin-bottom: 20px; color: var(--text-dark);">Explore by Category</h2>
        <div id="categoryContainer" style="margin-top: 30px;"></div>

        <div class="map-wrapper" style="margin-top: 40px;">
            <div class="map-header">
                <div class="map-header-controls" style="justify-content: center; margin-top: 0;">
                    <button class="audio-btn" id="startAudioBtn" onclick="toggleAudioTour()">üéß Start Audio Tour</button>
                    <button class="audio-btn" id="pauseBackgroundBtn" onclick="toggleBackgroundAudio()" style="display:none; background:#34495e;">
                        ‚è∏Ô∏è Pause History Tour
                    </button>
                    <button class="audio-btn" id="batteryModeBtn" onclick="toggleBatteryMode()" style="display:none; background:#7f8c8d;">
                        üîã Battery Saver
                    </button>
                    <span style="font-size: 0.9rem; opacity: 0.9; margin-left: 10px; display: inline-block;">Enable GPS tracking for audio</span>
                </div>
            </div>
            <div class="map-controls">
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; width: 100%;">
                    <button class="filter-btn" id="boundaryBtn" onclick="toggleParkBoundary()" style="background: var(--accent-orange); color: white; border-color: var(--accent-orange); font-size: 1rem; padding: 12px 24px;">
                        üó∫Ô∏è SHOW SAFE RIDING ZONE
                    </button>
                    <div style="flex: 1; min-width: 200px; text-align: center; padding: 0 15px;">
                        <span style="font-size: 0.9rem; color: var(--text-dark); font-weight: 600; display: block;">Choose Your Route Style:</span>
                        <div style="display: flex; gap: 8px; margin-top: 8px; justify-content: center;">
                            <button class="filter-btn active" id="trailModeBtn" onclick="setRouteMode('trail')" style="background: #6B8E6F; color: white; border-color: #6B8E6F; font-size: 0.85rem; padding: 8px 16px;">üö∂ Walking Route</button>
                            <button class="filter-btn" id="bikeModeBtn" onclick="setRouteMode('bike')" style="background: white; color: #D68438; border-color: #D68438; font-size: 0.85rem; padding: 8px 16px;">üö¥ Bike Routes (Faster)</button>
                            <button class="filter-btn" id="carModeBtn" onclick="setRouteMode('car')" style="background: white; color: #c0392b; border-color: #c0392b; font-size: 0.85rem; padding: 8px 16px;">üöó Car Mode</button>
                        </div>
                    </div>
                </div>
                <div style="width: 100%; margin-top: 10px; padding: 10px; background: white; border-radius: 8px; font-size: 0.85rem; text-align: center; color: #555;">
                    <strong>Current Mode:</strong> <span id="currentModeText" style="color: #6B8E6F; font-weight: 700;">Scenic Trail Mode</span> - 
                    <span id="modeDescription">Most scenic routes through the park</span>
                </div>
            </div>
            <div class="map-frame-container">
                <div id="map"></div>
                <button class="find-me-btn" onclick="startGPS()" title="Find My Location">üéØ</button>
            </div>
        </div>

    </div>

    <!-- WALK MODE PLAYER -->
    <div class="waypoint-player" id="walkPlayer">
        <div class="wp-header">
            <div class="wp-icon" id="walkIcon">üö∂</div>
            <div>
                <div class="wp-title" id="walkTitle">Location Name</div>
                <div class="wp-subtitle" id="walkSubtitle">üîä Audio Guide Playing</div>
            </div>
        </div>
        <div class="wp-desc" id="walkDesc"></div>
        <div class="wp-controls">
            <button class="wp-btn" onclick="playerPrev()">‚èÆ Prev</button>
            <button class="wp-btn primary" id="walkPauseBtn" onclick="playerWaypointPause()">‚è∏ Pause</button>
            <button class="wp-btn" onclick="playerReplay()">üîÅ Replay</button>
            <button class="wp-btn" onclick="playerSkip()">Next ‚è≠</button>
        </div>
        <div id="walkPersonalTip"></div>
        <button class="wp-transcript-btn" onclick="showTranscript()">üìÑ Read Transcript</button>
    </div>

    <!-- BIKE MODE PLAYER -->
    <div class="waypoint-player" id="bikePlayer">
        <div class="bp-swipe-hint">‚óÄ swipe left = previous &nbsp;|&nbsp; swipe right = skip ‚ñ∂</div>
        <div class="bp-main">
            <button class="bp-nav-btn" onclick="playerPrev()">‚èÆ</button>
            <div class="bp-center">
                <div class="bp-title" id="bikeTitle">Location Name</div>
                <div class="bp-status"><span class="bp-blink" id="bikeBlink"></span><span id="bikeSubtitle">Playing...</span></div>
                <button id="bikePauseBtn" onclick="playerWaypointPause()" style="margin-top:6px; background:rgba(255,255,255,0.2); border:2px solid rgba(255,255,255,0.5); color:white; border-radius:16px; padding:5px 18px; font-size:0.8rem; font-weight:700; cursor:pointer; width:100%;">‚è∏ Pause</button>
            </div>
            <button class="bp-nav-btn" onclick="playerSkip()">‚è≠</button>
        </div>
    </div>

    <!-- CAR MODE PLAYER -->
    <div class="waypoint-player" id="carPlayer">
        <div class="cp-hazard-banner">‚ö†Ô∏è WAYPOINT AHEAD ‚Äî PUT ON HAZARDS &amp; PULL OVER SAFELY</div>
        <div class="cp-row">
            <div class="cp-info">
                <div class="cp-label" id="carLabel">NOW PLAYING</div>
                <div class="cp-title" id="carTitle">Location Name</div>
                <div class="cp-upcoming" id="carUpcoming"></div>
            </div>
            <div class="cp-status-dot" id="carDot"></div>
        </div>
        <div class="cp-controls">
            <button class="cp-btn" onclick="playerPrev()">‚èÆ<br><span style="font-size:0.75rem;font-weight:400">Previous</span></button>
            <button class="cp-btn" id="carPauseBtn" onclick="playerWaypointPause()">‚è∏<br><span style="font-size:0.75rem;font-weight:400">Pause</span></button>
            <button class="cp-btn" onclick="playerReplay()">üîÅ<br><span style="font-size:0.75rem;font-weight:400">Replay</span></button>
            <button class="cp-btn" onclick="playerSkip()">‚è≠<br><span style="font-size:0.75rem;font-weight:400">Skip</span></button>
            <button class="cp-btn" onclick="playerDismiss()" style="background:rgba(255,255,255,0.06);border-color:rgba(255,255,255,0.15)">‚úï<br><span style="font-size:0.75rem;font-weight:400">Dismiss</span></button>
        </div>
        <div class="cp-dismiss" onclick="playerDismiss()">tap to dismiss</div>
    </div>
<div id="backgroundAudioPlayer" style="display:none;">
    <!-- Minimized pill -->
    <div id="bgPlayerPill" onclick="toggleBgPlayer()" style="position:fixed; bottom:24px; right:16px; background:linear-gradient(135deg,#2c3e50,#34495e); color:white; border-radius:30px; padding:10px 14px; z-index:2600; box-shadow:0 4px 16px rgba(0,0,0,0.4); display:flex; align-items:center; gap:10px; cursor:pointer; min-width:160px; max-width:220px;">
        <button id="pillPlayPauseBtn" onclick="event.stopPropagation(); togglePlayPause()" style="background:linear-gradient(135deg,#3498db,#2ecc71); border:none; color:white; width:34px; height:34px; border-radius:50%; cursor:pointer; font-size:1rem; display:flex; align-items:center; justify-content:center; flex-shrink:0; box-shadow:0 2px 6px rgba(52,152,219,0.4);">‚è∏Ô∏è</button>
        <div style="flex:1; overflow:hidden; min-width:0;">
            <div style="font-size:0.62rem; opacity:0.6; text-transform:uppercase; letter-spacing:0.5px;">üéß History Tour</div>
            <div id="pillChapter" style="font-size:0.78rem; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Chapter 1</div>
        </div>
        <span id="bgExpandIcon" style="font-size:0.75rem; opacity:0.6; flex-shrink:0;">‚ñ≤</span>
    </div>

    <!-- Expanded panel -->
    <div id="bgPlayerExpanded" style="position:fixed; bottom:80px; right:16px; background:linear-gradient(135deg,#2c3e50,#34495e); color:white; border-radius:20px; padding:16px 18px; z-index:2500; box-shadow:0 8px 24px rgba(0,0,0,0.4); width:min(320px,calc(100vw - 32px)); display:none;">
        <div style="text-align:center; margin-bottom:10px;">
            <div style="font-size:0.7rem; opacity:0.6; margin-bottom:2px;">üéß MILL CREEK HISTORY TOUR</div>
            <div id="playerChapter" style="font-weight:700; font-size:0.9rem; line-height:1.3;">Chapter 1: Welcome to Mill Creek</div>
        </div>
        <div style="margin-bottom:12px;">
            <div id="progressBar" onclick="seekAudio(event)" style="width:100%; height:6px; background:rgba(255,255,255,0.2); border-radius:3px; cursor:pointer; position:relative;">
                <div id="progressFill" style="width:0%; height:100%; background:linear-gradient(90deg,#3498db,#2ecc71); border-radius:3px; transition:width 0.1s;"></div>
                <div id="progressHandle" style="position:absolute; top:50%; right:0; transform:translate(50%,-50%); width:12px; height:12px; background:white; border-radius:50%; box-shadow:0 2px 4px rgba(0,0,0,0.3);"></div>
            </div>
            <div id="timeDisplay" style="display:flex; justify-content:space-between; margin-top:4px; font-size:0.68rem; opacity:0.7;">
                <span id="currentTime">0:00</span>
                <span id="totalTime">0:00</span>
            </div>
        </div>
        <div style="display:flex; justify-content:center; align-items:center; gap:8px; margin-bottom:12px;">
            <button onclick="previousChapter()" style="background:rgba(255,255,255,0.1); border:none; color:white; width:38px; height:38px; border-radius:50%; cursor:pointer; font-size:1.1rem; display:flex; align-items:center; justify-content:center;">‚èÆÔ∏è</button>
            <button onclick="skipBackward()" style="background:rgba(255,255,255,0.1); border:none; color:white; width:38px; height:38px; border-radius:50%; cursor:pointer; font-size:0.95rem; display:flex; align-items:center; justify-content:center;">‚è™</button>
            <button id="playPauseBtn" onclick="togglePlayPause()" style="background:linear-gradient(135deg,#3498db,#2ecc71); border:none; color:white; width:48px; height:48px; border-radius:50%; cursor:pointer; font-size:1.4rem; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 12px rgba(52,152,219,0.4);">‚è∏Ô∏è</button>
            <button onclick="skipForward()" style="background:rgba(255,255,255,0.1); border:none; color:white; width:38px; height:38px; border-radius:50%; cursor:pointer; font-size:0.95rem; display:flex; align-items:center; justify-content:center;">‚è©</button>
            <button onclick="nextChapter()" style="background:rgba(255,255,255,0.1); border:none; color:white; width:38px; height:38px; border-radius:50%; cursor:pointer; font-size:1.1rem; display:flex; align-items:center; justify-content:center;">‚è≠Ô∏è</button>
        </div>
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px;">
            <span style="font-size:0.85rem;">üîä</span>
            <input type="range" id="volumeSlider" min="0" max="100" value="50" oninput="adjustVolume(this.value)" style="flex:1; height:4px; background:rgba(255,255,255,0.2); border-radius:2px; outline:none; cursor:pointer;">
        </div>
        <button onclick="stopBackgroundTour()" style="background:rgba(231,76,60,0.2); border:1px solid rgba(231,76,60,0.5); color:#e74c3c; padding:7px 14px; border-radius:14px; cursor:pointer; font-size:0.78rem; font-weight:600; width:100%;">‚èπÔ∏è Stop Tour</button>
    </div>
</div>
    </div>
</div>
    <footer>
        <h3>Cruise the Creek</h3>
        <p>Youngstown's Premier eBike Rental & Tours</p>
        <div class="support-section">
            <div class="support-title">‚òï Support the Tour</div>
            <div class="support-subtitle">This audio tour is free forever. If you loved it, buy us a coffee!</div>
            <div class="support-buttons">
                <a href="https://paypal.me/cruisethecreek" class="support-btn paypal" target="_blank">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="white"><path d="M7.076 21.337H2.47a.641.641 0 0 1-.633-.74L4.944.901C5.026.382 5.474 0 5.998 0h7.46c2.57 0 4.578.543 5.69 1.81 1.01 1.15 1.304 2.42 1.012 4.287-.023.143-.047.288-.077.437-.983 5.05-4.349 6.797-8.647 6.797h-2.19c-.524 0-.968.382-1.05.9l-1.12 7.106zm14.146-14.42a3.35 3.35 0 0 0-.607-.541c-.013.076-.026.175-.041.254-.93 4.778-4.005 7.201-9.138 7.201h-2.19a.563.563 0 0 0-.556.479l-1.187 7.527h-.506l-.24 1.516a.56.56 0 0 0 .554.647h3.882c.46 0 .85-.334.922-.788.06-.26.76-4.852.816-5.09a.932.932 0 0 1 .923-.788h.58c3.76 0 6.705-1.528 7.565-5.946.36-1.847.174-3.388-.777-4.471z"/></svg>
                    PayPal
                </a>
                <a href="https://venmo.com/cruisethecreeksales" class="support-btn venmo" target="_blank">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="white"><path d="M19.01 1.01c.56.93.81 1.89.81 3.11 0 3.87-3.3 8.9-5.99 12.43H7.68L5.09 2.03l6.07-.58 1.35 10.83c1.26-2.1 2.82-5.4 2.82-7.65 0-1.23-.21-2.07-.54-2.76l4.22-.86z"/></svg>
                    Venmo
                </a>
                <a href="https://cash.app/$ctcsales" class="support-btn cashapp" target="_blank">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="white"><path d="M23.59 3.48A11.96 11.96 0 0 0 20.52.41C18.94-.04 16.72 0 12 0S5.06-.04 3.48.41A11.96 11.96 0 0 0 .41 3.48C-.04 5.06 0 7.28 0 12s-.04 6.94.41 8.52a11.96 11.96 0 0 0 3.07 3.07C5.06 24.04 7.28 24 12 24s6.94.04 8.52-.41a11.96 11.96 0 0 0 3.07-3.07C24.04 18.94 24 16.72 24 12s.04-5.06-.41-8.52zM14.78 17.1l-.42 1.27a.45.45 0 0 1-.43.31h-.02a4.67 4.67 0 0 1-2.95-1.2l-.92.92a.45.45 0 0 1-.64 0l-.57-.57a.45.45 0 0 1 0-.64l.9-.9a4.68 4.68 0 0 1-.96-2.15.45.45 0 0 1 .44-.52h1.33c.22 0 .41.16.44.38.1.64.38 1.17.77 1.55l1.98-1.98c-.85-.44-2.59-1.01-2.59-2.74 0-1.37 1.01-2.51 2.48-2.84V7.6a.45.45 0 0 1 .45-.45h.8a.45.45 0 0 1 .45.45v.4c.77.13 1.45.46 1.96.95a.45.45 0 0 1 .01.64l-.9.9a.45.45 0 0 1-.6.02 2.1 2.1 0 0 0-1.35-.48l-1.74 1.74c.82.42 2.62.99 2.62 2.84 0 1.44-1.06 2.63-2.53 2.94v.43a.45.45 0 0 1-.45.45h-.8a.45.45 0 0 1-.45-.45v-.37a4.7 4.7 0 0 1-2.27-1.14.45.45 0 0 1-.01-.64l.9-.9a.45.45 0 0 1 .62-.01c.42.38.95.62 1.54.68l1.82-1.82c-.04-.02-.07-.04-.11-.05z"/></svg>
                    Cash App
                </a>
            </div>
        </div>
        <p style="margin-top: 15px; font-size: 0.85rem;">üìç Mill Creek MetroParks, Youngstown, Ohio</p>
    </footer>

    <!-- Error Handlers -->
    <script>
        window.gm_authFailure = function() {
            console.error('‚ùå Google Maps auth failed');
            document.getElementById('loadingOverlay').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">üîë</div>
                    <div style="font-size: 1.2rem; color: #e74c3c; margin-bottom: 15px; font-weight: 700;">Google Maps API Key Error</div>
                    <div style="font-size: 0.9rem; color: #666;">The API key is invalid or restricted.</div>
                </div>
            `;
        };

        setTimeout(function() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay && !loadingOverlay.classList.contains('hide')) {
                console.error('‚ùå Map timeout');
                loadingOverlay.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">‚è±Ô∏è</div>
                        <div style="font-size: 1.2rem; color: #e74c3c; margin-bottom: 15px; font-weight: 700;">Loading Timeout</div>
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 20px;">The map is taking too long to load.</div>
                        <button onclick="location.reload()" style="background: #6B8E6F; color: white; border: none; padding: 12px 30px; border-radius: 25px; font-size: 1rem; font-weight: 700; cursor: pointer;">Retry</button>
                    </div>
                `;
            }
        }, 15000);
    </script>
    
    <!-- Google Maps Script -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDnrKBrEm5DYZtYb4o66Pvyjx_aYUlmrHU&callback=initMap&libraries=marker,places,geometry&v=weekly"></script>

    <!-- Main Script -->
    <script>
        console.log('üìú Script loaded');
        
        if (window.self !== window.top) {
            console.log('üîÑ Redirecting from iframe...');
            window.top.location.href = "https://cruisethecreek-tech.github.io/Adventure-Map/";
        }

        let map, markers = [], infoWindow, parkBoundary = null, boundaryVisible = false, currentRouteMode = 'trail';
        let watchId = null, audioEnabled = false, gpsInitialized = false, batteryMode = false, proximityReady = false;
        let spokenLocations = new Set(), userMarker = null;
        let lastBoundaryWarning = 0, isInsidePark = true, hasLeftPark = false;
        let currentAudio = null, backgroundAudio = null, isPlayingWaypoint = false, currentChapterIndex = 0;
        let playbackGen = 0; // incremented on every stop/skip ‚Äî stale callbacks check this
        let waypointQueue = [];
        let waypointHistory = []; // stack of spots already played
        let lastPlayedSpot = null; // current/most recent spot

        let BACKGROUND_AUDIO_VOLUME = 0.5;
let WAYPOINT_AUDIO_VOLUME = 1.0;

        // FIXED: Updated with waypoints/ prefix
        const CHAPTER_URLS = [
    "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/background/Cap%20Cut%20Chapter%201.MP3",
    "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/background/Cap%20Cut%20Chapter%202%20edit.MP3",
    "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/background/Cap%20Cut%20Chapter%203.MP3",
    "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/background/Cap%20Cut%20Chapter%204.MP3",
    "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/background/Cap%20Cut%20Chapter%205.MP3",
    "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/background/Cap%20Cut%20Final.MP3"
];

        const CHAPTER_NAMES = [
            "Welcome to Mill Creek",
            "Nature & Geology",
            "Community & Recreation",
            "Art & Architecture",
            "Modern Conservation - Part 1",
            "Modern Conservation - Part 2"
        ];

        // Wake Lock ‚Äî keeps screen on during active tour (when supported)
        let wakeLock = null;
        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('üîí Wake lock active ‚Äî screen stays on');
                    wakeLock.addEventListener('release', () => {
                        console.log('üîì Wake lock released');
                        wakeLock = null;
                    });
                } catch (err) {
                    console.warn('Wake lock not available:', err.message);
                }
            }
        }

        async function reacquireWakeLock() {
            if ('wakeLock' in navigator && audioEnabled && !wakeLock) {
                await requestWakeLock();
            }
        }

        document.addEventListener('visibilitychange', async function() {
            if (document.hidden) {
                console.log('üì± Screen off ‚Äî audio continues in background');
                // Audio continues naturally ‚Äî no action needed
                // Wake lock auto-releases when screen locks; we reacquire on return
            } else {
                console.log('üì± Screen on ‚Äî checking audio state');
                // Reacquire wake lock when user returns to screen
                await reacquireWakeLock();
                // If waypoint was playing and got interrupted, nudge it back
                if (currentAudio && currentAudio.paused && !waypointPaused) {
                    currentAudio.play().catch(() => {});
                }
                // If background audio should be playing but isn't
                if (backgroundAudio && backgroundAudio.paused && !isPlayingWaypoint && audioEnabled) {
                    backgroundAudio.play().catch(() => {});
                }
            }
        });

        /* ============================================================
           ONBOARDING
        ============================================================ */
        let obCurrentStep = 0;
        const OB_TOTAL = 4;
        const userPrefs = { interests: [], level: 'moderate' };

        function togglePref(el, group) {
            if (group === 'level') {
                // single-select for level
                document.querySelectorAll('#prefLevel .ob-pref-chip').forEach(c => c.classList.remove('selected'));
                el.classList.add('selected');
                userPrefs.level = el.dataset.pref;
            } else {
                // multi-select for interests
                el.classList.toggle('selected');
                const val = el.dataset.pref;
                const idx = userPrefs.interests.indexOf(val);
                if (idx === -1) userPrefs.interests.push(val);
                else userPrefs.interests.splice(idx, 1);
            }
        }

        function onboardingNext() {
            obCurrentStep++;
            if (obCurrentStep >= OB_TOTAL) { dismissOnboarding(); return; }
            for (let i = 0; i < OB_TOTAL; i++) {
                const s = document.getElementById('obStep' + i);
                const d = document.getElementById('obDot' + i);
                if (s) s.style.display = i === obCurrentStep ? (i === 3 ? 'block' : 'flex') : 'none';
                if (d) d.classList.toggle('active', i === obCurrentStep);
            }
            const btn = document.getElementById('obNextBtn');
            if (btn) btn.textContent = obCurrentStep === OB_TOTAL - 1 ? "Let's Go! üö¥" : "Next ‚Üí";
        }

        function dismissOnboarding() {
            const el = document.getElementById('onboardingOverlay');
            if (!el) return;
            el.classList.add('fade-out');
            localStorage.setItem('ctc_onboarded', '1');
            localStorage.setItem('ctc_prefs', JSON.stringify(userPrefs));
            applyPersonalization();
            setTimeout(() => el.remove(), 650);
            checkAudioUnlockNeeded();
            fetchWeather();
        }

        // Load saved prefs for returning users
        function loadSavedPrefs() {
            const saved = localStorage.getItem('ctc_prefs');
            if (saved) {
                try {
                    const p = JSON.parse(saved);
                    if (p.interests) userPrefs.interests = p.interests;
                    if (p.level) userPrefs.level = p.level;
                } catch(e) {}
            }
        }

        // Skip onboarding for returning users
        if (localStorage.getItem('ctc_onboarded')) {
            const el = document.getElementById('onboardingOverlay');
            if (el) el.remove();
            loadSavedPrefs();
            fetchWeather();
        }

        /* ============================================================
           WEATHER ‚Äî Open-Meteo (free, no API key)
           Mill Creek Park coords: 41.0724, -80.6918
        ============================================================ */
        const PARK_LAT = 41.0724, PARK_LNG = -80.6918;
        let weatherData = null;

        async function fetchWeather() {
            try {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${PARK_LAT}&longitude=${PARK_LNG}&current=temperature_2m,apparent_temperature,precipitation,weathercode,windspeed_10m,relativehumidity_2m&temperature_unit=fahrenheit&windspeed_unit=mph&precipitation_unit=inch&timezone=America/New_York`;
                const res = await fetch(url);
                const data = await res.json();
                weatherData = data.current;
                updateWeatherUI(data.current);
            } catch(e) {
                console.warn('Weather fetch failed:', e);
            }
        }

        const WMO_CODES = {
            0:  { icon:'‚òÄÔ∏è',  desc:'Clear sky' },
            1:  { icon:'üå§',  desc:'Mainly clear' },
            2:  { icon:'‚õÖ',  desc:'Partly cloudy' },
            3:  { icon:'‚òÅÔ∏è',  desc:'Overcast' },
            45: { icon:'üå´',  desc:'Foggy' },
            48: { icon:'üå´',  desc:'Icy fog' },
            51: { icon:'üå¶',  desc:'Light drizzle' },
            53: { icon:'üå¶',  desc:'Drizzle' },
            55: { icon:'üåß',  desc:'Heavy drizzle' },
            61: { icon:'üåß',  desc:'Light rain' },
            63: { icon:'üåß',  desc:'Rain' },
            65: { icon:'üåß',  desc:'Heavy rain' },
            71: { icon:'üå®',  desc:'Light snow' },
            73: { icon:'‚ùÑÔ∏è',  desc:'Snow' },
            75: { icon:'‚ùÑÔ∏è',  desc:'Heavy snow' },
            77: { icon:'üå®',  desc:'Snow grains' },
            80: { icon:'üå¶',  desc:'Light showers' },
            81: { icon:'üåß',  desc:'Showers' },
            82: { icon:'‚õà',  desc:'Heavy showers' },
            85: { icon:'üå®',  desc:'Snow showers' },
            95: { icon:'‚õà',  desc:'Thunderstorm' },
            99: { icon:'‚õà',  desc:'Severe thunderstorm' },
        };

        // Context-aware trail tips based on weather + personalization
        const WEATHER_TIPS = {
            rain: [
                { icon:'üíß', text:"Lanterman's Falls is <strong>spectacular in rain</strong> ‚Äî the gorge roars to life. One of the best times to visit." },
                { icon:'üåø', text:'Wet conditions make the <strong>hemlock gorge trails</strong> feel like a rainforest. Bring waterproof shoes.' },
                { icon:'‚ö†Ô∏è', text:'<strong>Avoid steep trails</strong> like Grotto Falls steps ‚Äî rocks get slippery. Stick to paved routes.' },
                { icon:'üì∏', text:'Rain creates <strong>incredible photography</strong> ‚Äî fog in the gorge, reflections in the creek, moody light.' },
            ],
            cold: [
                { icon:'‚ùÑÔ∏è', text:'Cold days mean <strong>fewer crowds</strong> ‚Äî you may have the gorge to yourself. Dress in layers.' },
                { icon:'üå≤', text:'Winter reveals the <strong>park\'s geological bones</strong> ‚Äî sandstone cliffs and creek formations hidden by leaves are fully visible.' },
                { icon:'‚ö†Ô∏è', text:'<strong>Ice possible on shaded trails</strong> after freezing temps. The paved Kirk Road Bikeway stays safer.' },
            ],
            hot: [
                { icon:'üí¶', text:'Hot day? <strong>Scholl, Wick, and Fellows Pavilions</strong> all have free spray basins and splash pads.' },
                { icon:'üå≤', text:'The <strong>hemlock gorge stays 10-15¬∞ cooler</strong> than the rest of the park thanks to the tree canopy. Head there first.' },
                { icon:'‚è∞', text:'Ride <strong>early morning</strong> for the best experience ‚Äî trails are shaded and wildlife is most active before 10am.' },
            ],
            clear: [
                { icon:'üì∏', text:'Perfect day for <strong>Ford Nature Center trail</strong> ‚Äî golden light through the hemlocks is stunning on clear days.' },
                { icon:'üåÖ', text:'Clear conditions = ideal for <strong>elevated viewpoints</strong> like Lanterman\'s Viewpoint and Chestnut Hill Pavilion.' },
                { icon:'ü¶Ö', text:'Keep an eye out for <strong>great blue herons and osprey</strong> ‚Äî they\'re most visible in clear weather along the creek.' },
            ],
            fog: [
                { icon:'üå´', text:'Fog transforms <strong>Lanterman\'s Gorge into something magical</strong> ‚Äî the mist hanging over the falls is unforgettable.' },
                { icon:'üì∏', text:'The <strong>covered bridge</strong> in fog is one of the most photographed views in the park. Don\'t miss it.' },
            ],
            wind: [
                { icon:'üå¨', text:'Windy day ‚Äî <strong>avoid tall tree canopy trails</strong> in case of falling branches. Paved routes are safest.' },
                { icon:'üö¥', text:'Headwind heading south on East Cohasset. <strong>Start south, finish north</strong> for an easier return ride.' },
            ]
        };

        function getWeatherCategory(code, temp, wind) {
            if (code >= 95) return 'rain';
            if (code >= 51 && code <= 82) return 'rain';
            if (code >= 71 && code <= 85) return 'cold';
            if (code === 45 || code === 48) return 'fog';
            if (wind > 20) return 'wind';
            if (temp < 40) return 'cold';
            if (temp > 82) return 'hot';
            return 'clear';
        }

        function updateWeatherUI(w) {
            const code = w.weathercode;
            const temp = Math.round(w.temperature_2m);
            const feels = Math.round(w.apparent_temperature);
            const wind = Math.round(w.windspeed_10m);
            const humidity = Math.round(w.relativehumidity_2m);
            const wmo = WMO_CODES[code] || { icon:'üå§', desc:'Partly cloudy' };
            const category = getWeatherCategory(code, temp, wind);
            const tips = WEATHER_TIPS[category] || WEATHER_TIPS.clear;

            // Banner
            const banner = document.getElementById('weatherBanner');
            const bannerColors = {
                rain: 'linear-gradient(135deg,#1a3a4a,#2c5f7a)',
                cold: 'linear-gradient(135deg,#1a2a3a,#2d4a6a)',
                hot:  'linear-gradient(135deg,#7a3a1a,#b85c1e)',
                clear:'linear-gradient(135deg,#1a3a1a,#2d5a2d)',
                fog:  'linear-gradient(135deg,#2a2a3a,#4a4a6a)',
                wind: 'linear-gradient(135deg,#2a3a1a,#4a6a2d)',
            };
            banner.style.background = bannerColors[category] || bannerColors.clear;
            document.getElementById('wbIcon').textContent = wmo.icon;
            document.getElementById('wbCondition').textContent = wmo.desc;
            document.getElementById('wbTemp').textContent = temp + '¬∞F';
            document.getElementById('wbTip').textContent = tips[0].text.replace(/<[^>]+>/g,'');
            banner.style.display = 'block';

            // Modal
            document.getElementById('wmIcon').textContent = wmo.icon;
            document.getElementById('wmTemp').textContent = temp + '¬∞F';
            document.getElementById('wmDesc').textContent = wmo.desc;
            document.getElementById('wmFeels').textContent = feels + '¬∞F';
            document.getElementById('wmHumidity').textContent = humidity + '%';
            document.getElementById('wmWind').textContent = wind + ' mph';

            // Trail tips
            const tipsEl = document.getElementById('wmTips');
            tipsEl.innerHTML = tips.map(t =>
                `<div class="weather-tip-item"><span>${t.icon}</span><span>${t.text}</span></div>`
            ).join('');
        }

        function openWeatherModal() {
            document.getElementById('weatherModal').classList.add('show');
        }

        /* ============================================================
           PERSONALIZATION
        ============================================================ */

        // Tags that map to each interest for scoring
        const INTEREST_TAG_MAP = {
            history:      ['üèõÔ∏è Historic', 'üé¢', 'Historical', 'historic'],
            nature:       ['üå≤', 'üåø', 'ü™® Geology', 'üíß', 'üê¢', 'üåä', 'Natural', 'waterfall', 'trail'],
            family:       ['üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family', 'üí¶ Splash Pad', 'üõù', 'üß∫ Picnic', 'playground'],
            fitness:      ['üö¥ Bike Friendly', '‚ö†Ô∏è Steep', '‚ö†Ô∏è Hilly', '‚ö†Ô∏è Moderate', 'üèÉ'],
            photography:  ['üì∏ Photo Op', 'üì∏ Must See', 'üì∏ Best View', 'üåÑ View', 'üåÖ'],
            geology:      ['ü™® Geology', 'üåä Creek', 'Gorge', 'sandstone', 'Cascade'],
        };

        const LEVEL_FILTERS = {
            beginner: ['üü¢ Easy', 'üü¢ Easy/Flat', '‚ôø Accessible', 'üõ£Ô∏è Paved'],
            moderate: [],  // no filter for moderate ‚Äî see everything
            advanced: ['‚ö†Ô∏è Steep', '‚ö†Ô∏è Hilly', '‚ö†Ô∏è Moderate', '‚ùå No Bikes'],
        };

        // Personalized "why you'll love this" messages
        function getPersonalTip(spot) {
            if (!userPrefs.interests.length) return null;
            const tags = (spot.tags || []).join(' ') + ' ' + (spot.category || '') + ' ' + (spot.name || '');
            const tagsLower = tags.toLowerCase();

            if (userPrefs.interests.includes('history') &&
                (tagsLower.includes('historic') || tagsLower.includes('histor') || spot.category === 'historic')) {
                return 'üèõÔ∏è Matches your interest in history';
            }
            if (userPrefs.interests.includes('photography') &&
                (tags.includes('üì∏') || tags.includes('üåÑ') || tags.includes('View'))) {
                return 'üì∏ Great photography spot based on your interests';
            }
            if (userPrefs.interests.includes('geology') &&
                (tags.includes('ü™®') || tagsLower.includes('gorge') || tagsLower.includes('cascade') || tagsLower.includes('sandstone'))) {
                return 'ü™® Notable geology ‚Äî matches your interests';
            }
            if (userPrefs.interests.includes('family') && tags.includes('üë®‚Äçüë©‚Äçüëß‚Äçüë¶')) {
                return 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family-friendly ‚Äî recommended for your group';
            }
            if (userPrefs.interests.includes('fitness') &&
                (tags.includes('‚ö†Ô∏è') || tags.includes('üö¥ Bike'))) {
                return 'üí™ Challenging spot ‚Äî good for your fitness goals';
            }
            if (userPrefs.interests.includes('nature') && spot.category === 'trail') {
                return 'üåø Natural trail ‚Äî matches your nature interest';
            }
            return null;
        }

        function applyPersonalization() {
            // Highlight recommended markers on the map with a gold ring
            // (visual enhancement ‚Äî markers matching interests get a star badge)
            if (window.markers && userPrefs.interests.length) {
                // Subtle ‚Äî just log for now, visual marker enhancement needs map reinit
                console.log('üéØ Personalization active:', userPrefs);
            }
        }
        let audioContextUnlocked = false;

        function checkAudioUnlockNeeded() {
            const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent);
            if (isIOS && !audioContextUnlocked) {
                document.getElementById('audioUnlockPrompt').style.display = 'block';
            }
        }

        function unlockAudioPrompt() {
            audioContextUnlocked = true;
            document.getElementById('audioUnlockPrompt').style.display = 'none';
            // Create and play a silent buffer to unlock AudioContext
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const buf = ctx.createBuffer(1, 1, 22050);
            const src = ctx.createBufferSource();
            src.buffer = buf;
            src.connect(ctx.destination);
            src.start(0);
            ctx.resume();
        }

        /* ============================================================
           GPS SIGNAL INDICATOR
        ============================================================ */
        let lastGpsTime = null;
        let gpsCheckInterval = null;

        function startGpsMonitor() {
            if (gpsCheckInterval) return;
            gpsCheckInterval = setInterval(() => {
                if (!audioEnabled || !lastGpsTime) return;
                const bar = document.getElementById('gpsSignalBar');
                const wb  = document.getElementById('weatherBanner');
                const elapsed = Date.now() - lastGpsTime;
                if (elapsed > 10000) {
                    bar.textContent = 'üì° GPS signal lost ‚Äî move to an open area';
                    bar.className = '';
                    bar.style.display = 'block';
                    if (wb && wb.style.display !== 'none') wb.style.top = '38px';
                } else if (elapsed > 5000) {
                    bar.textContent = 'üì° GPS signal weak ‚Äî accuracy may be reduced';
                    bar.className = 'weak';
                    bar.style.display = 'block';
                    if (wb && wb.style.display !== 'none') wb.style.top = '38px';
                } else {
                    bar.style.display = 'none';
                    if (wb && wb.style.display !== 'none') wb.style.top = '0';
                }
            }, 3000);
        }

        function recordGpsPing() {
            lastGpsTime = Date.now();
        }

        /* ============================================================
           WAYPOINT PROGRESS COUNTER
        ============================================================ */
        const TOTAL_WAYPOINTS = 63;
        let heardWaypoints = new Set();

        function recordWaypointHeard(spotName) {
            heardWaypoints.add(spotName);
            updateProgressUI();
            if (heardWaypoints.size >= TOTAL_WAYPOINTS) {
                setTimeout(() => showCompletion(), 2000);
            }
        }

        function updateProgressUI() {
            const count = heardWaypoints.size;
            const pct = Math.round((count / TOTAL_WAYPOINTS) * 100);
            document.getElementById('wpCountText').textContent = count + ' / ' + TOTAL_WAYPOINTS;
            document.getElementById('wpBarFill').style.width = pct + '%';
            document.getElementById('rideWaypoints').textContent = count;
        }

        /* ============================================================
           RIDE STATS TIMER
        ============================================================ */
        let rideStartTime = null;
        let rideTimerInterval = null;
        let rideDistanceM = 0;
        let lastRidePos = null;

        function startRideStats() {
            rideStartTime = Date.now();
            document.getElementById('rideStats').style.display = 'block';
            document.getElementById('waypointProgress').style.display = 'block';
            rideTimerInterval = setInterval(updateRideTime, 1000);
        }

        function updateRideTime() {
            if (!rideStartTime) return;
            const elapsed = Math.floor((Date.now() - rideStartTime) / 1000);
            const m = Math.floor(elapsed / 60);
            const s = elapsed % 60;
            document.getElementById('rideTime').textContent = m + ':' + String(s).padStart(2, '0');
        }

        function updateRideDistance(lat, lng) {
            if (lastRidePos) {
                const d = getDistanceFromLatLonInMeters(lastRidePos.lat, lastRidePos.lng, lat, lng);
                if (d < 200) { // ignore GPS jumps
                    rideDistanceM += d;
                    const miles = (rideDistanceM * 0.000621371).toFixed(1);
                    document.getElementById('rideDistance').textContent = miles + ' mi';
                }
            }
            lastRidePos = { lat, lng };
        }

        /* ============================================================
           TRANSCRIPT
        ============================================================ */
        function showTranscript() {
            if (!lastPlayedSpot) return;
            document.getElementById('transcriptTitle').textContent = lastPlayedSpot.name;
            document.getElementById('transcriptText').textContent =
                lastPlayedSpot.desc || lastPlayedSpot.shortDesc || 'No transcript available for this location.';
            document.getElementById('transcriptModal').classList.add('show');
        }

        function closeTranscript() {
            document.getElementById('transcriptModal').classList.remove('show');
        }

        /* ============================================================
           COMPLETION CELEBRATION
        ============================================================ */
        function showCompletion() {
            const elapsed = rideStartTime ? Math.floor((Date.now() - rideStartTime) / 1000) : 0;
            const m = Math.floor(elapsed / 60);
            const s = elapsed % 60;
            const miles = (rideDistanceM * 0.000621371).toFixed(1);
            const modeEmoji = { trail:'üö∂', walk:'üö∂', bike:'üö¥', car:'üöó' };
            document.getElementById('ccTime').textContent = m + ':' + String(s).padStart(2, '0');
            document.getElementById('ccDist').textContent = miles + ' mi';
            document.getElementById('ccMode').textContent = modeEmoji[currentRouteMode] || 'üö¥';
            document.getElementById('completionModal').classList.add('show');
            launchConfetti();
        }

        function launchConfetti() {
            const colors = ['#D68438','#FFD700','#6B8E6F','#fff','#e74c3c','#3498db'];
            for (let i = 0; i < 60; i++) {
                setTimeout(() => {
                    const el = document.createElement('div');
                    el.className = 'confetti-piece';
                    el.style.left = Math.random() * 100 + 'vw';
                    el.style.background = colors[Math.floor(Math.random() * colors.length)];
                    el.style.animationDuration = (2 + Math.random() * 2) + 's';
                    el.style.animationDelay = '0s';
                    document.body.appendChild(el);
                    setTimeout(() => el.remove(), 5000);
                }, i * 60);
            }
        }

        function shareCompletion() {
            const elapsed = rideStartTime ? Math.floor((Date.now() - rideStartTime) / 1000) : 0;
            const m = Math.floor(elapsed / 60);
            const miles = (rideDistanceM * 0.000621371).toFixed(1);
            const text = `üèÜ Just completed the full Mill Creek Audio Tour! 63 waypoints, ${miles} miles, ${m} minutes on trail. Try it at cruisethecreek.com/maps üö¥ #CruiseTheCreek #MillCreekPark #Youngstown`;
            if (navigator.share) {
                navigator.share({ title: 'Mill Creek Tour Complete!', text });
            } else {
                navigator.clipboard.writeText(text).then(() => alert('Copied to clipboard! Paste it anywhere to share.'));
            }
        }

        function toggleAccordion(btn) {
            const content = btn.nextElementSibling;
            const parent = btn.parentElement;
            content.classList.toggle('active');
            btn.classList.toggle('active');
            parent.classList.toggle('active');
            if (content.classList.contains('active')) {
                content.style.maxHeight = content.scrollHeight + "px";
            } else {
                content.style.maxHeight = "0";
            }
        }

        // COMPLETE 63 LOCATIONS WITH FIXED AUDIO URLS
        const locations = [
    {
        name: "Cruise The Creek",
        category: "amenity", icon: "üö≤",
        lat: 41.0720801, lng: -80.6918451,
        triggerRadius: { walk: 50, bike: 50, car: 30, trail: 50 },
        tags: ["üèÅ Start Here", "üÖøÔ∏è Parking", "‚ÑπÔ∏è Info"],
        time: "0 mins",
        shortDesc: "Your starting point for an eBike adventure through Mill Creek Park! Over 8,000 riders served since 2022.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/1.%20Cruise%20The%20Creek%20%E2%80%94%20eBike%20Rentals.mp3",
        desc: "Welcome to Cruise the Creek ‚Äî your gateway to one of the most beautiful urban parks in America..."
    },
    {
        name: "Mill Creek Metro Park",
        category: "nature", icon: "üå≥",
        lat: 41.0862413, lng: -80.6926274,
        tags: ["üå≤ Scenic", "üì∏ Photo Op"],
        time: "Explore All Day",
        shortDesc: "Ohio's first park district ‚Äî 2,658 acres of hemlock gorges, waterfalls, and historic landmarks, founded 1891.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/2.%20Mill%20Creek%20Metro%20Park%20%E2%80%94%20Main%20Entrance.mp3",
        desc: "You are entering one of the most remarkable urban parks in the entire United States..."
    },
    {
        name: "Wick Pavilion & Wet Playground",
        category: "playground", icon: "üõù",
        lat: 41.0880, lng: -80.6950,
        tags: ["üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family", "üí¶ Splash Pad", "üöΩ Restroom"],
        time: "30-60 mins",
        shortDesc: "Olmsted Brothers-designed recreation area with wet playground, spray basin, and full facilities.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/8.%20Wick%20Pavilion%20%26%20Wet%20Playground.mp3",
        desc: "Welcome to the James L. Wick Jr. Recreation Area..."
    },
    {
        name: "Scholl Pavilion & Spray Basin",
        category: "playground", icon: "üõù",
        lat: 41.072938, lng: -80.691662,
        tags: ["üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family", "üí¶ Splash Pad", "üß∫ Picnic"],
        time: "30 mins",
        shortDesc: "West-side recreation area with free spray basin and picnic pavilion.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/9.%20Scholl%20Pavilion%20%26%20Spray%20Basin.mp3",
        desc: "You are at Scholl Recreation Area, a beloved neighborhood anchor..."
    },
    {
        name: "Stitt Pavilion Playground",
        category: "playground", icon: "üõù",
        lat: 41.042166, lng: -80.688019,
        tags: ["üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family", "üß∫ Picnic"],
        time: "20 mins",
        shortDesc: "South-side family pavilion with playground.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/10.%20Stitt%20Pavilion%20Playground.mp3",
        desc: "You are at Stitt Pavilion, one of the park's southern recreational anchors..."
    },
    {
        name: "Chestnut Hill Pavilion Playground",
        category: "playground", icon: "üõù",
        lat: 41.070382, lng: -80.690256,
        triggerRadius: { walk: 80, bike: 80, car: 30, trail: 80 },
        tags: ["üåÑ View", "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family"],
        time: "20 mins",
        shortDesc: "Hilltop pavilion with elevated views over the parkland.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/11.%20Chestnut%20Hill%20Pavilion%20Playground.mp3",
        desc: "You are at Chestnut Hill Pavilion..."
    },
    {
        name: "Slippery Rock Pavilion Playground",
        category: "playground", icon: "üõù",
        lat: 41.086735, lng: -80.675000,
        tags: ["üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family", "üß∫ Picnic"],
        time: "30 mins",
        shortDesc: "East-side pavilion named for smooth sandstone outcroppings.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/12.%20Slippery%20Rock%20Pavilion%20Playground.mp3",
        desc: "You are at Slippery Rock Pavilion on the park's eastern edge..."
    },
    {
        name: "Volney Rogers Field Playground",
        category: "playground", icon: "üõù",
        lat: 41.0961547, lng: -80.6732859,
        tags: ["‚öΩ Sports", "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family"],
        time: "30 mins",
        shortDesc: "Active recreation area named for the park's founder.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/13.%20Volney%20Rogers%20Field%20Playground.mp3",
        desc: "You are at Volney Rogers Field..."
    },
    {
        name: "Lower Bears Den Playground",
        category: "playground", icon: "üõù",
        lat: 41.0837265, lng: -80.6879262,
        tags: ["üå≤ Wooded", "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family"],
        time: "30 mins",
        shortDesc: "Playground tucked into old sandstone quarry country.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/14.%20Lower%20Bears%20Den%20Playground.mp3",
        desc: "You are at Lower Bears Den..."
    },
    {
        name: "Yellow Creek Park",
        category: "playground", icon: "üõù",
        lat: 41.0380, lng: -80.6440,
        tags: ["üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family", "üåä Creek"],
        time: "45 mins",
        shortDesc: "Southern MetroParks extension along Yellow Creek.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/15.%20Yellow%20Creek%20Park.mp3",
        desc: "You are at Yellow Creek Park..."
    },
    {
        name: "East Gorge Trail",
        category: "trail", icon: "ü•æ",
        lat: 41.0678, lng: -80.6818,
        tags: ["‚ö†Ô∏è Steep Steps", "‚ùå No Bikes", "üì∏ Best View"],
        time: "30-45 mins",
        shortDesc: "Half-mile boardwalk through the gorge ‚Äî the most breathtaking half-mile in Ohio.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/16.%20East%20Gorge%20Trail.mp3",
        desc: "You are at the trailhead of the East Gorge Trail..."
    },
    {
        name: "West Gorge Trail",
        category: "trail", icon: "ü•æ",
        lat: 41.0705, lng: -80.6835,
        tags: ["‚ö†Ô∏è Moderate", "‚ùå No Bikes", "ü™® Geology"],
        time: "45-60 mins",
        shortDesc: "1.2 miles of sandstone outcroppings and hemlock forest.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/17.%20West%20Gorge%20Trail.mp3",
        desc: "The West Gorge Trail is the longer, wilder sibling..."
    },
    {
        name: "Lily Pond Circle Trail",
        category: "trail", icon: "ü•æ",
        lat: 41.0877647, lng: -80.6814132,
        tags: ["üü¢ Easy/Flat", "üê¢ Turtles", "‚ôø Accessible"],
        time: "15-20 mins",
        shortDesc: "Quarter-mile flat accessible loop around a pond that's been beloved since 1896.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/18.%20Lily%20Pond%20Circle%20Trail.mp3",
        desc: "You are at the Lily Pond..."
    },
    {
        name: "East Cohasset Hike & Bike Trail",
        category: "trail", icon: "üö¥",
        lat: 41.0785, lng: -80.6875,
        tags: ["üö¥ Bike Friendly", "üõ£Ô∏è Paved", "‚ö†Ô∏è Hills"],
        time: "20-40 mins",
        shortDesc: "2 miles of paved, car-free trail along Lake Cohasset.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/19.%20East%20Cohasset%20Hike%20%26%20Bike%20Trail.mp3",
        desc: "This is your trail ‚Äî the East Cohasset Hike and Bike Trail..."
    },
    {
        name: "Old Tree Trail",
        category: "trail", icon: "ü•æ",
        lat: 41.0975, lng: -80.6770,
        tags: ["‚ö†Ô∏è Steps", "üåä Lake View"],
        time: "30 mins",
        shortDesc: "Old-growth specimen trees and panoramic Lake Glacier views.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/20.%20Old%20Tree%20Trail.mp3",
        desc: "The Old Tree Trail earns its name..."
    },
    {
        name: "East Glacier Trail",
        category: "trail", icon: "ü•æ",
        lat: 41.0965, lng: -80.6755,
        tags: ["‚ö†Ô∏è Hilly", "üåä Lake Views"],
        time: "30 mins",
        shortDesc: "Lakeside trail past the famous Parapet Bridge.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/21.%20East%20Glacier%20Trail.mp3",
        desc: "The East Glacier Trail runs eight-tenths of a mile..."
    },
    {
        name: "One Way Drive Trail",
        category: "trail", icon: "ü•æ",
        lat: 41.0945, lng: -80.6765,
        tags: ["üì∏ View", "‚ö†Ô∏è Hilly"],
        time: "25 mins",
        shortDesc: "Former park road now a hiking trail.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/22.%20One%20Way%20Drive%20Trail.mp3",
        desc: "The One Way Drive Trail follows the route..."
    },
    {
        name: "Virginia J. Axtmann Nature Trail",
        category: "trail", icon: "ü•æ",
        lat: 41.0875, lng: -80.6820,
        tags: ["üü¢ Easy/Flat", "‚ôø Accessible"],
        time: "10 mins",
        shortDesc: "Barrier-free tenth-mile paved path with nature signage.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/23.%20Virginia%20J.%20Axtmann%20Nature%20Trail.mp3",
        desc: "The Virginia J. Axtmann Nature Trail is a tenth-of-a-mile..."
    },
    {
        name: "Artists' Trail",
        category: "trail", icon: "ü•æ",
        lat: 41.0865, lng: -80.6805,
        tags: ["üü¢ Easy", "üé® Historic"],
        time: "15 mins",
        shortDesc: "Beloved by painters and photographers for 130 years.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/24.%20Artists%27%20Trail.mp3",
        desc: "The Artists' Trail has been drawing painters..."
    },
    {
        name: "Slippery Rock Trail",
        category: "trail", icon: "ü•æ",
        lat: 41.0868, lng: -80.6795,
        tags: ["üåä Creek View", "üü¢ Easy"],
        time: "20 mins",
        shortDesc: "Easy creekside trail named for water-polished sandstone.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/25.%20Slippery%20Rock%20Trail.mp3",
        desc: "The Slippery Rock Trail takes its name..."
    },
    {
        name: "West Cohasset Trail",
        category: "trail", icon: "ü•æ",
        lat: 41.0795, lng: -80.6900,
        tags: ["üå≤ Hemlocks", "‚ö†Ô∏è Moderate"],
        time: "30-40 mins",
        shortDesc: "One mile through the finest hemlock forest in northeast Ohio.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/26.%20West%20Cohasset%20Trail.mp3",
        desc: "The West Cohasset Trail is a mile-long..."
    },
    {
        name: "East Cohasset Trail",
        category: "trail", icon: "ü•æ",
        lat: 41.0775, lng: -80.6860,
        tags: ["üåä Lake View", "‚ö†Ô∏è Moderate"],
        time: "40 mins",
        shortDesc: "1.2 miles along the oldest lake in the park.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/27.%20East%20Cohasset%20Trail.mp3",
        desc: "The East Cohasset Trail is the one-point-two-mile..."
    },
    {
        name: "West Newport Trail",
        category: "trail", icon: "ü•æ",
        lat: 41.0585, lng: -80.6780,
        tags: ["üåä Lake View", "‚ö†Ô∏è Hilly"],
        time: "30-40 mins",
        shortDesc: "Hilly western shore of Lake Newport.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/28.%20West%20Newport%20Trail.mp3",
        desc: "The West Newport Trail gives you a mile..."
    },
    {
        name: "East Newport Hike & Bike Trail",
        category: "trail", icon: "üö¥",
        lat: 41.0600, lng: -80.6750,
        tags: ["üö¥ Bike Friendly", "üõ£Ô∏è Paved", "üü¢ Easy"],
        time: "30 mins",
        shortDesc: "1.75 miles of car-free paved lakeside trail.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/29.%20East%20Newport%20Hike%20%26%20Bike%20Trail.mp3",
        desc: "The East Newport Hike and Bike Trail..."
    },
    {
        name: "Albert E. Davies Wetland Trail",
        category: "trail", icon: "ü•æ",
        lat: 41.0535, lng: -80.6770,
        tags: ["ü¶Ü Wildlife", "üü¢ Flat", "‚ôø Accessible"],
        time: "20 mins",
        shortDesc: "Accessible boardwalk into 40 acres of wetland.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/30.%20Albert%20E.%20Davies%20Wetland%20Trail.mp3",
        desc: "The Albert E. Davies Wetland Trail..."
    },
    {
        name: "East Channel and Islands Trail",
        category: "trail", icon: "ü•æ",
        lat: 41.0545, lng: -80.6755,
        tags: ["üå∏ Flowers", "üü¢ Easy"],
        time: "30 mins",
        shortDesc: "Spring wildflower haven.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/31.%20East%20Channel%20and%20Islands%20Trail.mp3",
        desc: "The East Channel and Islands Trail..."
    },
    {
        name: "West Channel and Islands Trail",
        category: "trail", icon: "ü•æ",
        lat: 41.0525, lng: -80.6730,
        tags: ["üå∏ Flowers", "üü¢ Easy"],
        time: "25 mins",
        shortDesc: "Gentle wetland trail.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/32.%20West%20Channel%20and%20Islands%20Trail.mp3",
        desc: "The West Channel and Islands Trail mirrors..."
    },
    {
        name: "East Golf Hike & Bike Trail",
        category: "trail", icon: "üö¥",
        lat: 41.0480, lng: -80.6850,
        tags: ["üö¥ Bike Friendly", "üõ£Ô∏è Paved", "‚ôø Accessible"],
        time: "30-45 mins",
        shortDesc: "1.5 miles of quiet, accessible paved trail.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/33.%20East%20Golf%20Hike%20%26%20Bike%20Trail.mp3",
        desc: "The East Golf Hike and Bike Trail..."
    },
    {
        name: "Lanterman's Mill",
        category: "waterfall", icon: "üíß",
        lat: 41.0668378, lng: -80.6821128,
        tags: ["üì∏ Must See", "üç¶ Snacks", "üöΩ Restroom", "‚ôø Accessible"],
        time: "45-60 mins",
        shortDesc: "Built 1845, National Register of Historic Places.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/34.%20Lanterman%27s%20Mill.mp3",
        desc: "Stop everything. You are standing at the most iconic..."
    },
    {
        name: "Cascade Gorge Natural Pool",
        category: "waterfall", icon: "üí¶",
        lat: 41.0758765, lng: -80.6921399,
        tags: ["üì∏ Photo Op", "üåä Natural Feature"],
        time: "15 mins",
        shortDesc: "Sandstone plunge pool carved over 12,000 years.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/35.%20Cascade%20Gorge%20Natural%20Pool.mp3",
        desc: "You are at the Cascade Gorge..."
    },
    {
        name: "Waterfall (North)",
        category: "waterfall", icon: "üíß",
        lat: 41.0979944, lng: -80.6745531,
        tags: ["üì∏ Photo Op", "üåä Waterfall"],
        time: "10 mins",
        shortDesc: "Northern park waterfall.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/36.%20Waterfall%20%E2%80%94%20North%20Section.mp3",
        desc: "You are near one of the park's northern waterfalls..."
    },
    {
        name: "Waterfall (Central)",
        category: "waterfall", icon: "üíß",
        lat: 41.0820392, lng: -80.6807151,
        tags: ["üì∏ Photo Op"],
        time: "10 mins",
        shortDesc: "Central gorge waterfall.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/37.%20Waterfall%20%E2%80%94%20Central%20Section.mp3",
        desc: "You are near the central waterfall area..."
    },
    {
        name: "Waterfall (South)",
        category: "waterfall", icon: "üíß",
        lat: 41.0645953, lng: -80.6782687,
        tags: ["üì∏ Photo Op"],
        time: "10 mins",
        shortDesc: "Southern gorge waterfall.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/38.%20Waterfall%20%E2%80%94%20South%20Section.mp3",
        desc: "You are in the vicinity of the southern waterfall..."
    },
    {
        name: "Fellows Riverside Gardens",
        category: "nature", icon: "üå∫",
        lat: 41.1009278, lng: -80.6757521,
        tags: ["üåπ Gardens", "‚òï Cafe", "üöΩ Restroom", "‚ôø Accessible"],
        time: "60-90 mins",
        shortDesc: "Free 12-acre botanical garden with 400,000+ visitors/year.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/39.%20Fellows%20Riverside%20Gardens.mp3",
        desc: "You have arrived at one of Ohio's finest public gardens..."
    },
    {
        name: "Daffodil Meadow",
        category: "nature", icon: "üåº",
        lat: 41.0552994, lng: -80.6765389,
        tags: ["üì∏ Seasonal", "üå∏ Flowers"],
        time: "20 mins",
        shortDesc: "Over 300,000 daffodils bloom mid-April.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/40.%20Daffodil%20Meadow.mp3",
        desc: "In spring, this meadow explodes..."
    },
    {
        name: "Ford Nature Center",
        category: "nature", icon: "ü¶ã",
        lat: 41.085579, lng: -80.678533,
        tags: ["üèõÔ∏è Historic", "‚ÑπÔ∏è Education", "üöΩ Restroom"],
        time: "30-45 mins",
        shortDesc: "1913 stone mansion renovated 2023.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/41.%20Ford%20Nature%20Center.mp3",
        desc: "You are at the Ford Nature Center..."
    },
    {
        name: "Lake Newport",
        category: "nature", icon: "üèûÔ∏è",
        lat: 41.0579891, lng: -80.6767662,
        tags: ["üåä Lake View", "üõ∂ Boating"],
        time: "Varies",
        shortDesc: "Park's largest lake at 60 acres.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/42.%20Lake%20Newport.mp3",
        desc: "Lake Newport is the largest..."
    },
    {
        name: "Newport Wetlands",
        category: "nature", icon: "ü¶Ü",
        lat: 41.0529021, lng: -80.6763854,
        tags: ["ü¶Ü Wildlife", "üì∏ Photo Op"],
        time: "30 mins",
        shortDesc: "Best wildlife viewing in the park.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/43.%20Newport%20Wetlands.mp3",
        desc: "You are at the edge of the Newport Wetlands..."
    },
    {
        name: "Mill Creek Flats",
        category: "nature", icon: "üåæ",
        lat: 41.074500, lng: -80.686500,
        tags: ["‚öΩ Sports", "üü¢ Flat"],
        time: "Varies",
        shortDesc: "Open meadow with big sky and playing fields.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/44.%20Mill%20Creek%20Flats.mp3",
        desc: "You are at Mill Creek Flats..."
    },
    {
        name: "Suspension Bridge",
        category: "historic", icon: "üåâ",
        lat: 41.0732836, lng: -80.6889887,
        tags: ["üì∏ Iconic", "üè∞ Fairytale"],
        time: "15 mins",
        shortDesc: "Built 1895 ‚Äî the Cinderella Bridge.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/45.%20Suspension%20Bridge.mp3",
        desc: "You are looking at the most romantic bridge..."
    },
    {
        name: "Idora Park (Historical)",
        category: "historic", icon: "üé¢",
        lat: 41.0708398, lng: -80.6838387,
        triggerRadius: { walk: 150, bike: 150, car: 150, trail: 150 },
        tags: ["üèõÔ∏è Historic", "üëª Ruins"],
        time: "15 mins",
        shortDesc: "Youngstown's Million Dollar Playground (1899‚Äì1984).",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/46.%20Idora%20Park%20%E2%80%94%20Historical%20Site.mp3",
        desc: "You are standing near the site of Idora Park..."
    },
    {
        name: "Lanterman's Viewpoint",
        category: "historic", icon: "üëÅÔ∏è",
        lat: 41.0669603, lng: -80.6844987,
        triggerRadius: { walk: 80, bike: 80, car: 30, trail: 80 },
        tags: ["üì∏ Best View", "üü¢ Easy Access"],
        time: "10 mins",
        shortDesc: "The best overlook in Mill Creek Park.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/47.%20Lanterman%27s%20Viewpoint.mp3",
        desc: "You are at the Lanterman's Viewpoint..."
    },
    {
        name: "Covered Bridge",
        category: "historic", icon: "üåâ",
        lat: 41.0665675, lng: -80.6813407,
        tags: ["üì∏ Photo Op"],
        time: "10 mins",
        shortDesc: "1989 reproduction of the farmer's bridge.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/48.%20Covered%20Bridge.mp3",
        desc: "The Covered Bridge behind Lanterman's Mill..."
    },
    {
        name: "Volney Rogers Monument",
        category: "historic", icon: "‚ö±Ô∏è",
        lat: 41.0912363, lng: -80.6722574,
        tags: ["üèõÔ∏è Historic"],
        time: "5 mins",
        shortDesc: "Memorial to the park's founder.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/49.%20Volney%20Rogers%20Monument.mp3",
        desc: "You are standing near the Volney Rogers Monument..."
    },
    {
        name: "Old Log Cabin",
        category: "historic", icon: "üèöÔ∏è",
        lat: 41.0985792, lng: -80.6761369,
        tags: ["üèõÔ∏è Historic"],
        time: "10 mins",
        shortDesc: "Built circa 1814.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/50.%20Old%20Log%20Cabin.mp3",
        desc: "The Old Log Cabin on the north shore..."
    },
    {
        name: "Mill Creek Furnace",
        category: "historic", icon: "üè≠",
        lat: 41.082500, lng: -80.679800,
        tags: ["üèõÔ∏è Historic", "üëª Ruins"],
        time: "15 mins",
        shortDesc: "1830s iron furnace ruins.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/51.%20Mill%20Creek%20Furnace.mp3",
        desc: "You are near the ruins of the Mill Creek Furnace..."
    },
    {
        name: "Judge Morley Pavilion",
        category: "historic", icon: "üé≠",
        lat: 41.0857914, lng: -80.6957623,
        tags: ["üéµ Music", "üöΩ Restroom"],
        time: "Varies",
        shortDesc: "Outdoor concert venue in a natural bowl.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/52.%20Judge%20Morley%20Pavilion.mp3",
        desc: "You are at the Judge Morley Pavilion..."
    },
    {
        name: "Hole 55 Bar & Grill",
        category: "dining", icon: "üç¥",
        lat: 41.035800, lng: -80.695800,
        tags: ["üçî Food", "üç∫ Drinks", "üöΩ Restroom"],
        time: "45-60 mins",
        shortDesc: "The only full-service restaurant in the park.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/54.%20Hole%2055%20Bar%20%26%20Grill.mp3",
        desc: "You have found the only full-service restaurant..."
    },
    {
        name: "Mill Creek Golf Course",
        category: "recreation", icon: "‚õ≥",
        lat: 41.0345702, lng: -80.6952989,
        tags: ["‚õ≥ Golf", "üöΩ Restroom"],
        time: "2-4 hours",
        shortDesc: "Donald Ross design, opened 1928.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/55.%20Mill%20Creek%20Golf%20Course.mp3",
        desc: "You are adjacent to the Mill Creek Golf Course..."
    },
    {
        name: "3 Par Golf Course",
        category: "recreation", icon: "‚õ≥",
        lat: 41.085457, lng: -80.692370,
        tags: ["‚õ≥ Golf", "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family"],
        time: "1-2 hours",
        shortDesc: "Family-friendly par-3 course.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/56.%203%20Par%20Golf%20Course.mp3",
        desc: "The 3 Par Golf Course at Wick Recreation Area..."
    },
    {
        name: "Lake Glacier Boating",
        category: "recreation", icon: "‚õµ",
        lat: 41.097517, lng: -80.6778914,
        tags: ["üõ∂ Rentals", "üöΩ Restroom"],
        time: "1 hour",
        shortDesc: "Kayak and pedal boat rentals on 44-acre Lake Glacier.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/57.%20Lake%20Glacier%20Boathouse.mp3",
        desc: "Lake Glacier Boathouse is the northern park's boat rental hub..."
    },
    {
        name: "Lake Newport Boathouse",
        category: "recreation", icon: "üö£",
        lat: 41.0629656, lng: -80.6783145,
        tags: ["üõ∂ Rentals", "üöΩ Restroom"],
        time: "1 hour",
        shortDesc: "Kayak and pedal boat rentals on 60-acre Lake Newport.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/58.%20Lake%20Newport%20Boathouse.mp3",
        desc: "The Lake Newport Boathouse on West Newport Drive..."
    },
    {
        name: "East Newport Boat Launch",
        category: "recreation", icon: "üö§",
        lat: 41.0600601, lng: -80.6741443,
        tags: ["üõ∂ Launch"],
        time: "Varies",
        shortDesc: "Self-launch for personal kayaks and canoes.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/59.%20East%20Newport%20Boat%20Launch.mp3",
        desc: "The East Newport Boat Launch..."
    },
    {
        name: "Mill Creek Police Dept",
        category: "amenity", icon: "üëÆ",
        lat: 41.0917267, lng: -80.671335,
        tags: ["üöë Safety"],
        time: "N/A",
        shortDesc: "Park Police ‚Äî emergency line: 330-702-3000.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/3.%20Mill%20Creek%20Police%20Department.mp3",
        desc: "You are near the Mill Creek Park Police Department..."
    },
    {
        name: "Pioneer Pavilion",
        category: "recreation", icon: "üèõÔ∏è",
        lat: 41.083900, lng: -80.681200,
        tags: ["üéâ Events"],
        time: "N/A",
        shortDesc: "Built 1821 ‚Äî the oldest building in Youngstown.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/53.%20Pioneer%20Pavilion.mp3",
        desc: "Pioneer Pavilion is the oldest building..."
    },
    {
        name: "Birch Hill Cabin",
        category: "amenity", icon: "üè†",
        lat: 41.0867427, lng: -80.6816384,
        tags: ["üéâ Events"],
        time: "N/A",
        shortDesc: "Historic cabin for private rentals.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/4.%20Birch%20Hill%20Cabin.mp3",
        desc: "You are near Birch Hill Cabin..."
    },
    {
        name: "Bears Den Cabin",
        category: "amenity", icon: "üè†",
        lat: 41.0840799, lng: -80.6952423,
        tags: ["üéâ Events"],
        time: "N/A",
        shortDesc: "Rental cabin in old sandstone quarry territory.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/5.%20Bears%20Den%20Cabin.mp3",
        desc: "You are near Bears Den Cabin..."
    },
    {
        name: "Restroom (Newport)",
        category: "amenity", icon: "üöª",
        lat: 41.0520417, lng: -80.6776516,
        tags: ["üöΩ Restroom"],
        time: "N/A",
        shortDesc: "Public restrooms near Lake Newport's south end.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/6.%20Restroom%20%E2%80%94%20Newport%20Area.mp3",
        desc: "You are near the Newport Area restroom facility..."
    },
    {
        name: "Restroom (East Newport)",
        category: "amenity", icon: "üöª",
        lat: 41.060637, lng: -80.6744331,
        tags: ["üöΩ Restroom"],
        time: "N/A",
        shortDesc: "Public restrooms at the East Newport boat launch area.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/7.%20Restroom%20%E2%80%94%20East%20Newport.mp3",
        desc: "You are near the East Newport restroom..."
    },
    {
        name: "Kidston Pavilion",
        category: "recreation", icon: "‚õ∫",
        lat: 41.0986398, lng: -80.6752008,
        tags: ["üéâ Events"],
        time: "N/A",
        shortDesc: "Stunning event venue overlooking the Beeghly Rose Garden.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/60.%20Kidston%20Pavilion.mp3",
        desc: "Kidston Pavilion is one of Mill Creek Park's most beautiful..."
    },
    {
        name: "Cascade Gorge ‚Äî Upper Section",
        lat: 41.074200,
        lng: -80.684000,
        category: "nature",
        icon: "üåä",
        tags: ["üì∏ Photo Op", "ü™® Geology"],
        time: "15 mins",
        shortDesc: "The upper reaches of Cascade Gorge.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/61.%20Cascade%20Gorge%20%E2%80%94%20Upper%20Section.mp3",
        desc: "You have reached the upper section of Cascade Gorge..."
    },
    {
        name: "Lily Pond",
        lat: 41.088084,
        lng: -80.681274,
        category: "nature",
        icon: "üå∏",
        tags: ["ü¶Ü Wildlife", "üì∏ Photo Op"],
        time: "20 mins",
        shortDesc: "A serene natural pond in the northern reaches.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/62.%20Lily%20Pond.mp3",
        desc: "Lily Pond sits in the quieter northern reaches..."
    },
    {
        name: "Mill Creek Gorge ‚Äî Heart of the Park",
        lat: 41.0718,
        lng: -80.6887,
        category: "nature",
        icon: "üèûÔ∏è",
        tags: ["üå≤ Scenic", "üì∏ Best View"],
        time: "30 mins",
        shortDesc: "The scenic heart of Mill Creek Park.",
        audio: "https://pub-1953848c95da4e07b0d7c144edf2c38e.r2.dev/waypoints/63.%20Mill%20Creek%20Gorge%20%E2%80%94%20Heart%20of%20the%20Park.mp3",
        desc: "You are standing at the heart of Mill Creek Park..."
    }
];

        const categories = [
            { id: 'playground', label: 'üõù Playgrounds' },
            { id: 'trail', label: 'ü•æ Trails' },
            { id: 'waterfall', label: 'üíß Waterfalls' },
            { id: 'recreation', label: 'üèÉ Recreation' },
            { id: 'historic', label: 'üèõÔ∏è Historic Sites' },
            { id: 'nature', label: 'üå≥ Nature Spots' },
            { id: 'dining', label: 'üç¥ Dining' },
            { id: 'amenity', label: 'üè† Amenities' }
        ];

        const categoryColors = {
            waterfall: '#4A9EDB',
            recreation: '#D68438',
            historic: '#8B7355',
            nature: '#6B8E6F',
            dining: '#C44536',
            amenity: '#B89968',
            trail: '#27ae60',
            playground: '#e91e63'
        };


         const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        const clearSearchBtn = document.getElementById('clearSearch');

        searchInput.addEventListener('input', handleSearch);
        searchInput.addEventListener('focus', handleSearch);
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-wrapper')) {
                searchResults.classList.remove('active');
            }
        });

        function handleSearch(e) {
            const query = e.target.value.toLowerCase().trim();
            if (query.length === 0) {
                searchResults.classList.remove('active');
                clearSearchBtn.classList.remove('active');
                return;
            }
            clearSearchBtn.classList.add('active');
            const results = locations.filter(loc =>
                loc.name.toLowerCase().includes(query) ||
                loc.category.toLowerCase().includes(query) ||
                loc.desc.toLowerCase().includes(query)
            );
            displaySearchResults(results, query);
        }

        function displaySearchResults(results, query) {
            if (results.length === 0) {
                searchResults.innerHTML = '<div class="no-results">No locations found matching "' + query + '"</div>';
                searchResults.classList.add('active');
                return;
            }
            searchResults.innerHTML = results.map(loc => `
                <div class="search-result-item" onclick="selectLocation(${loc.lat}, ${loc.lng}, '${loc.name.replace(/'/g, "\\'")}')">
                    <span class="search-result-icon">${loc.icon}</span>
                    <div class="search-result-text">
                        <div class="search-result-name">${loc.name}</div>
                        <div class="search-result-category">${loc.category}</div>
                    </div>
                </div>
            `).join('');
            searchResults.classList.add('active');
        }

        function selectLocation(lat, lng, name) {
            searchResults.classList.remove('active');
            map.setCenter({ lat, lng });
            map.setZoom(16);
            const marker = markers.find(m =>
                m.position &&
                Math.abs(m.position.lat - lat) < 0.000001 &&
                Math.abs(m.position.lng - lng) < 0.000001
            );
            if (marker) {
                const locData = locations.find(l => l.name === name);
                if (locData) openInfoWindowForLocation(marker, locData);
            }
            const mapWrapper = document.querySelector('.map-wrapper');
            if (mapWrapper) mapWrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function clearSearch() {
            searchInput.value = '';
            searchResults.classList.remove('active');
            clearSearchBtn.classList.remove('active');
            searchInput.focus();
        }

        function toggleAudioTour() {
            const btn = document.getElementById('startAudioBtn');
            if (!audioEnabled) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        startAudioTourWithGPS(btn, false);
                    },
                    (err) => {
                        console.error("GPS Denied", err);
                        alert("Please enable Location Services to start the tour.");
                    },
                    { enableHighAccuracy: true }
                );
            } else {
                stopAudioTour(true);
            }
        }

        function startAudioTourWithGPS(btn, isInIframe) {
            audioEnabled = true;
            proximityReady = false;
            startGPS();
            requestWakeLock();
            startRideStats();
            startGpsMonitor();
            btn.classList.add('active');
            btn.innerHTML = "üì° GPS Tracking Active";
            btn.style.background = "#27ae60";
            
            document.getElementById('pauseBackgroundBtn').style.display = 'inline-flex';
            document.getElementById('batteryModeBtn').style.display = 'inline-flex';
            
            // 15 second delay before waypoints fire ‚Äî prevents triggering at start location
            setTimeout(() => { proximityReady = true; }, 15000);
            
            showBackgroundAudioPrompt();
        }

       function showBackgroundAudioPrompt() {
    const overlay = document.createElement('div');
    overlay.id = 'audio-start-modal';
    overlay.style.cssText = `position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10000; display: flex; align-items: center; justify-content: center;`;
    
    overlay.innerHTML = `
        <div style="background: white; padding: 40px; border-radius: 20px; text-align: center; max-width: 400px; margin: 20px;">
            <div style="font-size: 64px; margin-bottom: 20px;">üéß</div>
            <h2 style="margin-bottom: 15px; color: #2c3e50;">Enable Audio for Tour</h2>
            <p style="margin-bottom: 25px; color: #666; line-height: 1.6; font-weight: 700; font-size: 1.1rem;">üì± TAP BELOW to unlock audio playback</p>
            <p style="margin-bottom: 25px; color: #666; line-height: 1.6;">Rachel will narrate the 30-minute history of Mill Creek Park as you ride. Audio automatically pauses at landmarks.</p>
            <button id="start-background-btn" style="background: linear-gradient(135deg, #4a6741 0%, #5d7a52 100%); color: white; padding: 15px 40px; border: none; border-radius: 50px; font-size: 18px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 15px rgba(74, 103, 65, 0.3); margin-bottom: 10px; width: 100%;">üéôÔ∏è Start History Tour</button>
            <button id="skip-background-btn" style="background: transparent; color: #666; padding: 10px 20px; border: none; font-size: 14px; cursor: pointer; display: block; margin: 15px auto 0;">Skip (waypoints only)</button>
        </div>
    `;
    
    document.body.appendChild(overlay);
    
    // Create a "dummy" audio object and play it on user gesture to unlock audio
    const unlockAudio = new Audio();
    unlockAudio.src = 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA';
    
    document.getElementById('start-background-btn').addEventListener('click', function() {
        // Play dummy audio to unlock
        unlockAudio.play().then(() => {
            console.log('‚úÖ Audio unlocked');
            
            // PRE-LOAD AND UNLOCK WAYPOINT AUDIO
            const waypointUnlock = new Audio();
            waypointUnlock.src = locations[0].audio;  // First waypoint
            waypointUnlock.volume = 0.01;  // Nearly silent
            waypointUnlock.play().then(() => {
                waypointUnlock.pause();
                console.log('‚úÖ Waypoint audio unlocked');
            }).catch(err => {
                console.warn('‚ö†Ô∏è Waypoint pre-load failed:', err);
            });
            
            // Now start real background audio
            if (!backgroundAudio) {
                backgroundAudio = new Audio();
                backgroundAudio.preload = "auto";
                backgroundAudio.volume = BACKGROUND_AUDIO_VOLUME;
                backgroundAudio.addEventListener('ended', playNextChapter);
                backgroundAudio.src = CHAPTER_URLS[0];
            }
            
            currentChapterIndex = 0;
            backgroundAudio.play().then(() => {
                showChapterNotification(CHAPTER_NAMES[currentChapterIndex]);
                document.getElementById('backgroundAudioPlayer').style.display = 'block';
                updatePlayerChapter();
            }).catch(err => {
                console.error('Background audio error:', err);
                alert('Could not start audio. Try again.');
            });
            
            document.getElementById('audio-start-modal').remove();
        }).catch(err => {
            console.error('Audio unlock failed:', err);
            alert('Please tap again to enable audio.');
        });
    });
    
    document.getElementById('skip-background-btn').addEventListener('click', function() {
        // Still need to unlock audio for waypoints
        unlockAudio.play().then(() => {
            console.log('‚úÖ Audio unlocked (waypoints only)');
            
            // UNLOCK WAYPOINT AUDIO
            const waypointUnlock = new Audio();
            waypointUnlock.src = locations[0].audio;
            waypointUnlock.volume = 0.01;
            waypointUnlock.play().then(() => {
                waypointUnlock.pause();
                console.log('‚úÖ Waypoint audio unlocked');
            }).catch(err => {
                console.warn('‚ö†Ô∏è Waypoint unlock failed:', err);
            });
            
            document.getElementById('audio-start-modal').remove();
        }).catch(err => {
            console.error('Audio unlock failed:', err);
            alert('Please tap again to enable audio.');
        });
    });
}
function updatePlayerDisplay() {
    const chapterEl = document.getElementById('playerChapter');
    if (chapterEl) {
        chapterEl.textContent = CHAPTER_NAMES[currentChapterIndex];
    }
}
        function playNextChapter() {
    currentChapterIndex++;
    if (currentChapterIndex >= CHAPTER_URLS.length) {
        currentChapterIndex = 0;
    }
    backgroundAudio.src = CHAPTER_URLS[currentChapterIndex];
    backgroundAudio.play().then(() => {
        showChapterNotification(CHAPTER_NAMES[currentChapterIndex]);
        updatePlayerChapter();
    }).catch(err => {
        console.error('Chapter playback error:', err);
    });
}

        function showChapterNotification(chapterName) {
            const notification = document.createElement('div');
            notification.className = 'chapter-notification';
            notification.textContent = `üéß ${chapterName}`;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }
function showBackgroundPlayer() {
    document.getElementById('backgroundAudioPlayer').style.display = 'block';
}

function hideBackgroundPlayer() {
    document.getElementById('backgroundAudioPlayer').style.display = 'none';
    document.getElementById('bgPlayerExpanded').style.display = 'none';
}

let bgPlayerExpanded = false;
function toggleBgPlayer() {
    bgPlayerExpanded = !bgPlayerExpanded;
    const expanded = document.getElementById('bgPlayerExpanded');
    const icon = document.getElementById('bgExpandIcon');
    expanded.style.display = bgPlayerExpanded ? 'block' : 'none';
    if (icon) icon.textContent = bgPlayerExpanded ? '‚ñº' : '‚ñ≤';
}

function updateProgress() {
    if (!backgroundAudio || isPlayingWaypoint) return;
    
    const progressFill = document.getElementById('progressFill');
    const progressHandle = document.getElementById('progressHandle');
    const timeDisplay = document.getElementById('timeDisplay');
    
    if (progressFill && backgroundAudio.duration) {
        const percent = (backgroundAudio.currentTime / backgroundAudio.duration) * 100;
        progressFill.style.width = percent + '%';
        
        if (progressHandle) {
            progressHandle.style.left = percent + '%';
        }
    }
    
    if (timeDisplay) {
        const current = formatTime(backgroundAudio.currentTime);
        const total = formatTime(backgroundAudio.duration);
        timeDisplay.textContent = `${current} / ${total}`;
    }
}

function updateDuration() {
    const timeDisplay = document.getElementById('timeDisplay');
    if (timeDisplay && backgroundAudio.duration) {
        const total = formatTime(backgroundAudio.duration);
        timeDisplay.textContent = `0:00 / ${total}`;
    }
}

function formatTime(seconds) {
    if (isNaN(seconds)) return '0:00';
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function seekAudio(event) {
    if (!backgroundAudio || isPlayingWaypoint) return;
    
    const progressBar = document.getElementById('progressBar');
    const rect = progressBar.getBoundingClientRect();
    const percent = (event.clientX - rect.left) / rect.width;
    const newTime = percent * backgroundAudio.duration;
    
    if (!isNaN(newTime)) {
        backgroundAudio.currentTime = newTime;
        updateProgress();
    }
}

function togglePlayPause() {
    if (!backgroundAudio) return;
    const btn = document.getElementById('playPauseBtn');
    const pillBtn = document.getElementById('pillPlayPauseBtn');
    if (backgroundAudio.paused) {
        backgroundAudio.play();
        if (btn) { btn.textContent = '‚è∏Ô∏è'; btn.title = 'Pause'; }
        if (pillBtn) pillBtn.textContent = '‚è∏Ô∏è';
    } else {
        backgroundAudio.pause();
        if (btn) { btn.textContent = '‚ñ∂Ô∏è'; btn.title = 'Play'; }
        if (pillBtn) pillBtn.textContent = '‚ñ∂Ô∏è';
    }
}

function skipForward() {
    if (!backgroundAudio) return;
    backgroundAudio.currentTime = Math.min(backgroundAudio.currentTime + 10, backgroundAudio.duration);
    updateProgress();
}

function skipBackward() {
    if (!backgroundAudio) return;
    backgroundAudio.currentTime = Math.max(backgroundAudio.currentTime - 10, 0);
    updateProgress();
}

function nextChapter() {
    if (!backgroundAudio) return;
    
    currentChapterIndex++;
    if (currentChapterIndex >= CHAPTER_URLS.length) {
        currentChapterIndex = 0;
    }
    
    const wasPlaying = !backgroundAudio.paused;
    backgroundAudio.src = CHAPTER_URLS[currentChapterIndex];
    
    if (wasPlaying) {
        backgroundAudio.play().then(() => {
            showChapterNotification(CHAPTER_NAMES[currentChapterIndex]);
            updatePlayerChapter();
        });
    } else {
        updatePlayerChapter();
    }
}

function previousChapter() {
    if (!backgroundAudio) return;
    
    // If more than 3 seconds into chapter, restart it
    if (backgroundAudio.currentTime > 3) {
        backgroundAudio.currentTime = 0;
        return;
    }
    
    currentChapterIndex--;
    if (currentChapterIndex < 0) {
        currentChapterIndex = CHAPTER_URLS.length - 1;
    }
    
    const wasPlaying = !backgroundAudio.paused;
    backgroundAudio.src = CHAPTER_URLS[currentChapterIndex];
    
    if (wasPlaying) {
        backgroundAudio.play().then(() => {
            showChapterNotification(CHAPTER_NAMES[currentChapterIndex]);
            updatePlayerChapter();
        });
    } else {
        updatePlayerChapter();
    }
}

function updatePlayerChapter() {
    const chapterDisplay = document.getElementById('playerChapter');
    const pillChapter = document.getElementById('pillChapter');
    const chapterText = `Chapter ${currentChapterIndex + 1}: ${CHAPTER_NAMES[currentChapterIndex]}`;
    const pillText = `Ch. ${currentChapterIndex + 1}: ${CHAPTER_NAMES[currentChapterIndex]}`;
    if (chapterDisplay) chapterDisplay.textContent = chapterText;
    if (pillChapter) pillChapter.textContent = pillText;
}

function adjustVolume(value) {
    if (!backgroundAudio) return;
    const volume = value / 100;
    backgroundAudio.volume = volume;
    
    // Update the constant for future audio
    BACKGROUND_AUDIO_VOLUME = volume;
}

function stopBackgroundTour() {
    if (backgroundAudio) {
        backgroundAudio.pause();
        backgroundAudio.currentTime = 0;
    }
    
    hideBackgroundPlayer();
    
    const playPauseBtn = document.getElementById('playPauseBtn');
    if (playPauseBtn) playPauseBtn.textContent = '‚ñ∂Ô∏è';
    const pillBtn = document.getElementById('pillPlayPauseBtn');
    if (pillBtn) pillBtn.textContent = '‚ñ∂Ô∏è';
}
        function toggleBackgroundAudio() {
            const btn = document.getElementById('pauseBackgroundBtn');
            if (backgroundAudio && !backgroundAudio.paused) {
                backgroundAudio.pause();
                btn.innerHTML = '‚ñ∂Ô∏è Resume History Tour';
                btn.style.background = '#27ae60';
            } else if (backgroundAudio) {
                backgroundAudio.play();
                btn.innerHTML = '‚è∏Ô∏è Pause History Tour';
                btn.style.background = '#34495e';
            }
        }

        function toggleBatteryMode() {
            batteryMode = !batteryMode;
            const btn = document.getElementById('batteryModeBtn');
            if (batteryMode) {
                btn.innerHTML = 'üîã Battery Saver ON';
                btn.style.background = '#27ae60';
                if (watchId) {
                    navigator.geolocation.clearWatch(watchId);
                    startGPS();
                }
            } else {
                btn.innerHTML = 'üîã Battery Saver';
                btn.style.background = '#7f8c8d';
                if (watchId) {
                    navigator.geolocation.clearWatch(watchId);
                    startGPS();
                }
            }
        }

        function stopAudioTour(speakGoodbye = true) {
            const btn = document.getElementById('startAudioBtn');
            const pauseBtn = document.getElementById('pauseBackgroundBtn');
            const batteryBtn = document.getElementById('batteryModeBtn');
            
            audioEnabled = false;
            if (backgroundAudio) {
                backgroundAudio.pause();
                backgroundAudio.currentTime = 0;
            }
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio = null;
            }
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            
            btn.classList.remove('active');
            btn.innerHTML = "üéß Start Audio Tour";
            btn.style.background = "var(--accent-orange)";
            pauseBtn.style.display = 'none';
            batteryBtn.style.display = 'none';
            
            if (userMarker) {
                userMarker.map = null;
                userMarker = null;
            }
            const findMeBtn = document.querySelector('.find-me-btn');
            if (findMeBtn) findMeBtn.classList.remove('active');
        }

        function startGPS() {
            if (!navigator.geolocation) { 
                alert("GPS not supported"); 
                return; 
            }
            if (!watchId) {
                const gpsOptions = {
                    enableHighAccuracy: !batteryMode,
                    maximumAge: batteryMode ? 30000 : 0,
                    timeout: batteryMode ? 30000 : 15000
                };
                watchId = navigator.geolocation.watchPosition(
                    updateUserLocation,
                    (err) => { 
                        console.error("GPS Error:", err);
                        alert("Could not get your location. Please ensure location services are enabled."); 
                    },
                    gpsOptions
                );
                const btn = document.querySelector('.find-me-btn');
                if (btn) btn.classList.add('active');
            }
        }

        async function updateUserLocation(position) {
            const userLat = position.coords.latitude;
            const userLng = position.coords.longitude;
            recordGpsPing();
            if (audioEnabled) updateRideDistance(userLat, userLng);
            
            if (!window.google || !window.google.maps) {
                console.warn('Google Maps not loaded yet');
                return;
            }
            
            const { AdvancedMarkerElement, PinElement } = await google.maps.importLibrary("marker");

            if (!gpsInitialized) {
                gpsInitialized = true;
                map.panTo({ lat: userLat, lng: userLng });
                map.setZoom(15);
            }

            if (!userMarker) {
                const userPin = new PinElement({ 
                    background: "#4285F4", 
                    borderColor: "white", 
                    glyph: "", 
                    scale: 0.8 
                });
                userMarker = new AdvancedMarkerElement({
                    map: map,
                    position: { lat: userLat, lng: userLng },
                    title: "You are here",
                    content: userPin.element,
                    zIndex: 1000
                });
            } else {
                userMarker.position = { lat: userLat, lng: userLng };
            }

            if (audioEnabled && proximityReady) {
                checkProximity(userLat, userLng);
            }
        }

        function checkProximity(lat, lng) {
            // Default radius by mode
            const modeDefaults = { trail: 25, walk: 25, bike: 100, car: 125 };
            const mode = currentRouteMode;
            const defaultRadius = modeDefaults[mode] || 25;

            // Category-based radius overrides for trail locations
            // Trails should have tighter radii ‚Äî they run alongside roads and can cross-trigger
            const trailCategoryRadius = { trail: 125, walk: 50, bike: 100, car: 125 };

            locations.forEach(spot => {
                const distance = getDistanceFromLatLonInMeters(lat, lng, spot.lat, spot.lng);

                // Determine trigger radius in priority order:
                // 1. Per-location override  2. Trail category  3. Mode default
                let radius;
                if (spot.triggerRadius && spot.triggerRadius[mode] !== undefined) {
                    radius = spot.triggerRadius[mode];
                } else if (spot.category === 'trail') {
                    radius = trailCategoryRadius[mode] || defaultRadius;
                } else {
                    radius = defaultRadius;
                }

                if (distance < radius && !spokenLocations.has(spot.name)) {
                    triggerHotspot(spot);
                }
            });
            checkParkBoundaries(lat, lng);
        }

        function checkParkBoundaries(lat, lng) {
            if (!parkBoundary) return;
            const userPoint = new google.maps.LatLng(lat, lng);
            const isInside = google.maps.geometry.poly.containsLocation(userPoint, parkBoundary);
            const now = Date.now();
            if (now - lastBoundaryWarning < 45000) return;
            const distanceToBoundary = getDistanceToNearestBoundaryPoint(lat, lng);
            if (isInside && distanceToBoundary < 50) {
                lastBoundaryWarning = now;
                isInsidePark = true;
                showBoundaryWarning("approaching");
            } else if (!isInside && isInsidePark) {
                lastBoundaryWarning = now;
                isInsidePark = false;
                hasLeftPark = true;
                showBoundaryWarning("outside");
            } else if (isInside && hasLeftPark && !isInsidePark) {
                lastBoundaryWarning = now;
                isInsidePark = true;
                hasLeftPark = false;
                showBoundaryWarning("returned");
            }
        }

        function getDistanceToNearestBoundaryPoint(lat, lng) {
            const boundaryPoints = parkBoundary.getPath().getArray();
            let minDistance = Infinity;
            boundaryPoints.forEach(point => {
                const distance = getDistanceFromLatLonInMeters(lat, lng, point.lat(), point.lng());
                if (distance < minDistance) minDistance = distance;
            });
            return minDistance;
        }

        function showBoundaryWarning(type) {
    const popup = document.getElementById('audioPopup');
    const title = document.getElementById('popupTitle');
    
    // VIBRATION ALERT (if supported)
    if (navigator.vibrate) {
        if (type === "approaching") {
            navigator.vibrate([200, 100, 200]); // Two quick buzzes
        } else if (type === "outside") {
            navigator.vibrate([400, 200, 400, 200, 400]); // Strong alert
        } else if (type === "returned") {
            navigator.vibrate(200); // Single buzz
        }
    }
    
    // VISUAL ALERT
    if (type === "approaching") {
        title.innerText = "‚ö†Ô∏è APPROACHING PARK BOUNDARY";
        popup.style.background = "linear-gradient(135deg, #f39c12, #e67e22)";
    } else if (type === "outside") {
        title.innerText = "üö´ OUTSIDE PARK - TURN AROUND!";
        popup.style.background = "linear-gradient(135deg, #e74c3c, #c0392b)";
    } else if (type === "returned") {
        title.innerText = "‚úÖ BACK INSIDE PARK";
        popup.style.background = "linear-gradient(135deg, #27ae60, #229954)";
    }
    
    popup.classList.add('show');
    
    // AUDIO ALERT WITH SPEECH SYNTHESIS (doesn't get blocked)
    if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance();
        utterance.volume = 1.0;
        utterance.rate = 1.1;
        utterance.pitch = 1.0;
        
        if (type === "approaching") {
            utterance.text = "Warning. Approaching park boundary.";
        } else if (type === "outside") {
            utterance.text = "Alert! You are outside the park. Please turn around.";
        } else if (type === "returned") {
            utterance.text = "You are back inside the park.";
        }
        
        // Cancel any ongoing speech and speak
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
    }
    
    // Keep popup visible longer for safety warnings
    setTimeout(() => {
        popup.classList.remove('show');
        popup.style.background = "linear-gradient(135deg, var(--sage-green), var(--dark-sage))";
    }, 10000); // 10 seconds instead of 8
}

        function triggerHotspot(spot) {
            spokenLocations.add(spot.name);
            setTimeout(() => { spokenLocations.delete(spot.name); }, 300000);
            recordWaypointHeard(spot.name);
            waypointQueue.push(spot);
            if (!isPlayingWaypoint) {
                playNextWaypoint();
            }
        }

        /* ============================================================
           MODE-AWARE WAYPOINT PLAYER SYSTEM
        ============================================================ */

        let popupDismissTimer = null;

        function getActivePlayer() {
            if (currentRouteMode === 'bike') return document.getElementById('bikePlayer');
            if (currentRouteMode === 'car')  return document.getElementById('carPlayer');
            return document.getElementById('walkPlayer');
        }

        function hideAllPlayers() {
            ['walkPlayer','bikePlayer','carPlayer'].forEach(id => {
                const el = document.getElementById(id);
                el.classList.remove('show');
                if (id === 'carPlayer') el.classList.remove('hazard-mode');
            });
            if (popupDismissTimer) { clearTimeout(popupDismissTimer); popupDismissTimer = null; }
        }

        function showPlayer(spot, state='playing') {
            hideAllPlayers();
            const nextSpot = waypointQueue[0] || null;

            if (currentRouteMode === 'walk' || currentRouteMode === 'trail') {
                const p = document.getElementById('walkPlayer');
                document.getElementById('walkIcon').textContent = spot.icon || 'üìç';
                document.getElementById('walkTitle').textContent = spot.name;
                document.getElementById('walkDesc').textContent = spot.shortDesc || '';
                document.getElementById('walkSubtitle').textContent =
                    state === 'playing' ? 'üîä Audio Guide Playing' :
                    state === 'finished' ? '‚úÖ Finished' : '‚è≥ Queued';

                // Personalized tip
                const tipEl = document.getElementById('walkPersonalTip');
                if (tipEl) {
                    const tip = getPersonalTip(spot);
                    if (tip) {
                        tipEl.textContent = tip;
                        tipEl.style.display = 'block';
                    } else {
                        tipEl.style.display = 'none';
                    }
                }

                p.classList.add('show');
                if (state === 'finished') {
                    popupDismissTimer = setTimeout(() => hideAllPlayers(), 10000);
                }

            } else if (currentRouteMode === 'bike') {
                const p = document.getElementById('bikePlayer');
                document.getElementById('bikeTitle').textContent = spot.name;
                const blink = document.getElementById('bikeBlink');
                const sub = document.getElementById('bikeSubtitle');
                if (state === 'playing') {
                    blink.style.display = 'inline-block';
                    sub.textContent = 'Playing...';
                } else if (state === 'finished') {
                    blink.style.display = 'none';
                    sub.textContent = nextSpot ? `Next: ${nextSpot.name}` : 'Finished';
                }
                p.classList.add('show');
                if (state === 'finished') {
                    popupDismissTimer = setTimeout(() => hideAllPlayers(), 6000);
                }

            } else if (currentRouteMode === 'car') {
                const p = document.getElementById('carPlayer');
                document.getElementById('carTitle').textContent = spot.name;
                const dot = document.getElementById('carDot');
                const label = document.getElementById('carLabel');
                const upcoming = document.getElementById('carUpcoming');
                if (state === 'hazard') {
                    p.classList.add('hazard-mode');
                    label.textContent = 'APPROACHING';
                    dot.className = 'cp-status-dot';
                    upcoming.textContent = '';
                } else if (state === 'playing') {
                    p.classList.remove('hazard-mode');
                    label.textContent = 'NOW PLAYING';
                    dot.className = 'cp-status-dot playing';
                    upcoming.textContent = nextSpot ? `Up next: ${nextSpot.name}` : '';
                } else if (state === 'finished') {
                    label.textContent = 'FINISHED';
                    dot.className = 'cp-status-dot';
                    upcoming.textContent = nextSpot ? `Up next: ${nextSpot.name}` : '';
                }
                p.classList.add('show');
                // Car mode never auto-dismisses
            }
        }

        // Smoothly fade audio volume up or down
        // direction: 'down' fades to 0 then calls onComplete, 'up' fades from 0 to target
        function fadeAudio(audioEl, direction, duration, onComplete) {
            if (!audioEl) { if (onComplete) onComplete(); return; }
            const steps = 20;
            const interval = duration / steps;
            const target = direction === 'up' ? BACKGROUND_AUDIO_VOLUME : 0;
            const start = audioEl.volume;
            const delta = (target - start) / steps;
            let step = 0;
            const timer = setInterval(() => {
                step++;
                let newVol = start + delta * step;
                newVol = Math.min(1, Math.max(0, newVol));
                audioEl.volume = newVol;
                if (step >= steps) {
                    clearInterval(timer);
                    audioEl.volume = target;
                    if (onComplete) onComplete();
                }
            }, interval);
        }

        function fadeOutBackground(onComplete) {
            if (!backgroundAudio || backgroundAudio.paused) {
                if (onComplete) onComplete();
                return;
            }
            // Car mode: show a gentle heads-up before audio fades
            if (currentRouteMode === 'car') {
                const dot = document.getElementById('carDot');
                const label = document.getElementById('carLabel');
                const carPlayer = document.getElementById('carPlayer');
                if (dot) dot.className = 'cp-status-dot';
                if (label) label.textContent = 'WAYPOINT APPROACHING';
                if (carPlayer) carPlayer.classList.add('show');
            }
            const myGen = playbackGen;
            fadeAudio(backgroundAudio, 'down', 1200, () => {
                if (playbackGen !== myGen) return; // skip was triggered during fade
                backgroundAudio.pause();
                if (onComplete) onComplete();
            });
        }

        function fadeInBackground() {
            if (!backgroundAudio) return;
            backgroundAudio.volume = 0;
            backgroundAudio.play().then(() => {
                fadeAudio(backgroundAudio, 'up', 1500, null);
            }).catch(() => {});
        }

        function stopCurrentAudio() {
            playbackGen++; // invalidate any in-flight onended / setTimeout callbacks
            if (currentAudio) {
                currentAudio.onended = null;
                currentAudio.onerror = null;
                currentAudio.pause();
                currentAudio.src = '';
                currentAudio = null;
            }
            isPlayingWaypoint = false;
        }

        function playerSkip() {
            stopCurrentAudio();
            waypointPaused = false;
            updatePauseButtons(false);
            playNextWaypoint();
        }

        function playerPrev() {
            // If no history to go back to, replay the current waypoint instead
            if (waypointHistory.length < 2) {
                playerReplay();
                return;
            }
            stopCurrentAudio();
            waypointPaused = false;
            updatePauseButtons(false);
            if (lastPlayedSpot) {
                spokenLocations.delete(lastPlayedSpot.name);
                waypointQueue.unshift(lastPlayedSpot);
            }
            waypointHistory.pop();
            const prevSpot = waypointHistory.pop();
            spokenLocations.delete(prevSpot.name);
            waypointQueue.unshift(prevSpot);
            lastPlayedSpot = null;
            playNextWaypoint();
        }

        function playerReplay() {
            if (!lastPlayedSpot) return;
            stopCurrentAudio();
            waypointPaused = false;
            updatePauseButtons(false);
            spokenLocations.delete(lastPlayedSpot.name);
            waypointQueue.unshift(lastPlayedSpot);
            waypointHistory.pop();
            lastPlayedSpot = null;
            playNextWaypoint();
        }

        let waypointPaused = false;
        function playerWaypointPause() {
            if (!currentAudio) return;
            waypointPaused = !waypointPaused;
            if (waypointPaused) {
                currentAudio.pause();
            } else {
                currentAudio.play().catch(() => {});
            }
            updatePauseButtons(waypointPaused);
        }

        function updatePauseButtons(paused) {
            const label = paused ? '‚ñ∂ Resume' : '‚è∏ Pause';
            const icon  = paused ? '‚ñ∂' : '‚è∏';
            const w = document.getElementById('walkPauseBtn');
            const b = document.getElementById('bikePauseBtn');
            const c = document.getElementById('carPauseBtn');
            if (w) w.textContent = label;
            if (b) b.textContent = (paused ? '‚ñ∂ Resume' : '‚è∏ Pause');
            if (c) c.innerHTML = `${icon}<br><span style="font-size:0.75rem;font-weight:400">${paused ? 'Resume' : 'Pause'}</span>`;
        }

        function playerDismiss() {
            stopCurrentAudio();
            waypointQueue = [];
            hideAllPlayers();
            if (backgroundAudio && backgroundAudio.paused) {
                fadeInBackground();
            }
        }

        // Swipe gesture ‚Äî restricted to bike player bar only to avoid map pan conflicts
        let swipeStartX = null;
        let swipeStartY = null;
        const bikePlayerEl = document.getElementById('bikePlayer');

        document.addEventListener('touchstart', e => {
            swipeStartX = e.touches[0].clientX;
            swipeStartY = e.touches[0].clientY;
        }, {passive:true});

        document.addEventListener('touchend', e => {
            if (swipeStartX === null || currentRouteMode !== 'bike') { swipeStartX = null; return; }
            const dx = e.changedTouches[0].clientX - swipeStartX;
            const dy = Math.abs(e.changedTouches[0].clientY - swipeStartY);
            // Only count horizontal swipes (dy < 40 prevents vertical scroll mis-fires)
            if (Math.abs(dx) > 60 && dy < 40) {
                if (dx < 0) playerPrev();  // swipe left = go back
                else playerSkip();          // swipe right = skip forward
            }
            swipeStartX = null;
            swipeStartY = null;
        }, {passive:true});

        function playNextWaypoint() {
            if (waypointQueue.length === 0) {
                isPlayingWaypoint = false;
                if (backgroundAudio && backgroundAudio.paused) {
                    setTimeout(() => { fadeInBackground(); }, 800);
                }
                if (lastPlayedSpot) {
                    showPlayer(lastPlayedSpot, 'finished');
                }
                return;
            }

            const spot = waypointQueue.shift();
            isPlayingWaypoint = true;
            lastPlayedSpot = spot;
            waypointHistory.push(spot); // track history for prev button
            const myGen = playbackGen; // capture generation for this playback session

            if (backgroundAudio && !backgroundAudio.paused) {
                fadeOutBackground(() => {
                    if (playbackGen !== myGen) return; // skip happened during fade
                    if (currentRouteMode === 'car') {
                        showPlayer(spot, 'hazard');
                        setTimeout(() => {
                            if (playbackGen !== myGen) return; // skip happened during hazard delay
                            showPlayer(spot, 'playing');
                            playWaypointAudio(spot);
                        }, 5000);
                    } else {
                        showPlayer(spot, 'playing');
                        playWaypointAudio(spot);
                    }
                });
                return;
            }

            if (currentRouteMode === 'car') {
                showPlayer(spot, 'hazard');
                setTimeout(() => {
                    if (playbackGen !== myGen) return; // skip happened during hazard delay
                    showPlayer(spot, 'playing');
                    playWaypointAudio(spot);
                }, 5000);
            } else {
                showPlayer(spot, 'playing');
                playWaypointAudio(spot);
            }
        }

        function replayCurrentWaypoint() { playerReplay(); }

        function playWaypointAudio(spot) {
            const myGen = playbackGen; // capture at start ‚Äî if it changes, we're stale
            if (!spot.audio) {
                console.warn('No audio:', spot.name);
                setTimeout(() => { if (playbackGen === myGen) playNextWaypoint(); }, 2000);
                return;
            }
            const audio = new Audio();
            audio.crossOrigin = "anonymous";
            audio.preload = "auto";
            audio.volume = WAYPOINT_AUDIO_VOLUME;
            audio.src = spot.audio;
            currentAudio = audio;
            audio.onended = () => {
                if (playbackGen !== myGen) return; // stale ‚Äî a skip/stop happened
                currentAudio = null;
                setTimeout(() => { if (playbackGen === myGen) playNextWaypoint(); }, 1000);
            };
            audio.onerror = () => {
                if (playbackGen !== myGen) return;
                currentAudio = null;
                setTimeout(() => { if (playbackGen === myGen) playNextWaypoint(); }, 1000);
            };
            audio.play().catch((e) => {
                if (playbackGen !== myGen) return;
                console.error('Play failed:', spot.name, e.message);
                currentAudio = null;
                setTimeout(() => { if (playbackGen === myGen) playNextWaypoint(); }, 1000);
            });
        }

        function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c * 1000;
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        window.initMap = async function() {
            try {
                console.log('üó∫Ô∏è Initializing...');
                const { Map } = await google.maps.importLibrary("maps");
                const { AdvancedMarkerElement, PinElement } = await google.maps.importLibrary("marker");
                
                map = new Map(document.getElementById('map'), {
                    center: { lat: 41.070, lng: -80.685 },
                    zoom: 13,
                    mapId: "DEMO_MAP_ID"
                });
                
                infoWindow = new google.maps.InfoWindow();
                
                parkBoundary = new google.maps.Polygon({
                    paths: [
                        {"lat": 41.102, "lng": -80.67},{"lat": 41.095072, "lng": -80.672607},{"lat": 41.093419, "lng": -80.675198},
                        {"lat": 41.091622, "lng": -80.671987},{"lat": 41.08976, "lng": -80.67354},{"lat": 41.088119, "lng": -80.672038},
                        {"lat": 41.083913, "lng": -80.67535},{"lat": 41.085012, "lng": -80.677529},{"lat": 41.084913, "lng": -80.679398},
                        {"lat": 41.077682, "lng": -80.678787},{"lat": 41.079186, "lng": -80.682468},{"lat": 41.079218, "lng": -80.684756},
                        {"lat": 41.077309, "lng": -80.683926},{"lat": 41.077616, "lng": -80.686772},{"lat": 41.076475, "lng": -80.686393},
                        {"lat": 41.076012, "lng": -80.684153},{"lat": 41.074838, "lng": -80.682685},{"lat": 41.072369, "lng": -80.686795},
                        {"lat": 41.069597, "lng": -80.68604},{"lat": 41.067133, "lng": -80.68168},{"lat": 41.068087, "lng": -80.678131},
                        {"lat": 41.061001, "lng": -80.674619},{"lat": 41.060046, "lng": -80.67312},{"lat": 41.056041, "lng": -80.67486},
                        {"lat": 41.054006, "lng": -80.674099},{"lat": 41.051468, "lng": -80.672903},{"lat": 41.048386, "lng": -80.67488},
                        {"lat": 41.049532, "lng": -80.679731},{"lat": 41.048324, "lng": -80.681126},{"lat": 41.046912, "lng": -80.67676},
                        {"lat": 41.045304, "lng": -80.677715},{"lat": 41.044632, "lng": -80.679016},{"lat": 41.045837, "lng": -80.678922},
                        {"lat": 41.045529, "lng": -80.682447},{"lat": 41.025, "lng": -80.695},{"lat": 41.02487, "lng": -80.701813},
                        {"lat": 41.041995, "lng": -80.700384},{"lat": 41.044828, "lng": -80.696365},{"lat": 41.045653, "lng": -80.68535},
                        {"lat": 41.049213, "lng": -80.685444},{"lat": 41.051996, "lng": -80.680732},{"lat": 41.066192, "lng": -80.679509},
                        {"lat": 41.0663, "lng": -80.688253},{"lat": 41.079284, "lng": -80.69571},{"lat": 41.083752, "lng": -80.681194},
                        {"lat": 41.082363, "lng": -80.696852},{"lat": 41.086197, "lng": -80.699703},{"lat": 41.088308, "lng": -80.695979},
                        {"lat": 41.088442, "lng": -80.688538},{"lat": 41.08843, "lng": -80.683994},{"lat": 41.087905, "lng": -80.683478},
                        {"lat": 41.096479, "lng": -80.678424},{"lat": 41.098469, "lng": -80.681047},{"lat": 41.09839, "lng": -80.681095},
                        {"lat": 41.098452, "lng": -80.681152},{"lat": 41.098448, "lng": -80.681165},{"lat": 41.09851, "lng": -80.681157},
                        {"lat": 41.098476, "lng": -80.681196},{"lat": 41.098232, "lng": -80.680872},{"lat": 41.098434, "lng": -80.681139},
                        {"lat": 41.09847, "lng": -80.681144},{"lat": 41.098488, "lng": -80.681189},{"lat": 41.098303, "lng": -80.681083},
                        {"lat": 41.098372, "lng": -80.680987},{"lat": 41.098342, "lng": -80.681068},{"lat": 41.098392, "lng": -80.680979},
                        {"lat": 41.099193, "lng": -80.679691},{"lat": 41.099593, "lng": -80.679218},{"lat": 41.100828, "lng": -80.677308},
                        {"lat": 41.100867, "lng": -80.677458},{"lat": 41.098289, "lng": -80.680918},{"lat": 41.098396, "lng": -80.680944},
                        {"lat": 41.101378, "lng": -80.676588},{"lat": 41.101709, "lng": -80.671116}
                    ],
                    strokeColor: '#D68438',
                    strokeOpacity: 0.9,
                    strokeWeight: 4,
                    fillColor: '#6B8E6F',
                    fillOpacity: 0.08,
                    map: null
                });
                
                await loadAllMarkers();
                renderCategoryAccordions();
                
                setTimeout(() => {
                    document.getElementById('loadingOverlay').classList.add('hide');
                }, 500);
                
                console.log('‚úÖ Map loaded');
            } catch (error) {
                console.error('‚ùå Init failed:', error);
                document.getElementById('loadingOverlay').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 48px;">‚ö†Ô∏è</div>
                        <h3 style="color: #e74c3c;">Map Failed</h3>
                        <p style="color: #666;">${error.message}</p>
                        <button onclick="location.reload()" style="background: #6B8E6F; color: white; border: none; padding: 12px 30px; border-radius: 25px; font-weight: 700; cursor: pointer;">Retry</button>
                    </div>
                `;
            }
        };

        async function loadAllMarkers() {
            const { AdvancedMarkerElement, PinElement } = await google.maps.importLibrary("marker");
            markers.forEach(m => m.map = null);
            markers = [];
            locations.forEach(loc => {
                const pin = new PinElement({
                    background: categoryColors[loc.category],
                    borderColor: "white",
                    glyph: loc.icon,
                    scale: 1
                });
                const marker = new AdvancedMarkerElement({
                    position: { lat: loc.lat, lng: loc.lng },
                    map: map,
                    title: loc.name,
                    content: pin.element,
                    gmpClickable: true
                });
                marker.addListener('click', () => {
                    openInfoWindowForLocation(marker, loc);
                });
                marker.category = loc.category;
                markers.push(marker);
            });
        }

        function openInfoWindowForLocation(marker, loc) {
            const trailStyle = currentRouteMode === 'trail' ? 'background:#27ae60; color:white; border:3px solid #FFD700;' : 'background:#6B8E6F; color:white;';
            const bikeStyle = currentRouteMode === 'bike' ? 'background:#e67e22; color:white; border:3px solid #FFD700;' : 'background:#D68438; color:white;';
            const trailLabel = currentRouteMode === 'trail' ? '‚≠ê Recommended' : 'Scenic Trail';
            const bikeLabel = currentRouteMode === 'bike' ? '‚≠ê Selected' : 'Bike Route';

            let badgeHTML = '';
            if (loc.tags) {
                badgeHTML = '<div class="vibe-badge-container">';
                loc.tags.forEach(tag => {
                    let badgeClass = 'vibe-badge';
                    if (tag.includes('Restroom')) badgeClass += ' badge-restroom';
                    if (tag.includes('Photo')) badgeClass += ' badge-photo';
                    if (tag.includes('Steep') || tag.includes('Hilly') || tag.includes('Warning')) badgeClass += ' badge-steep';
                    if (tag.includes('Easy') || tag.includes('Flat')) badgeClass += ' badge-flat';
                    if (tag.includes('Family')) badgeClass += ' badge-family';
                    badgeHTML += `<span class="${badgeClass}">${tag}</span>`;
                });
                badgeHTML += '</div>';
            }

            const timeHTML = loc.time ? `<div class="time-stat">üïí ${loc.time}</div>` : '';
            const displayDesc = loc.shortDesc || loc.desc.substring(0, 200) + '...';

            const content = `
                <div style="font-family:'Open Sans',sans-serif; padding:12px; max-width:320px;">
                    <h3 style="color:${categoryColors[loc.category]}; margin-bottom:8px; font-size:1.2rem;">${loc.icon} ${loc.name}</h3>
                    ${badgeHTML}
                    ${timeHTML}
                    <p style="font-size:0.95rem; color:#555; line-height:1.6; margin-bottom:12px;">${displayDesc}</p>
                    <div style="margin-bottom: 8px; text-align: center; font-size: 0.85rem; color: #666; font-weight: 600;">Choose Your Route:</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                        <a href="https://www.google.com/maps/dir/?api=1&destination=${loc.lat},${loc.lng}&travelmode=walking" target="_blank" style="display:block; ${trailStyle} padding:12px 10px; border-radius:8px; text-decoration:none; font-weight:700; font-size:0.85rem; text-align:center;">üö∂<br>${trailLabel}</a>
                        <a href="https://www.google.com/maps/dir/?api=1&destination=${loc.lat},${loc.lng}&travelmode=bicycling" target="_blank" style="display:block; ${bikeStyle} padding:12px 10px; border-radius:8px; text-decoration:none; font-weight:700; font-size:0.85rem; text-align:center;">üö¥<br>${bikeLabel}</a>
                    </div>
                    <div style="margin-bottom: 8px; padding: 10px; background: #ffebee; border: 2px solid #e74c3c; border-radius: 6px; text-align: center;">
                        <strong style="color: #c0392b; font-size: 0.9rem; display: block;">üö´ NEVER USE BEARS DEN ROAD</strong>
                        <span style="color: #721c24; font-size: 0.8rem;">City street with traffic - Use park trails only!</span>
                    </div>
                </div>
            `;
            infoWindow.setContent(content);
            infoWindow.open(map, marker);
        }

        function toggleParkBoundary() {
            boundaryVisible = !boundaryVisible;
            const btn = document.getElementById('boundaryBtn');
            if (boundaryVisible) {
                parkBoundary.setMap(map);
                btn.textContent = '‚úÖ SAFE ZONE VISIBLE';
                btn.style.background = '#27ae60';
            } else {
                parkBoundary.setMap(null);
                btn.textContent = 'üó∫Ô∏è SHOW SAFE RIDING ZONE';
                btn.style.background = 'var(--accent-orange)';
            }
        }

        let modeToastTimer = null;
        let previousMode = null;

        function setRouteMode(mode) {
            if (mode === currentRouteMode) return; // no-op if same mode

            previousMode = currentRouteMode;
            currentRouteMode = mode;

            // 1. Reset "already heard" so nothing gets skipped in the new mode context
            spokenLocations.clear();

            // 2. Keep current waypoint audio playing ‚Äî just update future behavior
            //    (do NOT call stopCurrentAudio or clear the queue)

            // 3. Update button UI
            const trailBtn = document.getElementById('trailModeBtn');
            const bikeBtn = document.getElementById('bikeModeBtn');
            const carBtn = document.getElementById('carModeBtn');
            const modeText = document.getElementById('currentModeText');
            const modeDesc = document.getElementById('modeDescription');

            trailBtn.style.cssText = 'background:white; color:#6B8E6F; border-color:#6B8E6F; font-size:0.85rem; padding:8px 16px;';
            bikeBtn.style.cssText = 'background:white; color:#D68438; border-color:#D68438; font-size:0.85rem; padding:8px 16px;';
            if (carBtn) carBtn.style.cssText = 'background:white; color:#c0392b; border-color:#c0392b; font-size:0.85rem; padding:8px 16px;';

            const modeConfig = {
                trail: { btn: trailBtn, color: '#6B8E6F', label: 'üö∂ Scenic Trail Mode', desc: 'Scenic routes ‚Äî 25m waypoint radius', bg: 'rgba(107,142,111,0.95)', icon: 'üö∂' },
                walk:  { btn: trailBtn, color: '#6B8E6F', label: 'üö∂ Walk Mode',         desc: 'Walking ‚Äî 25m waypoint radius',    bg: 'rgba(107,142,111,0.95)', icon: 'üö∂' },
                bike:  { btn: bikeBtn,  color: '#D68438', label: 'üö¥ Bike Route Mode',   desc: 'Cycling ‚Äî 100m waypoint radius',  bg: 'rgba(214,132,56,0.95)',  icon: 'üö¥' },
                car:   { btn: carBtn,   color: '#c0392b', label: 'üöó Car Mode',          desc: '‚ö†Ô∏è Pull over safely before listening', bg: 'rgba(192,57,43,0.95)', icon: 'üöó' },
            };

            const cfg = modeConfig[mode];
            if (cfg) {
                cfg.btn.style.cssText = `background:${cfg.color}; color:white; border-color:${cfg.color}; font-size:0.85rem; padding:8px 16px;`;
                modeText.style.color = cfg.color;
                modeText.textContent = cfg.label;
                modeDesc.textContent = cfg.desc;
            }

            // 4. Show undo toast with 2-second window
            showModeToast(cfg, previousMode);

            infoWindow.close();
        }

        function showModeToast(cfg, prevMode) {
            // Remove any existing toast
            const existing = document.getElementById('modeToast');
            if (existing) existing.remove();
            if (modeToastTimer) { clearTimeout(modeToastTimer); modeToastTimer = null; }

            const toast = document.createElement('div');
            toast.id = 'modeToast';
            toast.className = 'mode-toast';
            toast.style.background = cfg.bg;
            toast.innerHTML = `
                <span>${cfg.icon} Switched to ${cfg.label.replace(/^[^ ]+ /,'')} ‚Äî waypoints reset</span>
                <button class="undo-btn" onclick="undoModeSwitch()">Undo</button>
            `;
            document.body.appendChild(toast);

            // Auto-dismiss after 4 seconds
            modeToastTimer = setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 400);
                modeToastTimer = null;
            }, 4000);
        }

        function undoModeSwitch() {
            const toast = document.getElementById('modeToast');
            if (toast) toast.remove();
            if (modeToastTimer) { clearTimeout(modeToastTimer); modeToastTimer = null; }
            if (previousMode) setRouteMode(previousMode);
        }

        function renderCategoryAccordions() {
        }

        function renderCategoryAccordions() {
            const container = document.getElementById('categoryContainer');
            container.innerHTML = '';
            categories.forEach(cat => {
                const catLocations = locations.filter(l => l.category === cat.id);
                const count = catLocations.length;
                const item = document.createElement('div');
                item.className = 'category-accordion-item';
                const btn = document.createElement('button');
                btn.className = 'accordion-btn';
                btn.onclick = function() { toggleAccordion(this); };
                btn.innerHTML = `<span>${cat.label} <span class="badge">${count}</span></span><span class="arrow">‚ñº</span>`;
                const content = document.createElement('div');
                content.className = 'accordion-content';
                const innerGrid = document.createElement('div');
                innerGrid.className = 'accordion-inner-grid';
                catLocations.forEach(loc => {
                    const card = document.createElement('div');
                    card.className = 'mini-card';
                    card.onclick = () => { selectLocation(loc.lat, loc.lng, loc.name); };
                    card.innerHTML = `<div class="mini-icon">${loc.icon}</div><div class="mini-info"><div class="mini-name">${loc.name}</div></div>`;
                    innerGrid.appendChild(card);
                });
                content.appendChild(innerGrid);
                item.appendChild(btn);
                item.appendChild(content);
                container.appendChild(item);
            });
        }

        console.log('‚úÖ Ready for map');
    </script>
</body>
</html>
